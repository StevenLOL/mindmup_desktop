var MAPJS=MAPJS||{},observable=function(a){"use strict";var b=[];return a.addEventListener=function(a,c,d){a.split(" ").forEach(function(a){a&&b.push({type:a,listener:c,priority:d||0})})},a.listeners=function(a){return b.filter(function(b){return b.type===a}).map(function(a){return a.listener})},a.removeEventListener=function(a,c){b=b.filter(function(a){return a.listener!==c})},a.dispatchEvent=function(a){var c=Array.prototype.slice.call(arguments,1);b.filter(function(b){return b.type===a}).sort(function(a,b){return b.priority-a.priority}).some(function(a){try{return a.listener.apply(void 0,c)===!1}catch(b){console.log("dispatchEvent failed",b,a)}})},a};MAPJS.URLHelper={urlPattern:/(https?:\/\/|www\.)[\w-]+(\.[\w-]+)+([\w.,!@?^=%&amp;:\/~+#-]*[\w!@?^=%&amp;\/~+#-])?/i,containsLink:function(a){"use strict";return MAPJS.URLHelper.urlPattern.test(a)},getLink:function(a){"use strict";var b=a.match(MAPJS.URLHelper.urlPattern);return b&&b[0]&&(b=b[0],/https?:\/\//i.test(b)||(b="http://"+b)),b},stripLink:function(a){"use strict";return a.replace(MAPJS.URLHelper.urlPattern,"")}},MAPJS.content=function(a,b){"use strict";var c,d=function(){c=void 0},e=function B(b){return b=b||a,b.ideas?_.reduce(b.ideas,function(a,b){return Math.max(a,B(b))},parseInt(b.id,10)||0):parseInt(b.id,10)||0},f=function(a){return a=a||b,c||(c=e()),c+=1,a?c+"."+a:c},g=function(a,b){return a.id?d():a.id=f(b),a.ideas&&_.each(a.ideas,function(c,d){a.ideas[parseFloat(d)]=g(c,b)}),a.title||(a.title=""),a.containsDirectChild=a.findChildRankById=function(b){return parseFloat(_.reduce(a.ideas,function(a,c,d){return c.id==b?d:a},void 0))},a.findSubIdeaById=function(b){var c=_.find(a.ideas,function(a){return a.id==b});return c||_.reduce(a.ideas,function(a,c){return a||c.findSubIdeaById(b)},void 0)},a.find=function(b){var c=b(a)?[_.pick(a,"id","title")]:[];return 0===_.size(a.ideas)?c:_.reduce(a.ideas,function(a,c){return _.union(a,c.find(b))},c)},a.getAttr=function(b){return a.attr&&a.attr[b]?_.clone(a.attr[b]):!1},a.sortedSubIdeas=function(){if(!a.ideas)return[];var b=[],c=_.groupBy(_.map(_.keys(a.ideas),parseFloat),function(a){return a>0}),d=_.sortBy(c[!0],Math.abs).concat(_.sortBy(c[!1],Math.abs));return _.each(d,function(c){b.push(a.ideas[c])}),b},a.traverse=function(b,c){c||b(a),_.each(a.sortedSubIdeas(),function(a){a.traverse(b,c)}),c&&b(a)},a},h=function(a,b){if(b=b||1,0===_.size(a))return 0;var c=_.keys(a);return c.push(0),_.max(_.map(c,parseFloat),function(a){return a*b})},i=function(b){var c,d,e=1;return b.id==a.id&&(d=_.countBy(b.ideas,function(a,b){return 0>b}),(d["true"]||0)<d["false"]&&(e=-1)),c=h(b.ideas,e)+e},j=function(a,b){var c;return a.ideas=a.ideas||{},c=i(a),a.ideas[c]=b,c},k=function(b){return a.id==b?a:a.findSubIdeaById(b)},l=function(a,b){return _(_.map(_.keys(a.ideas),parseFloat)).reject(function(a){return 0>a*b})},m=function(a){return 0>a?-1:1},n={},o={},p=!1,q={},r=function(b,c,d){d?a.dispatchEvent("changed",b,c,d):a.dispatchEvent("changed",b,c)},s=function(b,c,d,e){var f;return"batch"!==b&&!q[e]&&n&&n[e]&&0!==n[e].length?(f=n[e].pop(),n[e].push("batch"===f.eventMethod?{eventMethod:"batch",eventArgs:f.eventArgs.concat([[b].concat(c)]),undoFunction:function(){d(),f.undoFunction()}}:{eventMethod:"batch",eventArgs:[[f.eventMethod].concat(f.eventArgs)].concat([[b].concat(c)]),undoFunction:function(){d(),f.undoFunction()}}),void(p?a.dispatchEvent("changed","redo",void 0,e):(r(b,c,e),o[e]=[]))):void t(b,c,d,e)},t=function(b,c,d,e){var f={eventMethod:b,eventArgs:c,undoFunction:d};return q[e]?void q[e].push(f):(n[e]||(n[e]=[]),n[e].push(f),void(p?a.dispatchEvent("changed","redo",void 0,e):(r(b,c,e),o[e]=[])))},u=function(a,b,c){a.ideas[b]=a.ideas[c],delete a.ideas[c]},v=function(a){if(a.style){a.attr={};var b=a.style.collapsed;delete a.style.collapsed,a.attr.style=a.style,b&&(a.attr.collapsed=b),delete a.style}a.ideas&&_.each(a.ideas,v)},w=function(a){var b=String(a).indexOf(".");return b>0&&a.substr(b+1)},x={},y={},z="/xxxxxxxx-yxxx-yxxx-yxxx-xxxxxxxxxxxx/".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"===a?b:3&b|8;return c.toString(16)})+(b||""),A=function(a,b,c){var d;if(!a)return!1;if(d=_.extend({},a.attr),a.attr=_.extend({},a.attr),!c||"false"===c||_.isObject(c)&&_.isEmpty(c)){if(!a.attr[b])return!1;delete a.attr[b]}else{if(_.isEqual(a.attr[b],c))return!1;a.attr[b]=JSON.parse(JSON.stringify(c))}return 0===_.size(a.attr)&&delete a.attr,function(){a.attr=d}};return a.setConfiguration=function(a){y=a||{}},a.getSessionKey=function(){return b},a.nextSiblingId=function(b){var c,d,e,f=a.findParent(b);return f?(c=f.findChildRankById(b),d=l(f,c),e=_.reject(d,function(a){return Math.abs(a)<=Math.abs(c)}),0===e.length?!1:f.ideas[_.min(e,Math.abs)].id):!1},a.sameSideSiblingIds=function(b){var c=a.findParent(b),d=c.findChildRankById(b);return _.without(_.map(_.pick(c.ideas,l(c,d)),function(a){return a.id}),b)},a.getAttrById=function(a,b){var c=k(a);return c&&c.getAttr(b)},a.previousSiblingId=function(b){var c,d,e,f=a.findParent(b);return f?(c=f.findChildRankById(b),d=l(f,c),e=_.reject(d,function(a){return Math.abs(a)>=Math.abs(c)}),0===e.length?!1:f.ideas[_.max(e,Math.abs)].id):!1},a.clone=function(b){var c=b&&b!=a.id&&a.findSubIdeaById(b)||a;return JSON.parse(JSON.stringify(c))},a.cloneMultiple=function(b){return _.map(b,a.clone)},a.calculatePath=function(b,c,d){return a.id==b?[]:(c=c||[a],d=d||a,d.containsDirectChild(b)?c:_.reduce(d.ideas,function(d,e){return d||a.calculatePath(b,[e].concat(c),e)},!1))},a.getSubTreeIds=function(b){var c=[],d=function(a){return _.isEmpty(a.ideas)?[]:void _.each(a.sortedSubIdeas(),function(a){d(a),c.push(a.id)})};return d(a.findSubIdeaById(b)||a),c},a.findParent=function(b,c){return c=c||a,c.containsDirectChild(b)?c:_.reduce(c.ideas,function(c,d){return c||a.findParent(b,d)},!1)},a.startBatch=function(c){var d=c||b;a.endBatch(c),q[d]=[]},a.endBatch=function(a){var c,d,e,f=a||b,g=q[f];q[f]=void 0,_.isEmpty(g)||(1===_.size(g)?t(g[0].eventMethod,g[0].eventArgs,g[0].undoFunction,f):(c=_.map(g,function(a){return[a.eventMethod].concat(a.eventArgs)}),d=_.sortBy(_.map(g,function(a){return a.undoFunction}),function(a,b){return-1*b}),e=function(){_.each(d,function(a){a()})},t("batch",c,e,f)))},a.execCommand=function(c,d,e){return x[c]?x[c].apply(a,[e||b].concat(_.toArray(d))):!1},a.batch=function(b){a.startBatch();try{b()}finally{a.endBatch()}},x.batch=function(b){a.startBatch(b);try{_.each(_.toArray(arguments).slice(1),function(c){a.execCommand(c[0],c.slice(1),b)})}finally{a.endBatch(b)}},a.pasteMultiple=function(b,c){a.startBatch();var d=_.map(c,function(c){return a.paste(b,c)});return a.endBatch(),d},a.paste=function(){return a.execCommand("paste",arguments)},x.paste=function(b,e,f,h){var i,k,l=e==a.id?a:a.findSubIdeaById(e),m=function(a){var b,c,d=_.omit(a,"ideas","id","attr"),e=1;return d.attr=_.omit(a.attr,y.nonClonedAttributes),_.isEmpty(d.attr)&&delete d.attr,a.ideas&&(b=_.groupBy(_.map(_.keys(a.ideas),parseFloat),function(a){return a>0}),c=_.sortBy(b[!0],Math.abs).concat(_.sortBy(b[!1],Math.abs)),d.ideas={},_.each(c,function(b){d.ideas[e++]=m(a.ideas[b])})),d};return h&&(c=parseInt(h,10)-1),i=f&&(f.title||f.attr)&&g(m(f),w(h)),l&&i?(k=j(l,i),h&&d(),A(i,"position"),t("paste",[e,f,i.id],function(){delete l.ideas[k]},b),i.id):!1},a.flip=function(){return a.execCommand("flip",arguments)},x.flip=function(b,c){var d,e,f=a.findChildRankById(c);return f?(e=h(a.ideas,-1*m(f)),d=e-10*m(f),u(a,d,f),t("flip",[c],function(){u(a,f,d)},b),!0):!1},a.initialiseTitle=function(){return a.execCommand("initialiseTitle",arguments)},x.initialiseTitle=function(a,b,c){var d,e=k(b);return e?(d=e.title,d==c?!1:(e.title=c,s("initialiseTitle",[b,c],function(){e.title=d},a),!0)):!1},a.updateTitle=function(){return a.execCommand("updateTitle",arguments)},x.updateTitle=function(a,b,c){var d,e=k(b);return e?(d=e.title,d==c?!1:(e.title=c,t("updateTitle",[b,c],function(){e.title=d},a),!0)):!1},a.addSubIdea=function(){return a.execCommand("addSubIdea",arguments)},x.addSubIdea=function(a,b,c,d){var e,f,h=k(b);return h?d&&k(d)?!1:(e=g({title:c,id:d}),f=j(h,e),t("addSubIdea",[b,c,e.id],function(){delete h.ideas[f]},a),e.id):!1},a.removeMultiple=function(b){a.startBatch();var c=_.map(b,a.removeSubIdea);return a.endBatch(),c},a.removeSubIdea=function(){return a.execCommand("removeSubIdea",arguments)},x.removeSubIdea=function(b,c){var d,e,f,g=a.findParent(c);return g?(d=g.findChildRankById(c),e=g.ideas[d],delete g.ideas[d],f=a.links,a.links=_.reject(a.links,function(a){return a.ideaIdFrom==c||a.ideaIdTo==c}),t("removeSubIdea",[c],function(){g.ideas[d]=e,a.links=f},b),!0):!1},a.insertIntermediateMultiple=function(b){a.startBatch();var c=a.insertIntermediate(b[0]);return _.each(b.slice(1),function(b){a.changeParent(b,c)}),a.endBatch(),c},a.insertIntermediate=function(){return a.execCommand("insertIntermediate",arguments)},x.insertIntermediate=function(b,c,d,e){if(a.id==c)return!1;var f,h,i,j=a.findParent(c);return j?e&&k(e)?!1:(f=j.findChildRankById(c))?(h=j.ideas[f],i=g({title:d,id:e}),j.ideas[f]=i,i.ideas={1:h},t("insertIntermediate",[c,d,i.id],function(){j.ideas[f]=h},b),i.id):!1:!1},a.changeParent=function(){return a.execCommand("changeParent",arguments)},x.changeParent=function(b,c,d){var e,f,g,h,i,l=k(d);return c==d?!1:l?(h=a.findSubIdeaById(c))?h.findSubIdeaById(d)?!1:l.containsDirectChild(c)?!1:(e=a.findParent(c))?(f=e.findChildRankById(c),g=j(l,h),i=h.getAttr("position"),A(h,"position"),delete e.ideas[f],t("changeParent",[c,d],function(){A(h,"position",i),e.ideas[f]=h,delete l.ideas[g]},b),!0):!1:!1:!1},a.mergeAttrProperty=function(b,c,d,e){var f=a.getAttrById(b,c)||{};return e?f[d]=e:delete f[d],_.isEmpty(f)&&(f=!1),a.updateAttr(b,c,f)},a.updateAttr=function(){return a.execCommand("updateAttr",arguments)},x.updateAttr=function(a,b,c,d){var e,f=k(b);return e=A(f,c,d),e&&t("updateAttr",[b,c,d],e,a),!!e},a.moveRelative=function(b,c){var d=a.findParent(b),e=d&&d.findChildRankById(b),f=e&&_.sortBy(l(d,e),Math.abs),g=f&&f.indexOf(e),h=g+(c>0?c+1:c),i=h>=0&&d&&f&&d.ideas[f[h]];return 0>h||!d?!1:a.positionBefore(b,i&&i.id,d)},a.positionBefore=function(){return a.execCommand("positionBefore",arguments)},x.positionBefore=function(b,c,d,e){e=e||a;var f,g,i,j,k,m,n;if(n=e.findChildRankById(c),!n)return _.reduce(e.ideas,function(a,e){return a||x.positionBefore(b,c,d,e)},!1);if(c==d)return!1;if(f=0,d){if(g=e.findChildRankById(d),!g)return!1;if(i=l(e,n),j=_.reject(_.sortBy(i,Math.abs),function(a){return Math.abs(a)>=Math.abs(g)}),k=j.length>0?_.max(j,Math.abs):0,k==n)return!1;f=k+(g-k)/2}else{if(m=h(e.ideas,0>n?-1:1),m==n)return!1;f=m+10*(0>n?-1:1)}return f==n?!1:(u(e,f,n),t("positionBefore",[c,d],function(){u(e,n,f)},b),!0)},observable(a),function(){var b=function(a,b){var c,d,e;return a===b?!1:(d=k(a))?(e=k(b))?(c=_.find(d.ideas,function(a){return a.id===b})||_.find(e.ideas,function(b){return b.id===a}),c?!1:!0):!1:!1};a.addLink=function(){return a.execCommand("addLink",arguments)},x.addLink=function(c,d,e){var f,g;return b(d,e)?(f=_.find(a.links,function(a){return a.ideaIdFrom===d&&a.ideaIdTo===e||a.ideaIdFrom===e&&a.ideaIdTo===d}))?!1:(a.links=a.links||[],g={ideaIdFrom:d,ideaIdTo:e,attr:{style:{color:"#FF0000",lineStyle:"dashed"}}},a.links.push(g),t("addLink",[d,e],function(){a.links.pop()},c),!0):!1},a.removeLink=function(){return a.execCommand("removeLink",arguments)},x.removeLink=function(b,c,d){for(var e,f=0;a.links&&f<a.links.length;){if(e=a.links[f],String(e.ideaIdFrom)===String(c)&&String(e.ideaIdTo)===String(d))return a.links.splice(f,1),t("removeLink",[c,d],function(){a.links.push(_.clone(e))},b),!0;f+=1}return!1},a.getLinkAttr=function(b,c,d){var e=_.find(a.links,function(a){return a.ideaIdFrom==b&&a.ideaIdTo==c});return e&&e.attr&&e.attr[d]?e.attr[d]:!1},a.updateLinkAttr=function(){return a.execCommand("updateLinkAttr",arguments)},x.updateLinkAttr=function(b,c,d,e,f){var g,h=_.find(a.links,function(a){return a.ideaIdFrom==c&&a.ideaIdTo==d});return g=A(h,e,f),g&&t("updateLinkAttr",[c,d,e,f],g,b),!!g}}(),a.undo=function(){return a.execCommand("undo",arguments)},x.undo=function(b){a.endBatch();var c;return c=n[b]&&n[b].pop(),c&&c.undoFunction?(c.undoFunction(),o[b]||(o[b]=[]),o[b].push(c),a.dispatchEvent("changed","undo",[],b),!0):!1},a.redo=function(){return a.execCommand("redo",arguments)},x.redo=function(b){a.endBatch();var c;return c=o[b]&&o[b].pop(),c?(p=!0,a.execCommand(c.eventMethod,c.eventArgs,b),p=!1,!0):!1},a.storeResource=function(){return a.execCommand("storeResource",arguments)},x.storeResource=function(c,d,e){var f,g,h=function(){if(_.isEmpty(a.resources))return 0;var c=function(a){return parseInt(a,10)},d=_.keys(a.resources),e=b?_.filter(d,RegExp.prototype.test.bind(new RegExp("\\/"+b+"$"))):d,f=_.map(e,c);return _.isEmpty(f)?0:_.max(f)},i=function(){var a=h()+1;return a+z};return!e&&a.resources&&(f=_.find(_.keys(a.resources),function(b){return a.resources[b]===d}))?f:(g=e||i(),a.resources=a.resources||{},a.resources[g]=d,a.dispatchEvent("resourceStored",d,g,c),g)},a.getResource=function(b){return a.resources&&a.resources[b]},a.hasSiblings=function(b){if(b===a.id)return!1;var c=a.findParent(b);return c&&_.size(c.ideas)>1},2!=a.formatVersion&&(v(a),a.formatVersion=2),g(a),a},MAPJS.defaultStyles={},MAPJS.layoutLinks=function(a,b){"use strict";var c={};return _.each(a.links,function(a){b[a.ideaIdFrom]&&b[a.ideaIdTo]&&(c[a.ideaIdFrom+"_"+a.ideaIdTo]={ideaIdFrom:a.ideaIdFrom,ideaIdTo:a.ideaIdTo,attr:_.clone(a.attr)})}),c},MAPJS.calculateFrame=function(a,b){"use strict";b=b||0;var c={top:_.min(a,function(a){return a.y}).y-b,left:_.min(a,function(a){return a.x}).x-b};return c.width=b+_.max(_.map(a,function(a){return a.x+a.width}))-c.left,c.height=b+_.max(_.map(a,function(a){return a.y+a.height}))-c.top,c},MAPJS.contrastForeground=function(a){"use strict";var b=Color(a).luminosity();return.5>b?"#EEEEEE":.9>b?"#4F4F4F":"#000000"},MAPJS.Outline=function(a,b){"use strict";var c=function(a,b){return _.map(a,function(a){return{l:a.l,h:a.h+b}})};this.initialHeight=function(){return this.bottom[0].h-this.top[0].h},this.borders=function(){return _.pick(this,"top","bottom")},this.spacingAbove=function(a){for(var b=0,c=0,d=0,e=0,f=0;b<this.bottom.length&&c<a.top.length;)d=Math.max(d,this.bottom[b].h-a.top[c].h),e+this.bottom[b].l<f+a.top[c].l?(e+=this.bottom[b].l,b+=1):e+this.bottom[b].l===f+a.top[c].l?(e+=this.bottom[b].l,b+=1,f+=a.top[c].l,c+=1):(f+=a.top[c].l,c+=1);return d},this.indent=function(a,b){if(!a)return this;var c=this.top.slice(),d=this.bottom.slice(),e=(d[0].h+c[0].h)/2;return c.unshift({h:e-b/2,l:a}),d.unshift({h:e+b/2,l:a}),new MAPJS.Outline(c,d)},this.stackBelow=function(a,b){var d=a.spacingAbove(this),e=MAPJS.Outline.extendBorder(a.top,c(this.top,d+b)),f=MAPJS.Outline.extendBorder(c(this.bottom,d+b),a.bottom);return new MAPJS.Outline(e,f)},this.expand=function(a,b){var d=a-this.top[0].h,e=b-this.bottom[0].h,f=c(this.top,d),g=c(this.bottom,e);return new MAPJS.Outline(f,g)},this.insertAtStart=function(a,b){var d=0,e=c(this.top,d),f=c(this.bottom,d),g=function(a){a[0].l*=.5,a[1].l+=a[0].l};return e[0].l+=b,f[0].l+=b,e.unshift({h:-.5*a.height,l:a.width}),f.unshift({h:.5*a.height,l:a.width}),e[0].h>e[1].h&&g(e),f[0].h<f[1].h&&g(f),new MAPJS.Outline(e,f)},this.top=a.slice(),this.bottom=b.slice()},MAPJS.Outline.borderLength=function(a){"use strict";return _.reduce(a,function(a,b){return a+b.l},0)},MAPJS.Outline.borderSegmentIndexAt=function(a,b){"use strict";for(var c=0,d=-1;b>=c;){if(d+=1,d>=a.length)return-1;c+=a[d].l}return d},MAPJS.Outline.extendBorder=function(a,b){"use strict";var c,d=a.slice(),e=MAPJS.Outline.borderLength(a),f=MAPJS.Outline.borderSegmentIndexAt(b,e);return f>=0&&(c=MAPJS.Outline.borderLength(b.slice(0,f+1)),d.push({h:b[f].h,l:c-e}),d=d.concat(b.slice(f+1))),d},MAPJS.Tree=function(a){"use strict";_.extend(this,a),this.toLayout=function(a,b,c){a=a||0,b=b||0;var d,e={nodes:{},connectors:{}};return d=_.pick(this,"id","title","attr","width","height","level"),1===d.level?(d.x=-.5*this.width,d.y=-.5*this.height):(d.x=a+this.deltaX||0,d.y=b+this.deltaY||0),e.nodes[this.id]=d,void 0!==c&&(e.connectors[d.id]={from:c,to:d.id}),this.subtrees&&this.subtrees.forEach(function(a){var b=a.toLayout(d.x,d.y,d.id);_.extend(e.nodes,b.nodes),_.extend(e.connectors,b.connectors)}),e}},MAPJS.Outline.fromDimensions=function(a){"use strict";return new MAPJS.Outline([{h:-.5*a.height,l:a.width}],[{h:.5*a.height,l:a.width}])},MAPJS.calculateTree=function(a,b,c,d,e){"use strict";var f={id:a.id,title:a.title,attr:a.attr,deltaY:0,deltaX:0,level:e||1},g=function(a,b){var c,d,e,f,g,h,i=_.map(a,function(a){return _.pick(a,"deltaX","deltaY")});for(c=0;c<a.length;c+=1)d=a[c],d.attr&&d.attr.position?(d.deltaY=d.attr.position[1],(void 0===g||d.attr.position[2]>a[g].attr.position[2])&&(g=c)):d.deltaY+=b,c>0&&(e=i[c].deltaY-i[c-1].deltaY,f=a[c].deltaY-a[c-1].deltaY,e>f&&(d.deltaY+=e-f));if(h=g&&a[g].attr.position[1]-a[g].deltaY)for(c=0;c<a.length;c+=1)a[c].deltaY+=h},h=function(){return!(_.isEmpty(a.ideas)||a.attr&&a.attr.collapsed)},i=function(){var b=_.map(_.keys(a.ideas),parseFloat),c=d?_.filter(b,function(b){return d(b,a.id)}):b;return _.sortBy(c,Math.abs)},j=function(){var b=[];return _.each(i(),function(c){b.push(a.ideas[c])}),b},k=b(a,f.level),l=function(a){var b,d,e,h,i;_.each(a,function(a){a.deltaX=k.width+c,e=a.attr&&a.attr.position&&a.attr.position[0],e&&e>a.deltaX?(h=e-a.deltaX,a.deltaX=e):h=0,b?(i=a.outline.indent(h,c),d=i.initialHeight(),b=i.stackBelow(b,c),a.deltaY=b.initialHeight()-d/2-a.height/2):b=a.outline.indent(h,c)}),a&&a.length&&(g(a,.5*(k.height-b.initialHeight())),b=b.expand(a[0].deltaY-.5*k.height,a[a.length-1].deltaY+a[a.length-1].height-.5*k.height)),f.outline=b.insertAtStart(k,c)};return _.extend(f,k),f.outline=new MAPJS.Outline.fromDimensions(k),h()&&(f.subtrees=_.map(j(),function(a){return MAPJS.calculateTree(a,b,c,d,f.level+1)}),_.isEmpty(f.subtrees)||l(f.subtrees)),new MAPJS.Tree(f)},MAPJS.calculateLayout=function(a,b,c){"use strict";var d,e,f,g,h=function(a){_.each(a,function(a){a.attr=a.attr||{},a.attr.style=_.extend({},MAPJS.defaultStyles[1===a.level?"root":"nonRoot"],a.attr.style)})},i=function(b,c){return c!==a.id||b>0},j=function(b,c){return c!==a.id||0>b};return c=c||20,d=MAPJS.calculateTree(a,b,c,i),e=MAPJS.calculateTree(a,b,c,j),f=d.toLayout(),g=e.toLayout(),_.each(g.nodes,function(a){a.x=-1*a.x-a.width}),_.extend(g.nodes,f.nodes),_.extend(g.connectors,f.connectors),h(g.nodes),g.links=MAPJS.layoutLinks(a,g.nodes),g.rootNodeId=a.id,g},MAPJS.MemoryClipboard=function(){"use strict";var a,b=this,c=function(a){return a?JSON.parse(JSON.stringify(a)):void 0};b.get=function(){return c(a)},b.put=function(b){a=c(b)}},function(){"use strict";$.fn.simpleDraggableContainer=function(){var a,b,c=this,d=function(c){if(a&&c.gesture){var d={top:Math.round(parseInt(b.top,10)+c.gesture.deltaY),left:Math.round(parseInt(b.left,10)+c.gesture.deltaX)};return a.css(d).trigger($.Event("mm:drag",{currentPosition:d,gesture:c.gesture})),c.gesture&&c.gesture.preventDefault(),!1}},e=function(c){var d=a;"shadow"!==d.attr("mapjs-drag-role")?d.animate(b,{complete:function(){d.trigger($.Event("mm:cancel-dragging",{gesture:c.gesture}))},progress:function(){d.trigger("mm:drag")}}):d.trigger($.Event("mm:cancel-dragging",{gesture:c.gesture}))};return Hammer(this,{drag_min_distance:2}),this.on("mm:start-dragging",function(c){a||(a=$(c.relatedTarget),b={top:a.css("top"),left:a.css("left")},$(this).on("drag",d))}).on("mm:start-dragging-shadow",function(e){var f=$(e.relatedTarget),g=function(){var a=f.clone().addClass("drag-shadow").appendTo(c).offset(f.offset()).data(f.data()).attr("mapjs-drag-role","shadow"),b=f.parent().data("scale")||1;return 0!==b&&a.css({transform:"scale("+b+")","transform-origin":"top left"}),a};a||(a=g(),b={top:a.css("top"),left:a.css("left")},a.on("mm:stop-dragging mm:cancel-dragging",function(a){this.remove(),a.stopPropagation(),a.stopImmediatePropagation();var b=$.Event(a.type,{gesture:a.gesture,finalPosition:a.finalPosition});f.trigger(b)}).on("mm:drag",function(a){f.trigger(a)}),$(this).on("drag",d))}).on("dragend",function(b){if($(this).off("drag",d),a){var c=$.Event("mm:stop-dragging",{gesture:b.gesture,finalPosition:a.offset()});a.trigger(c),c.result===!1&&e(b),a=void 0}}).on("mouseleave",function(b){a&&($(this).off("drag",d),e(b),a=void 0)}).attr("data-drag-role","container")};var a=function(a){$(this).trigger($.Event("mm:start-dragging",{relatedTarget:this,gesture:a.gesture})),a.stopPropagation(),a.preventDefault(),a.gesture&&(a.gesture.stopPropagation(),a.gesture.preventDefault())},b=function(a){$(this).trigger($.Event("mm:start-dragging-shadow",{relatedTarget:this,gesture:a.gesture})),a.stopPropagation(),a.preventDefault(),a.gesture&&(a.gesture.stopPropagation(),a.gesture.preventDefault())};$.fn.simpleDraggable=function(b){return b&&b.disable?$(this).off("dragstart",a):$(this).on("dragstart",a)},$.fn.shadowDraggable=function(a){return a&&a.disable?$(this).off("dragstart",b):$(this).on("dragstart",b)}}(),MAPJS.MapModel=function(a,b,c,d){"use strict";var e,f,g,h,i,j,k,l=this,m=a,n=d||20,o=c||new MAPJS.MemoryClipboard,p={nodes:{},connectors:{}},q=!0,r=!0,s=[],t=function(a){var b=_.clone(s);s=0===a.length?[h]:a,l.dispatchEvent("activatedNodesChanged",_.difference(s,b),_.difference(b,s))},u=300,v=function(a){if(g){var b=g(f);_.each(a.nodes,function(a,c){(b[c]||0===b[c])&&(a.label=b[c])})}},w=function(a,b){l.dispatchEvent("layoutChangeStarting",_.size(a.nodes)-_.size(p.nodes)),v(a),_.each(p.connectors,function(b,c){var d=a.connectors[c];d&&d.from===b.from&&d.to===b.to||l.dispatchEvent("connectorRemoved",b)}),_.each(p.links,function(b,c){var d=a.links&&a.links[c];d||l.dispatchEvent("linkRemoved",b)}),_.each(p.nodes,function(c,d){var e,g=a.nodes[d];g||(d==h&&l.selectNode(f.id),e=_.reject(s,function(a){return a==d}),e.length!==s.length&&t(e),l.dispatchEvent("nodeRemoved",c,d,b))}),_.each(a.nodes,function(a,c){var d=p.nodes[c];d?((a.x!==d.x||a.y!==d.y)&&l.dispatchEvent("nodeMoved",a,b),a.title!==d.title&&l.dispatchEvent("nodeTitleChanged",a,b),_.isEqual(a.attr||{},d.attr||{})||l.dispatchEvent("nodeAttrChanged",a,b),a.label!==d.label&&l.dispatchEvent("nodeLabelChanged",a,b)):l.dispatchEvent("nodeCreated",a,b)}),_.each(a.connectors,function(a,c){var d=p.connectors[c];d&&a.from===d.from&&a.to===d.to||l.dispatchEvent("connectorCreated",a,b)}),_.each(a.links,function(a,c){var d=p.links&&p.links[c];d?_.isEqual(a.attr||{},d&&d.attr||{})||l.dispatchEvent("linkAttrChanged",a,b):l.dispatchEvent("linkCreated",a,b)}),p=a,l.isInCollapse||l.dispatchEvent("layoutChangeComplete")},x=function(a){j=h,k=s.slice(0),l.selectNode(a)},y=function(a){x(a),l.editNode(!1,!0,!0)},z=function(){return h||f.id},A=!1,B=function(a,b,c){A||(j=!1,k=!1,l.rebuildRequired(c))},C=function(){return f.findSubIdeaById(h)||f},D=function(a,b){var c=f.findSubIdeaById(b)||f;c.getAttr("collapsed")&&f.updateAttr(b,"collapsed",!1)};observable(this),e=l.dispatchEvent.bind(l,"analytic","mapModel"),l.pause=function(){A=!0},l.resume=function(){A=!1,l.rebuildRequired()},l.getIdea=function(){return f},l.isEditingEnabled=function(){return r},l.getCurrentLayout=function(){return p},l.analytic=e,l.getCurrentlySelectedIdeaId=z,l.rebuildRequired=function(a){f&&w(l.reactivate(m(f)),a)},this.setIdea=function(a){f&&(f.removeEventListener("changed",B),A=!1,t([]),l.dispatchEvent("nodeSelectionChanged",h,!1),h=void 0),f=a,f.addEventListener("changed",B),B(),l.selectNode(f.id,!0),l.dispatchEvent("mapViewResetRequested")},this.setEditingEnabled=function(a){r=a},this.getEditingEnabled=function(){return r},this.setInputEnabled=function(a,b){q!==a&&(q=a,l.dispatchEvent("inputEnabledChanged",a,!!b))},this.getInputEnabled=function(){return q},this.selectNode=function(a,b,c){(b||q&&(a!==h||!l.isActivated(a)))&&(h&&l.dispatchEvent("nodeSelectionChanged",h,!1),h=a,c?l.activateNode("internal",a):t([a]),l.dispatchEvent("nodeSelectionChanged",a,!0))},this.clickNode=function(a,b){var c=b&&b.button&&-1!==b.button;b&&b.altKey?l.addLink("mouse",a):b&&b.shiftKey?l.toggleActivationOnNode("mouse",a):i&&!c?(this.addLink("mouse",a),this.toggleAddLinkMode()):(this.selectNode(a),c&&-1!==c&&q&&l.dispatchEvent("contextMenuRequested",a,b.layerX,b.layerY))},this.findIdeaById=function(a){return f.id==a?f:f.findSubIdeaById(a)},this.getSelectedStyle=function(a){return this.getStyleForId(h,a)},this.getStyleForId=function(a,b){var c=p.nodes&&p.nodes[a];return c&&c.attr&&c.attr.style&&c.attr.style[b]},this.toggleCollapse=function(a){var b,c=C();b=l.isActivated(c.id)&&_.size(c.ideas)>0?c.getAttr("collapsed"):l.everyActivatedIs(function(a){var b=l.findIdeaById(a);return b&&_.size(b.ideas)>0?b.getAttr("collapsed"):!0}),this.collapse(a,!b)},this.collapse=function(a,b){e("collapse:"+b,a),l.isInCollapse=!0;var c,d,g=z(),h=function(){return g&&p&&p.nodes&&p.nodes[g]},i=function(a,b,c){(b||c)&&_.each(a,function(a){a.x+=b,a.y+=c,l.dispatchEvent("nodeMoved",a,"scroll")})};c=h(),q&&l.applyToActivated(function(a){var c=l.findIdeaById(a);c&&(!b||c.ideas&&_.size(c.ideas)>0)&&f.updateAttr(a,"collapsed",b)}),d=h(),c&&d&&i(p.nodes,c.x-d.x,c.y-d.y),l.isInCollapse=!1,l.dispatchEvent("layoutChangeComplete")},this.updateStyle=function(a,b,c){return r?void(q&&(e("updateStyle:"+b,a),l.applyToActivated(function(a){l.getStyleForId(a,b)!=c&&f.mergeAttrProperty(a,"style",b,c)}))):!1},this.updateLinkStyle=function(a,b,c,d,g){if(!r)return!1;if(q){e("updateLinkStyle:"+d,a);var h=_.extend({},f.getLinkAttr(b,c,"style"));h[d]=g,f.updateLinkAttr(b,c,"style",h)}},this.addSubIdea=function(a,b,c){if(!r)return!1;var d,g=b||h;e("addSubIdea",a),q&&(f.batch(function(){D(a,g),d=c?f.addSubIdea(g,c):f.addSubIdea(g)}),d&&(c?x(d):y(d)))},this.insertIntermediate=function(a){if(!r)return!1;if(!q||h===f.id)return!1;var b,c=[];e("insertIntermediate",a),l.applyToActivated(function(a){c.push(a)}),b=f.insertIntermediateMultiple(c),b&&y(b)},this.flip=function(a){if(!r)return!1;if(e("flip",a),!q||h===f.id)return!1;var b=p.nodes[h];return b&&2===b.level?f.flip(h):!1},this.addSiblingIdeaBefore=function(a){var b,c,d,g;return r?(e("addSiblingIdeaBefore",a),q?(c=f.findParent(h)||f,f.batch(function(){D(a,c.id),b=f.addSubIdea(c.id),b&&h!==f.id&&(d=c.findChildRankById(h),g=c.findChildRankById(b),0>d*g&&f.flip(b),f.positionBefore(b,h))}),void(b&&y(b))):!1):!1},this.addSiblingIdea=function(a,b,c){var d,g,i,j,k,l;return l=b||h,r?(e("addSiblingIdea",a),void(q&&(i=f.findParent(l)||f,f.batch(function(){D(a,i.id),d=c?f.addSubIdea(i.id,c):f.addSubIdea(i.id),d&&l!==f.id&&(g=f.nextSiblingId(l),j=i.findChildRankById(l),k=i.findChildRankById(d),0>j*k&&f.flip(d),g&&f.positionBefore(d,g))}),d&&(c?x(d):y(d))))):!1},this.removeSubIdea=function(a){if(!r)return!1;e("removeSubIdea",a);var b;return q&&l.applyToActivated(function(a){var c;h==a&&(c=f.findParent(h),c&&l.selectNode(c.id)),b=f.removeSubIdea(a)}),b},this.updateTitle=function(a,b,c){c?f.initialiseTitle(a,b):f.updateTitle(a,b)},this.editNode=function(a,c,d){if(!r)return!1;if(a&&e("editNode",a),!q)return!1;var f=C().title;_.include(b,f)&&(c=!0),l.dispatchEvent("nodeEditRequested",h,c,!!d)},this.editIcon=function(a){return r?(a&&e("editIcon",a),q?void l.dispatchEvent("nodeIconEditRequested",h):!1):!1},this.scaleUp=function(a){l.scale(a,1.25)},this.scaleDown=function(a){l.scale(a,.8)},this.scale=function(a,b,c){q&&(l.dispatchEvent("mapScaleChanged",b,c),e(1>b?"scaleDown":"scaleUp",a))},this.move=function(a,b,c){q&&(l.dispatchEvent("mapMoveRequested",b,c),e("move",a))},this.resetView=function(a){q&&(l.selectNode(f.id),l.dispatchEvent("mapViewResetRequested"),e("resetView",a))},this.openAttachment=function(a,b){e("openAttachment",a),b=b||h;var c=p.nodes[b],d=c&&c.attr&&c.attr.attachment;c&&l.dispatchEvent("attachmentOpened",b,d)},this.setAttachment=function(a,b,c){if(!r)return!1;e("setAttachment",a);var d=!(!c||!c.content);f.updateAttr(b,"attachment",d&&c)},this.addLink=function(a,b){return r?(e("addLink",a),void f.addLink(h,b)):!1},this.selectLink=function(a,b,c){return r?(e("selectLink",a),b?void l.dispatchEvent("linkSelected",b,c,f.getLinkAttr(b.ideaIdFrom,b.ideaIdTo,"style")):!1):!1},this.removeLink=function(a,b,c){return r?(e("removeLink",a),void f.removeLink(b,c)):!1},this.toggleAddLinkMode=function(a){return r?q?(e("toggleAddLinkMode",a),i=!i,void l.dispatchEvent("addLinkModeToggled",i)):!1:!1},this.cancelCurrentAction=function(a){return q?r?void(i&&this.toggleAddLinkMode(a)):!1:!1},l.undo=function(a){if(!r)return!1;e("undo",a);var b=j,c=k;q&&(f.undo(),b&&l.selectNode(b),c&&t(c))},l.redo=function(a){return r?(e("redo",a),void(q&&f.redo())):!1},l.moveRelative=function(a,b){return r?(e("moveRelative",a),void(q&&f.moveRelative(h,b))):!1},l.cut=function(a){if(!r)return!1;if(e("cut",a),q){var b,c=[],d=[];l.applyToActivated(function(a){c.push(a),d.push(f.findParent(a).id)}),o.put(f.cloneMultiple(c)),f.removeMultiple(c),b=_.find(d,f.findSubIdeaById),l.selectNode(b||f.id)}},l.contextForNode=function(a){var b=l.findIdeaById(a),c=b&&b.ideas&&_.size(b.ideas)>0,d=f.hasSiblings(a),e=b&&r&&o&&o.get();return b?{hasChildren:!!c,hasSiblings:!!d,canPaste:!!e}:void 0},l.copy=function(a){var b=[];return r?(e("copy",a),void(q&&(l.applyToActivated(function(a){b.push(a)}),o.put(f.cloneMultiple(b))))):!1},l.paste=function(a){if(!r)return!1;if(e("paste",a),q){var b=f.pasteMultiple(h,o.get());b&&b[0]&&l.selectNode(b[0])}},l.pasteStyle=function(a){var b,c=o.get();return r?(e("pasteStyle",a),void(q&&c&&c[0]&&(b=c[0].attr&&c[0].attr.style,l.applyToActivated(function(a){f.updateAttr(a,"style",b)})))):!1},l.getIcon=function(a){var b=p.nodes[a||h];return b?b.attr&&b.attr.icon:!1},l.setIcon=function(a,b,c,d,g,i){if(!r)return!1;e("setIcon",a),i=i||h;var j=l.findIdeaById(i);return j?void(b?f.updateAttr(i,"icon",{url:b,width:c,height:d,position:g}):j.title||i===f.id?f.updateAttr(i,"icon",!1):f.removeSubIdea(i)):!1},l.moveUp=function(a){l.moveRelative(a,-1)},l.moveDown=function(a){l.moveRelative(a,1)},l.getSelectedNodeId=function(){return z()},l.centerOnNode=function(a){p.nodes[a]||(f.startBatch(),_.each(f.calculatePath(a),function(a){f.updateAttr(a.id,"collapsed",!1)}),f.endBatch()),l.dispatchEvent("nodeFocusRequested",a),l.selectNode(a)},l.search=function(a){var b=[];return a=a.toLocaleLowerCase(),f.traverse(function(c){c.title&&c.title.toLocaleLowerCase().indexOf(a)>=0&&b.push({id:c.id,title:c.title})}),b},function(){var a=function(a){return p.nodes[a].x>=p.nodes[f.id].x},b=function(a){return p.nodes[a].x<=p.nodes[f.id].x},c=function(){return _.map(p.nodes,function(a,b){return _.extend({id:parseInt(b,10)},a)})},d=function(a,c,d){var g,i,j=h===f.id,k=j?-1/0:1/0;if(q)if(e(c,a),b(h)){g=f.id===h?f:f.findSubIdeaById(h),D(a,g.id);for(i in g.ideas)i=parseFloat(i),(j&&0>i&&i>k||!j&&i>0&&k>i)&&(k=i);1/0!==k&&k!==-1/0&&d.apply(l,[g.ideas[k].id])}else d.apply(l,[f.findParent(h).id])},g=function(b,c,d){var g,i,j=1/0;if(q)if(e(c,b),a(h)){g=f.id===h?f:f.findSubIdeaById(h),D(b,g.id);for(i in g.ideas)i=parseFloat(i),i>0&&j>i&&(j=i);1/0!==j&&d.apply(l,[g.ideas[j].id])}else d.apply(l,[f.findParent(h).id])},i=function(a,b,d){var g,i,j=f.previousSiblingId(h),k=p.nodes[h];if(q)if(e(b,a),j)d.apply(l,[j]);else{if(!k)return;if(g=_.reject(c(),function(a){return a.y>=k.y||Math.abs(a.x-k.x)>u}),0===_.size(g))return;i=_.min(g,function(a){return Math.pow(a.x-k.x,2)+Math.pow(a.y-k.y,2)}),d.apply(l,[i.id])}},j=function(a,b,d){var g,i,j=f.nextSiblingId(h),k=p.nodes[h];if(q)if(e(b,a),j)d.apply(l,[j]);else{if(!k)return;if(g=_.reject(c(),function(a){return a.y<=k.y||Math.abs(a.x-k.x)>u}),0===_.size(g))return;i=_.min(g,function(a){return Math.pow(a.x-k.x,2)+Math.pow(a.y-k.y,2)}),d.apply(l,[i.id])}},k={Left:d,Up:i,Down:j,Right:g};l.getActivatedNodeIds=function(){return s.slice(0)},l.activateSiblingNodes=function(a){var b,c=f.findParent(h);e("activateSiblingNodes",a),c&&c.ideas&&(b=_.map(c.ideas,function(a){return a.id}),t(b))},l.activateNodeAndChildren=function(a){e("activateNodeAndChildren",a);var b=z(),c=f.getSubTreeIds(b);c.push(b),t(c)},_.each(["Left","Right","Up","Down"],function(a){l["activateNode"+a]=function(b){k[a](b,"activateNode"+a,function(a){l.selectNode(a,!1,!0)
})},l["selectNode"+a]=function(b){k[a](b,"selectNode"+a,l.selectNode)}}),l.toggleActivationOnNode=function(a,b){e("toggleActivated",a),t(l.isActivated(b)?_.without(s,b):[b].concat(s))},l.activateNode=function(a,b){e("activateNode",a),l.isActivated(b)||(s.push(b),l.dispatchEvent("activatedNodesChanged",[b],[]))},l.activateChildren=function(a){e("activateChildren",a);var b=C();!b||_.isEmpty(b.ideas)||b.getAttr("collapsed")||t(f.getSubTreeIds(b.id))},l.activateSelectedNode=function(a){e("activateSelectedNode",a),t([z()])},l.isActivated=function(a){return _.find(s,function(b){return a==b})},l.applyToActivated=function(a){f.batch(function(){_.each(s,a)})},l.everyActivatedIs=function(a){return _.every(s,a)},l.activateLevel=function(a,b){e("activateLevel",a);var c=_.map(_.filter(p.nodes,function(a){return a.level==b}),function(a){return a.id});_.isEmpty(c)||t(c)},l.reactivate=function(a){return _.each(a.nodes,function(a){_.contains(s,a.id)&&(a.activated=!0)}),a}}(),l.getNodeIdAtPosition=function(a,b){var c=function(c){return a>=c.x&&b>=c.y&&a<=c.x+c.width&&b<=c.y+c.height},d=_.find(p.nodes,c);return d&&d.id},l.autoPosition=function(a){return f.updateAttr(a,"position",!1)},l.positionNodeAt=function(a,b,c,d){var g,h=p.nodes[f.id],i={id:null,y:1/0},j=f.findParent(a),k=p.nodes[j.id],m=p.nodes[a],n=function(b,c,d){var e=b.x<c.x&&d<b.x,g=b.x>c.x&&b.x<d;return e||g?f.flip(a):!1},o=1,q=function(){return 2===m.level||(m.x-k.x)*(b-k.x)>0},r=!1;return f.startBatch(),2===p.nodes[a].level&&(r=n(h,m,b)),_.each(f.sameSideSiblingIds(a),function(a){var b=p.nodes[a];c<b.y&&b.y<i.y&&(i=b)}),!d&&q()&&l.autoPosition(a),r=f.positionBefore(a,i.id)||r,d&&q()&&(g=b<k.x?k.x-b-m.width+k.width:b-k.x,e("nodeManuallyPositioned"),o=_.max(_.map(j.ideas,function(b){return b.id!==a&&b.attr&&b.attr.position&&b.attr.position[2]||0})),r=f.updateAttr(a,"position",[g,c-k.y,o+1])||r),f.endBatch(),r},l.dropNode=function(a,b,c){var d,e=f.findParent(a);return b===a?!1:c?(d=f.clone(a),d&&f.paste(b,d),!1):b===e.id?l.autoPosition(a):f.changeParent(a,b)},l.setLayoutCalculator=function(a){m=a},l.dropImage=function(a,b,c,d,e){var g,i=function(d,e){var g=Math.min(b,300)/b,h=Math.min(c,300)/c,i=Math.min(g,h),j=f.getAttrById(d,"icon");l.setIcon("drag and drop",a,Math.round(b*i),Math.round(c*i),j&&j.position||e,d)},j=function(){var a;f.startBatch(),a=f.addSubIdea(h),i(a,"center"),f.endBatch(),l.selectNode(a)};return(g=l.getNodeIdAtPosition(d,e))?i(g,"left"):void j()},l.setLabelGenerator=function(a){g=a,l.rebuildRequired()},l.getReorderBoundary=function(a){var b,c,d,e,g,h,i=function(){return a==f.id},j=function(){return b.id===f.id},k=function(a){return p.nodes[a].x>=p.nodes[f.id].x},l=function(b,d){var e=_.map(b,function(a){return a.y}),f=_.map(b,function(a){return a.y+a.height}),g={minY:_.min(e)-n-p.nodes[a].height,maxY:_.max(f)+n,margin:n};return g.edge=d,g.x="left"===d?c.x+c.width+n:c.x-n,g},m=function(b){var d={minY:c.y-n-p.nodes[a].height,maxY:c.y+c.height+n,margin:n};return d.edge=b,d.x="left"===b?c.x+c.width+n:c.x-n,d},o=function(){var c=_.map(b.ideas,function(a){return p.nodes[a.id]});return c=_.without(c,p.nodes[a]),_.isEmpty(d)||(c=_.difference(c,d)),c},q=[];return i(a)?!1:(b=f.findParent(a),c=p.nodes[b.id],g=k(a)?"left":"right",h=k(a)?"right":"left",d=_.map(f.sameSideSiblingIds(a),function(a){return p.nodes[a]}),_.isEmpty(d)||q.push(l(d,g)),q.push(m(g)),j()&&(e=o(),_.isEmpty(e)||q.push(l(e,h)),q.push(m(h))),q)},l.focusAndSelect=function(a){l.selectNode(a),l.dispatchEvent("nodeFocusRequested",a)},l.requestContextMenu=function(a,b){return q&&r?(l.dispatchEvent("contextMenuRequested",h,a,b),!0):!1}},jQuery.fn.mapToolbarWidget=function(a){"use strict";var b=["insertIntermediate","scaleUp","scaleDown","addSubIdea","editNode","removeSubIdea","toggleCollapse","addSiblingIdea","undo","redo","copy","cut","paste","resetView","openAttachment","toggleAddLinkMode","activateChildren","activateNodeAndChildren","activateSiblingNodes","editIcon"],c=["updateStyle"];return this.each(function(){var d=jQuery(this),e=!1;a.addEventListener("nodeSelectionChanged",function(){e=!0,d.find(".updateStyle[data-mm-target-property]").val(function(){return a.getSelectedStyle(jQuery(this).data("mm-target-property"))}).change(),e=!1}),a.addEventListener("addLinkModeToggled",function(){d.find(".toggleAddLinkMode").toggleClass("active")}),b.forEach(function(b){d.find("."+b).click(function(){a[b]&&a[b]("toolbar")})}),c.forEach(function(b){d.find("."+b).change(function(){if(!e){var c=jQuery(this);c.data("mm-target-property")&&a[b]("toolbar",c.data("mm-target-property"),c.val())}})})})},jQuery.fn.linkEditWidget=function(a){"use strict";return this.each(function(){var b,c,d,e,f,g,h=jQuery(this);e=h.find(".color"),f=h.find(".lineStyle"),g=h.find(".arrow"),a.addEventListener("linkSelected",function(a,i,j){b=a,h.show(),c=c||h.width(),d=d||h.height(),h.css({top:i.y-.5*d-15+"px",left:i.x-.5*c-15+"px"}),e.val(j.color).change(),f.val(j.lineStyle),g[j.arrow?"addClass":"removeClass"]("active")}),a.addEventListener("mapMoveRequested",function(){h.hide()}),h.find(".delete").click(function(){a.removeLink("mouse",b.ideaIdFrom,b.ideaIdTo),h.hide()}),e.change(function(){a.updateLinkStyle("mouse",b.ideaIdFrom,b.ideaIdTo,"color",jQuery(this).val())}),f.find("a").click(function(){a.updateLinkStyle("mouse",b.ideaIdFrom,b.ideaIdTo,"lineStyle",jQuery(this).text())}),g.click(function(){a.updateLinkStyle("mouse",b.ideaIdFrom,b.ideaIdTo,"arrow",!g.hasClass("active"))}),h.mouseleave(h.hide.bind(h))})},MAPJS.getDataURIAndDimensions=function(a,b){"use strict";var c=function(a){return/^data:image/.test(a)},d=function(a){if(c(a.src))return a.src;var b,d=document.createElement("canvas");return d.width=a.width,d.height=a.height,b=d.getContext("2d"),b.drawImage(a,0,0),d.toDataURL("image/png")},e=jQuery.Deferred(),f=new Image;return f.onload=function(){try{e.resolve({dataUri:d(f),width:f.width,height:f.height})}catch(a){e.reject()}},f.onerror=function(){e.reject()},c(a)||(b?(f.crossOrigin="Anonymous",a=b+encodeURIComponent(a)):e.reject("no-cors")),f.src=a,e.promise()},MAPJS.ImageInsertController=function(a,b){"use strict";var c=observable(this),d=function(a){var b=jQuery.Deferred(),c=new FileReader;return c.onload=function(a){b.resolve(a.target.result)},c.onerror=b.reject,c.onprogress=b.notify,c.readAsDataURL(a),b.promise()};c.insertDataUrl=function(d,e){c.dispatchEvent("imageLoadStarted"),MAPJS.getDataURIAndDimensions(d,a).then(function(a){var d=a.dataUri;b&&(d=b(d)),c.dispatchEvent("imageInserted",d,a.width,a.height,e)},function(a){c.dispatchEvent("imageInsertError",a)})},c.insertFiles=function(a,b){jQuery.each(a,function(a,e){/^image\//.test(e.type)&&jQuery.when(d(e)).done(function(a){c.insertDataUrl(a,b)})})},c.insertHtmlContent=function(a,b){var d=a.match(/img[^>]*src="([^"]*)"/);d&&d.length>0&&_.each(d.slice(1),function(a){c.insertDataUrl(a,b)})}},jQuery.fn.imageDropWidget=function(a){"use strict";return this.on("dragenter dragover",function(a){return a.originalEvent.dataTransfer?!1:void 0}).on("drop",function(b){var c,d=b.originalEvent.dataTransfer;b.stopPropagation(),b.preventDefault(),d&&d.files&&d.files.length>0?a.insertFiles(d.files,b.originalEvent):d&&(c=d.getData("text/html"),a.insertHtmlContent(c,b.originalEvent))}),this},MAPJS.DOMRender={svgPixel:'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="1" height="1"></svg>',nodeCacheMark:function(a,b){"use strict";return{title:a.title,icon:a.attr&&a.attr.icon&&_.pick(a.attr.icon,"width","height","position"),collapsed:a.attr&&a.attr.collapsed,level:a.level||b}},dummyTextBox:jQuery("<div>").addClass("mapjs-node").css({position:"absolute",visibility:"hidden"}),dimensionProvider:function(a,b){"use strict";var c,d=jQuery(document).nodeWithId(a.id),e=function(){return MAPJS.DOMRender.svgPixel};return d&&d.length>0&&_.isEqual(d.data("nodeCacheMark"),MAPJS.DOMRender.nodeCacheMark(a,b))?_.pick(d.data(),"width","height"):(d=MAPJS.DOMRender.dummyTextBox,d.attr("mapjs-level",b).appendTo("body").updateNodeContent(a,e),c={width:d.outerWidth(!0),height:d.outerHeight(!0)},d.detach(),c)},layoutCalculator:function(a){"use strict";return MAPJS.calculateLayout(a,MAPJS.DOMRender.dimensionProvider)},fixedLayout:!1},MAPJS.createSVG=function(a){"use strict";return jQuery(document.createElementNS("http://www.w3.org/2000/svg",a||"svg"))},jQuery.fn.getBox=function(){"use strict";var a=this&&this[0];return a?{top:a.offsetTop,left:a.offsetLeft,width:a.offsetWidth,height:a.offsetHeight}:!1},jQuery.fn.getDataBox=function(){"use strict";var a=this.data();return a&&a.width&&a.height?{top:a.y,left:a.x,width:a.width,height:a.height}:this.getBox()},jQuery.fn.animateConnectorToPosition=function(a,b){"use strict";var c=jQuery(this),d=c.data("nodeFrom"),e=c.data("nodeTo"),f=d&&d.getDataBox(),g=e&&e.getDataBox(),h={from:d&&d.getBox(),to:e&&e.getBox()};return b=b||1,f&&g&&h&&h.from.width===f.width&&h.to.width===g.width&&h.from.height===f.height&&h.to.height===g.height&&Math.abs(h.from.top-h.to.top-(f.top-g.top))<b&&Math.abs(h.from.left-h.to.left-(f.left-g.left))<b?(c.animate({left:Math.round(Math.min(f.left,g.left)),top:Math.round(Math.min(f.top,g.top))},a),!0):!1},jQuery.fn.queueFadeOut=function(a){"use strict";var b=this;return b.fadeOut(_.extend({complete:function(){b.is(":focus")&&b.parents("[tabindex]").focus(),b.remove()}},a))},jQuery.fn.queueFadeIn=function(a){"use strict";var b=this;return b.css("opacity",0).animate({opacity:1},_.extend({complete:function(){b.css("opacity","")}},a))},jQuery.fn.updateStage=function(){"use strict";var a=this.data(),b={"min-width":Math.round(a.width-a.offsetX),"min-height":Math.round(a.height-a.offsetY),width:Math.round(a.width-a.offsetX),height:Math.round(a.height-a.offsetY),"transform-origin":"top left",transform:"translate3d("+Math.round(a.offsetX)+"px, "+Math.round(a.offsetY)+"px, 0)"};return a.scale&&1!==a.scale&&(b.transform="scale("+a.scale+") translate("+Math.round(a.offsetX)+"px, "+Math.round(a.offsetY)+"px)"),this.css(b),this},MAPJS.DOMRender.curvedPath=function(a,b){"use strict";var c,d,e,f=function(a,b,c,d,e,f,g,h){var i=e>a?.1:.9,j=1-i;return{from:{x:a+j*c,y:b+.5*d},to:{x:e+i*g,y:f+.5*h},controlPointOffset:0}},g=function(a,b){var c,d=10,e=b.top+.5*b.height,g=a.top+.5*a.height;return Math.abs(g-e)+d<Math.max(b.height,.75*a.height)?f(a.left,a.top,a.width,a.height,b.left,b.top,b.width,b.height):(c=a.left<b.left?0:1,{from:{x:a.left+.5*a.width,y:a.top+.5*a.height},to:{x:b.left+c*b.width,y:b.top+.5*b.height},controlPointOffset:.75})},h={left:Math.min(a.left,b.left),top:Math.min(a.top,b.top)};return h.width=Math.max(a.left+a.width,b.left+b.width,h.left+1)-h.left,h.height=Math.max(a.top+a.height,b.top+b.height,h.top+1)-h.top,c=g(a,b),d=c.controlPointOffset*(c.from.y-c.to.y),e=1.5*Math.min(b.height,a.height),d=Math.max(-e,Math.min(e,d)),{d:"M"+Math.round(c.from.x-h.left)+","+Math.round(c.from.y-h.top)+"Q"+Math.round(c.from.x-h.left)+","+Math.round(c.to.y-d-h.top)+" "+Math.round(c.to.x-h.left)+","+Math.round(c.to.y-h.top),position:h}},MAPJS.DOMRender.straightPath=function(a,b){"use strict";var c=function(a,b){var c,d,e,f,g,h,i,j=[{x:a.left+.5*a.width,y:a.top},{x:a.left+a.width,y:a.top+.5*a.height},{x:a.left+.5*a.width,y:a.top+a.height},{x:a.left,y:a.top+.5*a.height}],k=[{x:b.left+.5*b.width,y:b.top},{x:b.left+b.width,y:b.top+.5*b.height},{x:b.left+.5*b.width,y:b.top+b.height},{x:b.left,y:b.top+.5*b.height}],l=1/0;for(c=0;c<j.length;c+=1)for(d=0;d<k.length;d+=1)g=j[c].x-k[d].x,h=j[c].y-k[d].y,i=g*g+h*h,l>i&&(e=c,f=d,l=i);return{from:j[e],to:k[f]}},d={left:Math.min(a.left,b.left),top:Math.min(a.top,b.top)},e=c(a,b);return d.width=Math.max(a.left+a.width,b.left+b.width,d.left+1)-d.left,d.height=Math.max(a.top+a.height,b.top+b.height,d.top+1)-d.top,{d:"M"+Math.round(e.from.x-d.left)+","+Math.round(e.from.y-d.top)+"L"+Math.round(e.to.x-d.left)+","+Math.round(e.to.y-d.top),conn:e,position:d}},MAPJS.DOMRender.nodeConnectorPath=MAPJS.DOMRender.curvedPath,MAPJS.DOMRender.linkConnectorPath=MAPJS.DOMRender.straightPath,jQuery.fn.updateConnector=function(a){"use strict";return jQuery.each(this,function(){var b,c,d,e,f,g=jQuery(this),h=g.data("nodeFrom"),i=g.data("nodeTo");return h&&i&&0!==h.length&&0!==i.length?(a?(d=h.getDataBox(),e=i.getDataBox()):(d=h.getBox(),e=i.getBox()),f={from:d,to:e},void(_.isEqual(f,g.data("changeCheck"))||(g.data("changeCheck",f),b=MAPJS.DOMRender.nodeConnectorPath(d,e),c=g.find("path"),g.css(b.position),0===c.length&&(c=MAPJS.createSVG("path").attr("class","mapjs-connector").appendTo(g)),c.attr("d",b.d)))):void g.hide()})},jQuery.fn.updateLink=function(){"use strict";return jQuery.each(this,function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n=jQuery(this),o=n.data("nodeFrom"),p=n.data("nodeTo"),q=n.find("path.mapjs-link"),r=n.find("path.mapjs-link-hit"),s=n.find("path.mapjs-arrow"),t=Math.tan(Math.PI/9),u={dashed:"8, 8",solid:""},v=_.pick(n.data(),"lineStyle","arrow","color");return o&&p&&0!==o.length&&0!==p.length?(b=o.getBox(),c=p.getBox(),d={from:b,to:c,attrs:v},void(_.isEqual(d,n.data("changeCheck"))||(n.data("changeCheck",d),a=MAPJS.DOMRender.linkConnectorPath(b,c),n.css(a.position),0===q.length&&(q=MAPJS.createSVG("path").attr("class","mapjs-link").appendTo(n)),q.attr({d:a.d,"stroke-dasharray":u[v.lineStyle]}).css("stroke",v.color),0===r.length&&(r=MAPJS.createSVG("path").attr("class","mapjs-link-hit").appendTo(n)),r.attr({d:a.d}),v.arrow?(0===s.length&&(s=MAPJS.createSVG("path").attr("class","mapjs-arrow").appendTo(n)),i=14,l=a.conn.to.x-a.conn.from.x,m=a.conn.to.y-a.conn.from.y,0===l?(j=0>m?-1:1,e=a.conn.to.x+i*Math.sin(t)*j,g=a.conn.to.x-i*Math.sin(t)*j,f=a.conn.to.y-i*Math.cos(t)*j,h=a.conn.to.y-i*Math.cos(t)*j):(k=m/l,a.conn.from.x<a.conn.to.x&&(i=-i),e=a.conn.to.x+(1-k*t)*i/Math.sqrt((1+k*k)*(1+t*t)),f=a.conn.to.y+(k+t)*i/Math.sqrt((1+k*k)*(1+t*t)),g=a.conn.to.x+(1+k*t)*i/Math.sqrt((1+k*k)*(1+t*t)),h=a.conn.to.y+(k-t)*i/Math.sqrt((1+k*k)*(1+t*t))),s.attr("d","M"+Math.round(e-a.position.left)+","+Math.round(f-a.position.top)+"L"+Math.round(a.conn.to.x-a.position.left)+","+Math.round(a.conn.to.y-a.position.top)+"L"+Math.round(g-a.position.left)+","+Math.round(h-a.position.top)+"Z").css("fill",v.color).show()):s.hide()))):void n.hide()})},jQuery.fn.addNodeCacheMark=function(a){"use strict";this.data("nodeCacheMark",MAPJS.DOMRender.nodeCacheMark(a))},jQuery.fn.updateNodeContent=function(a,b){"use strict";var c=25,d=jQuery(this),e=function(){var a=d.find("[data-mapjs-role=title]");return 0===a.length&&(a=jQuery("<span>").attr("data-mapjs-role","title").appendTo(d)),a},f=function(a){var b=MAPJS.URLHelper.getLink(a),c=d.find("a.mapjs-hyperlink");return b?(0===c.length&&(c=jQuery('<a target="_blank" class="mapjs-hyperlink"></a>').appendTo(d)),void c.attr("href",b).show()):void c.hide()},g=function(a){var b=d.find(".mapjs-label");return a||0===a?(0===b.length&&(b=jQuery('<span class="mapjs-label"></span>').appendTo(d)),void b.text(a).show()):void b.hide()},h=function(){var b=a.attr&&a.attr.attachment,c=d.find("a.mapjs-attachment");return b?(0===c.length&&(c=jQuery('<a href="#" class="mapjs-attachment"></a>').appendTo(d).click(function(){d.trigger("attachment-click")})),void c.show()):void c.hide()},i=function(a){var b,f=MAPJS.URLHelper.stripLink(a)||(a.length<c?a:a.substring(0,c)+"..."),g=MAPJS.DOMRender.nodeTextPadding||11,h=e(),i=h[0];h.text(f.trim()),d.data("title",a),h.css({"max-width":"","min-width":""}),i.scrollWidth-g>i.offsetWidth?h.css("max-width",i.scrollWidth+"px"):(b=i.offsetHeight,h.css("min-width",h.css("max-width")),i.offsetHeight===b&&h.css("min-width",""))},j=function(){a.attr&&a.attr.collapsed?d.addClass("collapsed"):d.removeClass("collapsed")},k=function(a){var b=Color(a).mix(Color("#EEEEEE")).luminosity();return.5>b?"mapjs-node-dark":.9>b?"mapjs-node-light":"mapjs-node-white"},l=function(){var b=a.attr&&a.attr.style&&a.attr.style.background;("false"===b||"transparent"===b)&&(b=!1),d.removeClass("mapjs-node-dark mapjs-node-white mapjs-node-light"),b?(d.css("background-color",b),d.addClass(k(b))):d.css("background-color","")},m=function(a){var c,f,g,h,i=e(),j={"min-height":"","min-width":"","background-image":"","background-repeat":"","background-size":"","background-position":""},k={"margin-top":"","margin-left":""};d.css({padding:""}),a&&(h=parseInt(d.css("padding-left"),10),c=i.outerHeight(),f=i.outerWidth(),g=parseInt(i.css("max-width"),10),_.extend(j,{"background-image":'url("'+(b?b(a.url):a.url)+'")',"background-repeat":"no-repeat","background-size":a.width+"px "+a.height+"px","background-position":"center center"}),"top"===a.position||"bottom"===a.position?(j["background-position"]="top"===a.position?"center "+h+"px":MAPJS.DOMRender.fixedLayout?"center "+(h+c)+"px":"center "+a.position+" "+h+"px",j["padding-"+a.position]=a.height+2*h,j["min-width"]=a.width,a.width>g&&(k["margin-left"]=(a.width-g)/2)):"left"===a.position||"right"===a.position?(j["background-position"]="left"===a.position?h+"px center":MAPJS.DOMRender.fixedLayout?f+2*h+"px center ":a.position+" "+h+"px center",j["padding-"+a.position]=a.width+2*h,a.height>c&&(k["margin-top"]=(a.height-c)/2,j["min-height"]=a.height)):(a.height>c&&(k["margin-top"]=(a.height-c)/2,j["min-height"]=a.height),j["min-width"]=a.width,a.width>g&&(k["margin-left"]=(a.width-g)/2))),d.css(j),i.css(k)};return d.attr("mapjs-level",a.level),i(a.title),f(a.title),g(a.label),h(),d.data({x:Math.round(a.x),y:Math.round(a.y),width:Math.round(a.width),height:Math.round(a.height),nodeId:a.id}).addNodeCacheMark(a),l(),m(a.attr&&a.attr.icon),j(),d},jQuery.fn.placeCaretAtEnd=function(){"use strict";var a,b,c,d=this[0];window.getSelection&&document.createRange?(a=document.createRange(),a.selectNodeContents(d),a.collapse(!1),b=window.getSelection(),b.removeAllRanges(),b.addRange(a)):document.body.createTextRange&&(c=document.body.createTextRange(),c.moveToElementText(d),c.collapse(!1),c.select())},jQuery.fn.selectAll=function(){"use strict";var a,b,c,d=this[0];window.getSelection&&document.createRange?(a=document.createRange(),a.selectNodeContents(d),b=window.getSelection(),b.removeAllRanges(),b.addRange(a)):document.body.createTextRange&&(c=document.body.createTextRange(),c.moveToElementText(d),c.select())},jQuery.fn.innerText=function(){"use strict";var a=this.html(),b=/<br\/?>/.test(a);return b?a.replace(/<br\/?>/gi,"\n").replace(/(<([^>]+)>)/gi,""):this.text()},jQuery.fn.editNode=function(a){"use strict";var b=this,c=this.find("[data-mapjs-role=title]"),d=this.data("title"),e=c.text(),f=jQuery.Deferred(),g=function(){l(),c.css("word-break",""),c.removeAttr("contenteditable"),b.shadowDraggable()},h=function(){var a=c.innerText();return a===d?i():(g(),void f.resolve(a))},i=function(){g(),c.text(e),f.reject()},j=function(a){var b=13,e=27,f=9,g=83,j=90;a.shiftKey&&a.which===b||(a.which===b?(h(),a.stopPropagation()):a.which===e?(i(),a.stopPropagation()):a.which===f||a.which===g&&(a.metaKey||a.ctrlKey)&&!a.altKey?(h(),a.preventDefault()):a.shiftKey||a.which!==j||!a.metaKey&&!a.ctrlKey||a.altKey||(c.text()===d&&i(),a.stopPropagation()))},k=function(){c.on("blur",h).on("keydown",j)},l=function(){c.off("blur",h).off("keydown",j)};return k(),d!==e&&c.css("word-break","break-all"),c.text(d).attr("contenteditable",!0).focus(),a?c.selectAll():d&&c.placeCaretAtEnd(),b.shadowDraggable({disable:!0}),f.promise()},jQuery.fn.updateReorderBounds=function(a,b){"use strict";var c=this;return a?(c.show(),c.attr("mapjs-edge",a.edge),void c.css({top:b.y+b.height/2-c.height()/2,left:a.x-("left"===a.edge?c.width():0)})):void c.hide()},function(){"use strict";var a=function(a){return a.replace(/\./g,"_")},b=function(b){return a("connector_"+b.from+"_"+b.to)},c=function(b){return a("link_"+b.ideaIdFrom+"_"+b.ideaIdTo)},d=function(b){return a("node_"+b)};jQuery.fn.createNode=function(a){return jQuery("<div>").attr({id:d(a.id),tabindex:0,"data-mapjs-role":"node"}).css({display:"block",position:"absolute"}).addClass("mapjs-node").appendTo(this)},jQuery.fn.createConnector=function(a){return MAPJS.createSVG().attr({id:b(a),"data-mapjs-role":"connector","class":"mapjs-draw-container"}).data({nodeFrom:this.nodeWithId(a.from),nodeTo:this.nodeWithId(a.to)}).appendTo(this)},jQuery.fn.createLink=function(a){var b=_.extend({color:"red",lineStyle:"dashed"},a.attr&&a.attr.style);return MAPJS.createSVG().attr({id:c(a),"data-mapjs-role":"link","class":"mapjs-draw-container"}).data({nodeFrom:this.nodeWithId(a.ideaIdFrom),nodeTo:this.nodeWithId(a.ideaIdTo)}).data(b).appendTo(this)},jQuery.fn.nodeWithId=function(a){return this.find("#"+d(a))},jQuery.fn.findConnector=function(a){return this.find("#"+b(a))},jQuery.fn.findLink=function(a){return this.find("#"+c(a))},jQuery.fn.createReorderBounds=function(){var a=jQuery("<div>").attr({"data-mapjs-role":"reorder-bounds","class":"mapjs-reorder-bounds"}).hide().css("position","absolute").appendTo(this);return a}}(),MAPJS.DOMRender.viewController=function(a,b,c,d,e,f){"use strict";var g,h=b.parent(),i=jQuery(),j=jQuery(),k={duration:400,queue:"nodeQueue",easing:"linear"},l=a.isEditingEnabled()?b.createReorderBounds():jQuery("<div>"),m=function(){return g?g:g={left:h.scrollLeft(),top:h.scrollTop(),innerWidth:h.innerWidth(),innerHeight:h.innerHeight()}},n=function(a,c){var d=b.data(),e=m();return{x:d.scale*(a+d.offsetX)-e.left,y:d.scale*(c+d.offsetY)-e.top}},o=function(a,c){var d=b.data(),e=m();return{x:(e.left+a)/d.scale-d.offsetX,y:(e.top+c)/d.scale-d.offsetY}},p=function(){var a=jQuery(this);a.css({left:a.data("x"),top:a.data("y")}).trigger("mapjs:move")},q=function(){var a=jQuery(this);a.clearQueue(k.queue).animate({left:a.data("x"),top:a.data("y"),opacity:1},_.extend({complete:function(){a.css("opacity",""),a.each(p)}},k)).trigger("mapjs:animatemove")},r=function(a,c){var d=b.data(),e=!1;a<-1*d.offsetX&&(d.width=d.width-d.offsetX-a,d.offsetX=-1*a,e=!0),c<-1*d.offsetY&&(d.height=d.height-d.offsetY-c,d.offsetY=-1*c,e=!0),a>d.width-d.offsetX&&(d.width=d.offsetX+a,e=!0),c>d.height-d.offsetY&&(d.height=d.offsetY+c,e=!0),e&&b.updateStage()},s=function(){return jQuery(this).each(function(){var a=jQuery(this).data(),b=MAPJS.DOMRender.stageMargin||{top:0,left:0,bottom:0,right:0};r(a.x-b.left,a.y-b.top),r(a.x+a.width+b.right,a.y+a.height+b.bottom)})},t=function(a,c,d){var e,f,g=b.data(),i={x:h.innerWidth()/2,y:h.innerHeight()/2},j=MAPJS.DOMRender.stageVisibilityMargin||{top:0,left:0,bottom:0,right:0};r(a-i.x/g.scale,c-i.y/g.scale),r(a+i.x/g.scale-j.left,c+i.y/g.scale-j.top),e=g.scale*(a+g.offsetX)-i.x,f=g.scale*(c+g.offsetY)-i.y,h.finish(),d?h.animate({scrollLeft:e,scrollTop:f},{duration:400}):(h.scrollLeft(e),h.scrollTop(f))},u=function(){return o(h.innerWidth()/2,h.innerHeight()/2)},v=function(a){if(a&&0!==a.length){h.finish();var b=a.data(),c=n(b.x,b.y),d=n(b.x+b.width,b.y+b.height),e={},f=MAPJS.DOMRender.stageVisibilityMargin||{top:10,left:10,bottom:10,right:10};c.x-f.left<0?e.scrollLeft=h.scrollLeft()+c.x-f.left:d.x+f.right>h.innerWidth()&&(e.scrollLeft=h.scrollLeft()+d.x-h.innerWidth()+f.right),c.y-f.top<0?e.scrollTop=h.scrollTop()+c.y-f.top:d.y+f.bottom>h.innerHeight()&&(e.scrollTop=h.scrollTop()+d.y-h.innerHeight()+f.bottom),_.isEmpty(e)||h.animate(e,{duration:100})}},w=function(a){var b,c=a&&a.gesture&&a.gesture.center||a,d=h.offset();return c&&(b={x:c.pageX-d.left,y:c.pageY-d.top},b.x>=0&&b.x<=h.innerWidth()&&b.y>=0&&b.y<=h.innerHeight())?b:void 0},x=function(a){var b=w(a);return b?o(b.x,b.y):void 0},y=function(){(A||A===!1)&&(jQuery(".mapjs-node").removeClass("droppable"),A=void 0)},z=function(a){b.nodeWithId(a).addClass("droppable"),A=a},A=!1,B=function(a,b){if(_.isEmpty(a))return!1;if(!b)return!1;var c=function(a){var c=b.x;return"right"===a.edge&&(c+=b.width),Math.abs(c-a.x)<2*a.margin&&b.y<a.maxY&&b.y>a.minY};return _.find(a,c)};h.on("scroll",function(){g=void 0}),d&&d.addEventListener("imageInserted",function(b,c,d,e){var f=x(e);a.dropImage(b,c,d,f&&f.x,f&&f.y)}),a.addEventListener("nodeCreated",function(d){var f,g=b.createNode(d).queueFadeIn(k).updateNodeContent(d,e).on("tap",function(b){var c=b.gesture&&b.gesture.srcEvent||b;c.button&&-1!==c.button||(a.clickNode(d.id,c),b&&b.stopPropagation(),b&&b.gesture&&b.gesture.stopPropagation())}).on("doubletap",function(b){return b&&(b.stopPropagation(),b.gesture&&b.gesture.stopPropagation()),a.isEditingEnabled()?void a.editNode("mouse"):void a.toggleCollapse("mouse")}).on("attachment-click",function(){a.openAttachment("mouse",d.id)}).each(s).each(p).on("mm:start-dragging mm:start-dragging-shadow",function(){a.selectNode(d.id),f=a.getReorderBoundary(d.id),g.addClass("dragging")}).on("mm:drag",function(b){var c,e,h=x(b),i=b.currentPosition&&x({pageX:b.currentPosition.left,pageY:b.currentPosition.top}),j=b&&b.gesture&&b.gesture.srcEvent&&b.gesture.srcEvent.shiftKey;return h?(c=a.getNodeIdAtPosition(h.x,h.y),j||c||!i?l.hide():(i.width=g.outerWidth(),i.height=g.outerHeight(),e=B(f,i),l.updateReorderBounds(e,i)),void(c&&c!==d.id?c!==A&&(y(),c&&z(c)):y())):void y()}).on("contextmenu",function(b){return a.selectNode(d.id),a.requestContextMenu(b.pageX,b.pageY)?(b.preventDefault(),!1):void 0}).on("mm:stop-dragging",function(b){g.removeClass("dragging"),l.hide();var c,e,h,i,j,k=b&&b.gesture&&b.gesture.srcEvent&&b.gesture.srcEvent.shiftKey,m=x(b);return y(),m?(c=a.getNodeIdAtPosition(m.x,m.y),e=x({pageX:b.finalPosition.left,pageY:b.finalPosition.top}),c&&c!==d.id?h=a.dropNode(d.id,c,!!k):d.level>1?(e.width=g.outerWidth(),e.height=g.outerHeight(),i=!!k||!B(f,e),h=a.positionNodeAt(d.id,e.x,e.y,i)):1===d.level&&b.gesture?(j=u(),j.x-=b.gesture.deltaX||0,j.y-=b.gesture.deltaY||0,t(j.x,j.y,!0),h=!0):h=!1,h):void 0}).on("mm:cancel-dragging",function(){y(),g.removeClass("dragging"),l.hide()});c&&g.on("hold",function(b){var c=b.gesture&&b.gesture.srcEvent||b;return a.clickNode(d.id,c),a.requestContextMenu(b.gesture.center.pageX,b.gesture.center.pageY)?(b.preventDefault(),b.gesture&&(b.gesture.preventDefault(),b.gesture.stopPropagation()),!1):void 0}),g.css("min-width",g.css("width")),a.isEditingEnabled()&&g.shadowDraggable()}),a.addEventListener("nodeSelectionChanged",function(a,c){var d=b.nodeWithId(a);c?(d.addClass("selected"),v(d)):d.removeClass("selected")}),a.addEventListener("nodeRemoved",function(a){b.nodeWithId(a.id).queueFadeOut(k)}),a.addEventListener("nodeMoved",function(a){var c=m(),d=b.nodeWithId(a.id).data({x:Math.round(a.x),y:Math.round(a.y)}).each(s),e=n(Math.round(a.x),Math.round(a.y)),f=n(Math.round(a.x+a.width),Math.round(a.y+a.height));d.each(f.x<0||f.y<0||e.x>c.innerWidth||e.y>c.innerHeight?p:q)}),a.addEventListener("nodeTitleChanged nodeAttrChanged nodeLabelChanged",function(a){b.nodeWithId(a.id).updateNodeContent(a,e)}),a.addEventListener("connectorCreated",function(a){var c=b.createConnector(a).queueFadeIn(k).updateConnector(!0);b.nodeWithId(a.from).add(b.nodeWithId(a.to)).on("mapjs:move",function(){c.updateConnector(!0)}).on("mm:drag",function(){c.updateConnector()}).on("mapjs:animatemove",function(){i=i.add(c)})}),a.addEventListener("connectorRemoved",function(a){b.findConnector(a).queueFadeOut(k)}),a.addEventListener("linkCreated",function(c){var d=b.createLink(c).queueFadeIn(k).updateLink();d.find(".mapjs-link-hit").on("tap",function(b){a.selectLink("mouse",c,{x:b.gesture.center.pageX,y:b.gesture.center.pageY}),b.stopPropagation(),b.gesture.stopPropagation()}),b.nodeWithId(c.ideaIdFrom).add(b.nodeWithId(c.ideaIdTo)).on("mapjs:move mm:drag",function(){d.updateLink()}).on("mapjs:animatemove",function(){j=j.add(d)})}),a.addEventListener("linkRemoved",function(a){b.findLink(a).queueFadeOut(k)}),a.addEventListener("mapScaleChanged",function(a){var c=b.data("scale"),d=Math.max(Math.min(c*a,5),.2),e=u();c!==d&&(b.data("scale",d).updateStage(),t(e.x,e.y))}),a.addEventListener("nodeVisibilityRequested",function(c){var d=c||a.getCurrentlySelectedIdeaId(),e=b.nodeWithId(d);e&&(v(e),h.finish())}),a.addEventListener("nodeFocusRequested",function(a){var c=b.nodeWithId(a).data(),d=c.x+c.width/2,e=c.y+c.height/2;1!==b.data("scale")&&b.data("scale",1).updateStage(),t(d,e,!0)}),a.addEventListener("mapViewResetRequested",function(){b.data({scale:1,height:0,width:0,offsetX:0,offsetY:0}).updateStage(),b.children().andSelf().finish(k.queue),jQuery(b).find(".mapjs-node").each(s),jQuery(b).find("[data-mapjs-role=connector]").updateConnector(!0),jQuery(b).find("[data-mapjs-role=link]").updateLink(),t(0,0),h.focus()}),a.addEventListener("layoutChangeStarting",function(){g=void 0,b.children().finish(k.queue),b.finish(k.queue)}),a.addEventListener("layoutChangeComplete",function(){var c=jQuery(),d=jQuery();i.each(function(){jQuery(this).animateConnectorToPosition(k,2)||(c=c.add(this))}),j.each(function(){jQuery(this).animateConnectorToPosition(k,2)||(d=d.add(this))}),i=jQuery(),j=jQuery(),b.animate({opacity:1},_.extend({progress:function(){c.updateConnector(),d.updateLink()}},k)),v(b.nodeWithId(a.getCurrentlySelectedIdeaId())),b.children().dequeue(k.queue),b.dequeue(k.queue)}),f&&f.inlineEditingDisabled||a.addEventListener("nodeEditRequested",function(c,d,e){var f=b.nodeWithId(c);a.setInputEnabled(!1),h.finish(),f.editNode(d).done(function(b){a.setInputEnabled(!0),a.updateTitle(c,b,e),f.focus()}).fail(function(){a.setInputEnabled(!0),e&&a.undo("internal"),f.focus()})}),a.addEventListener("addLinkModeToggled",function(a){a?b.addClass("mapjs-add-link"):b.removeClass("mapjs-add-link")}),a.addEventListener("linkAttrChanged",function(a){var c=_.extend({arrow:!1},a.attr&&a.attr.style);b.findLink(a).data(c).updateLink()}),a.addEventListener("activatedNodesChanged",function(a,c){_.each(a,function(a){b.nodeWithId(a).addClass("activated")}),_.each(c,function(a){b.nodeWithId(a).removeClass("activated")})})},jQuery.fn.scrollWhenDragging=function(a){"use strict";return this.each(function(){var b,c=$(this);c.on("dragstart",function(){a()&&(b={top:c.scrollTop(),left:c.scrollLeft()})}).on("drag",function(a){a.gesture&&b&&(c.scrollTop(b.top-a.gesture.deltaY),c.scrollLeft(b.left-a.gesture.deltaX))}).on("dragend",function(){b=void 0})})},$.fn.domMapWidget=function(a,b,c,d,e,f,g,h){"use strict";var i={"return":"addSiblingIdea","shift+return":"addSiblingIdeaBefore","del backspace":"removeSubIdea","tab insert":"addSubIdea",left:"selectNodeLeft",up:"selectNodeUp",right:"selectNodeRight","shift+right":"activateNodeRight","shift+left":"activateNodeLeft","meta+right ctrl+right meta+left ctrl+left":"flip","shift+up":"activateNodeUp","shift+down":"activateNodeDown",down:"selectNodeDown","space f2":"editNode",f:"toggleCollapse","c meta+x ctrl+x":"cut","p meta+v ctrl+v":"paste","y meta+c ctrl+c":"copy","u meta+z ctrl+z":"undo","shift+tab":"insertIntermediate","Esc 0 meta+0 ctrl+0":"resetView","r meta+shift+z ctrl+shift+z meta+y ctrl+y":"redo","meta+plus ctrl+plus z":"scaleUp","meta+minus ctrl+minus shift+z":"scaleDown","meta+up ctrl+up":"moveUp","meta+down ctrl+down":"moveDown","ctrl+shift+v meta+shift+v":"pasteStyle",Esc:"cancelCurrentAction"},j={"[":"activateChildren","{":"activateNodeAndChildren","=":"activateSiblingNodes",".":"activateSelectedNode","/":"toggleCollapse",a:"openAttachment",i:"editIcon"},k=!0,l=this;return b.addEventListener("inputEnabledChanged",function(a,b){k=a,a&&!b&&l.focus()}),this.each(function(){var a=$(this),l=$("<div>").css({position:"relative"}).attr("data-mapjs-role","stage").appendTo(a).data({offsetX:a.innerWidth()/2,offsetY:a.innerHeight()/2,width:a.innerWidth()-20,height:a.innerHeight()-20,scale:1}).updateStage(),m=!1;a.css("overflow","auto").attr("tabindex",1),b.isEditingEnabled()&&(e||a).simpleDraggableContainer(),c?a.on("doubletap",function(a){return b.requestContextMenu(a.gesture.center.pageX,a.gesture.center.pageY)?(a.preventDefault(),a.gesture.preventDefault(),!1):void 0}).on("pinch",function(a){if(a&&a.gesture&&a.gesture.scale){a.preventDefault(),a.gesture.preventDefault();var c=a.gesture.scale;m&&(c/=m),Math.abs(c-1)<.05||(m=a.gesture.scale,b.scale("touch",c,{x:a.gesture.center.pageX-l.data("offsetX"),y:a.gesture.center.pageY-l.data("offsetY")}))}}).on("gestureend",function(){m=!1}):(a.scrollWhenDragging(b.getInputEnabled),a.on("mousedown",function(b){b.target!==a[0]&&a.css("overflow","hidden")
}),jQuery(document).on("mouseup",function(){"auto"!==a.css("overflow")&&a.css("overflow","auto")}),a.imageDropWidget(d)),MAPJS.DOMRender.viewController(b,l,c,d,f,h),_.each(i,function(c,d){a.keydown(d,function(a){k&&(a.stopImmediatePropagation(),a.preventDefault(),b[c]("keyboard"))})}),c||jQuery(window).on("resize",function(){b.resetView()}),jQuery(window).on("orientationchange",function(){g?b.centerOnNode(b.getSelectedNodeId()):b.resetView()}),jQuery(document).on("keydown",function(a){var c,d={"U+003D":"scaleUp","U+002D":"scaleDown",61:"scaleUp",173:"scaleDown"};a&&!a.altKey&&(a.ctrlKey||a.metaKey)&&(a.originalEvent&&a.originalEvent.keyIdentifier?c=d[a.originalEvent.keyIdentifier]:"MozPrintableKey"===a.key&&(c=d[a.which]),c&&k&&(a.preventDefault(),b[c]("keyboard")))}).on("wheel mousewheel",function(b){var c=b.originalEvent.deltaX||-1*b.originalEvent.wheelDeltaX;0>c&&0===a.scrollLeft()&&b.preventDefault(),c>0&&a[0].scrollWidth-a.width()-a.scrollLeft()===0&&b.preventDefault()}),a.on("keypress",function(a){if(k&&!/INPUT|TEXTAREA/.test(a&&a.target&&a.target.tagName)){var c=a.charCode||a.keyCode,d=String.fromCharCode(c),e=j[d];e?(a.preventDefault(),b[e]("keyboard")):Number(d)<=9&&Number(d)>=1&&(a.preventDefault(),b.activateLevel("keyboard",Number(d)+1))}})})};var MM=MM||{};MM.ActiveContentListener=function(a){"use strict";var b,c=observable(this),d=function(a,d){c.dispatchEvent("mm-active-content-changed",b,!1,a,d)},e=function(a,e){b&&b.removeEventListener("changed",d),b=e,c.dispatchEvent("mm-active-content-changed",b,!0),b.addEventListener("changed",d)};a.addEventListener("mapLoaded",e,999),c.getActiveContent=function(){return b},c.addListener=function(a){b&&a(b,!1),c.addEventListener("mm-active-content-changed",a)}},MM.ActiveContentResourceManager=function(a,b){"use strict";var c=this,d=b+":",e=new RegExp("^"+d);c.storeResource=function(b){return d+a.getActiveContent().storeResource(b)},c.getResource=function(b){return e.test(b)?a.getActiveContent().getResource(b.substring(d.length)):b}},MM.ActivityLog=function(a){"use strict";var b=[],c=1,d=this;observable(this),this.log=function(){var e=["log"];b.length===a&&b.shift(),b.push({id:c,ts:new Date,event:Array.prototype.join.call(arguments,",")}),c+=1,Array.prototype.slice.call(arguments).forEach(function(a){jQuery.isArray(a)?e=e.concat(a):e.push(a)}),d.dispatchEvent.apply(d,e)},this.error=function(a){d.log("Error",a),d.dispatchEvent("error",a,b)},this.getLog=b.slice.bind(b),this.timer=function(a,b){var c=Date.now();return{end:function(){d.dispatchEvent("timer",a,b,Date.now()-c)}}}},jQuery.fn.trackingWidget=function(a){"use strict";return this.each(function(){var b=jQuery(this),c=b.data("category"),d=b.data("event-type")||"",e=b.data("label")||"";b.click(function(){a.log(c,d,e)})})},MM.Alert=function(){"use strict";var a=this,b=1;observable(this),this.show=function(c,d,e){var f=b;return b+=1,a.dispatchEvent("shown",f,c,d,"flash"===e?"info":e),"flash"===e&&setTimeout(function(){a.hide(f)},3e3),f},this.hide=this.dispatchEvent.bind(this,"hidden")},jQuery.fn.alertWidget=function(a){"use strict";return this.each(function(){var b=jQuery(this);a.addEventListener("shown",function(a,c,d,e){e=e||"info",d=d||"",_.isString(c)&&(c=jQuery("<span><strong>"+c+"</strong>&nbsp;"+d+"</span>")),jQuery('<div class="alert fade in"><button type="button" class="close" data-dismiss="alert">&#215;</button></div>').addClass("alert-"+e+" alert-no-"+a).prepend(c).appendTo(b)}),a.addEventListener("hidden",function(a){b.find(".alert-no-"+a).remove()})})},jQuery.fn.anonSaveAlertWidget=function(a,b,c,d,e){"use strict";var f,g=this.find("[data-mm-role=anon-save]").detach(),h=this.find("[data-mm-role=destroyed]").detach(),i=this.find("[data-mm-role=destroyed-problem]").detach(),j=function(){return!d.getItem(e)},k=function(){f&&(a.hide(f),f=void 0)};b.addEventListener("mapSaving mapLoaded",k),b.addEventListener("mapSaved",function(b){var l=function(){k(),d.setItem(e,!0)},m=function(b,c){f&&a.hide(f);var d=b.clone();d.find("[data-mm-role=donotshow]").click(l),d.find("[data-mm-role=destroy]").click(n),f=a.show(d,"",c)},n=function(){c.destroyLastSave().then(function(){m(h,"info")},function(){m(i,"error")})};j()&&c.recognises(b)&&m(g,"success")})},jQuery.fn.atlasPrepopulationWidget=function(a,b,c,d,e){"use strict";d=d||MM.AtlasUtil.truncate,e=e||MM.AtlasUtil.sanitize;var f=this,g=function(){var g=f.find("form[data-mm-role~=atlas-metadata]"),h=a.getActiveContent(),i=h&&h.title,j=d(i,b),k=d("MindMup mind map: "+i,c),l=e(d(i,b));g.find("[name=title]").attr("placeholder",j).val(j),g.find("[name=description]").attr("placeholder",k).val(k),g.find("[name=slug]").attr("placeholder",l).val(l)};return f.on("show",function(a){this===a.target&&g()}),f},MM.AtlasUtil={truncate:function(a,b){"use strict";return a.substring(0,b)},sanitize:function(a){"use strict";var b=a.substr(0,100).toLowerCase().replace(/[^a-z0-9]+/g,"_");return"_"===b?"map":b}},$.fn.attachmentEditorWidget=function(a,b){"use strict";var c,d,e=this,f=$("<div>").addClass("modal-backdrop fade in hide").appendTo("body"),g=e.find("[data-mm-role=editor]"),h=function(){f.hide(),a.setInputEnabled(!0),e.hide(),g.html("")},i=function(){g.attr("contenteditable",!0),e.addClass("mm-editable"),g.focus(),d=!0},j=function(){e.removeClass("mm-editable"),g.attr("contenteditable",!1),g.find("a").attr("target","_blank"),d=!1,g.focus()},k=function(){var b=g.cleanHtml();b?(a.setAttachment("attachmentEditorWidget",c,{contentType:"text/html",content:b}),h()):(a.setAttachment("attachmentEditorWidget",c,!1),h())},l=function(){g.html("")},m=function(){var a=g.outerHeight(!0)-g.innerHeight()+30;g.height(e.innerHeight()-g.siblings().outerHeight(!0)-a),$("[data-role=editor-toolbar] [data-role=magic-overlay]").each(function(){var a=$(this),b=$(a.data("target"));a.css("opacity",0).css("position","absolute").offset(b.offset()).width(b.outerWidth()).height(b.outerHeight())}),f.width("100%").height("100%")},n=function(b,d){var h=d&&d.contentType;f.show(),c=b,e.show(),m(),a.setInputEnabled(!1),d?"text/html"===h&&(g.html(d&&d.content),j()):i()},o=function(){var a=["Serif","Sans","Arial","Arial Black","Courier","Courier New","Comic Sans MS","Helvetica","Impact","Lucida Grande","Lucida Sans","Tahoma","Times","Times New Roman","Verdana"],b=$("[data-role=editor-toolbar] [data-mm-role=font]");$.each(a,function(a,c){b.append($('<li><a data-edit="fontName '+c+'" style="font-family:'+c+'">'+c+"</a></li>"))}),$("[data-role=editor-toolbar] .dropdown-menu input").click(function(){return!1}).change(function(){$(this).parent(".dropdown-menu").siblings(".dropdown-toggle").dropdown("toggle")}).keydown("esc",function(){this.value="",$(this).change()}),$("[data-role=editor-toolbar] a").attr("data-category","Attachment editor toolbar").attr("data-event-type",function(){return $(this).attr("data-edit")||$(this).attr("title")||$(this).text()||"unknown"})};return b&&g.detach().prependTo(e),o(),g.wysiwyg(),e.addClass("mm-editable"),e.find("[data-mm-role=save]").click(k),e.find("[data-mm-role=close]").click(h),e.find("[data-mm-role=clear]").click(l),e.find("[data-mm-role=edit]").click(i),$(document).keydown("esc",function(){e.is(":visible")&&h()}).keydown("ctrl+s meta+s",function(a){a.altKey||e.is(":visible")&&(a.preventDefault(),k(),h())}).keydown("ctrl+return meta+return",function(){e.is(":visible")&&(d?k():i())}),$(window).bind("orientationchange resize",m),a.addEventListener("attachmentOpened",n),e},jQuery.fn.autoSaveWidget=function(a){"use strict";var b=this,c=b.find("[data-mm-role=apply]");a.addEventListener("unsavedChangesAvailable",function(){b.modal("show")}),b.on("shown",function(){c.focus()}),c.click(function(){a.applyUnsavedChanges(),b.modal("hide")}),b.find("[data-mm-role=discard]").click(function(){a.discardUnsavedChanges(),b.modal("hide")})},MM.AutoSave=function(a,b,c,d,e){"use strict";var f,g,h,i,j,k="auto-save-",l=this,m=[],n=function(a){var c=b.getItem(k+a);c&&l.dispatchEvent("unsavedChangesAvailable",a)},o=function(a,d){var f=k+d,g=function(){try{return b.setItem(f,m),!0}catch(a){return!1}},h=function(){j||(j=c.show("Unable to back up unsaved changes!","Please save this map as soon as possible to avoid losing unsaved information.","warning"))};m.push(a),g()||(b.removeKeysWithPrefix(k)+b.removeKeysWithPrefix(e)===0?h():g()||h())},p=function(a,b){m=[],h=function(a,c){o({cmd:a,args:c},b)},i=function(a,c){o({cmd:"storeResource",args:[a,c]},b)},a.addEventListener("changed",h),a.addEventListener("resourceStored",i)},q=function(){j&&c.hide(j),j=void 0},r=function(a,b,c){h&&g&&(g.removeEventListener("changed",h),g.removeEventListener("resourceStored",i)),!a||c&&c.autoSave||(f=a,g=b,q(),n(a),p(b,a))};observable(this),e=e||"clipboard",l.applyUnsavedChanges=function(){var a=b.getItem(k+f);a&&(d.pause(),a.forEach(function(a){g.execCommand(a.cmd,a.args)}),d.resume())},l.discardUnsavedChanges=function(){m=[],b.remove(k+f)},a.addEventListener("mapSaved",function(a,b){q(),(a===f||b===g)&&l.discardUnsavedChanges(),a!==f&&r(a,b)}),a.addEventListener("mapLoaded",r)},MM.Bookmark=function(a,b,c){"use strict";var d=observable(this),e=!1,f=[],g=function(){b&&c&&b.setItem(c,f)};b&&c&&(f=b.getItem(c)||[]),a.addEventListener("mapSaved",function(a,b){var c=d.canPin();e={mapId:a,title:b.title},d.store({mapId:a,title:b.title}),c!==d.canPin()&&d.dispatchEvent("pinChanged")}),a.addEventListener("mapLoaded",function(a,b){var c=d.canPin();e={mapId:a,title:b.title},c!==d.canPin()&&d.dispatchEvent("pinChanged")}),d.store=function(a){if(!a.mapId||!a.title)throw new Error("Invalid bookmark");var b=_.find(f,function(b){return b.title===a.title||b.mapId===a.mapId});b?(b.mapId=a.mapId,b.title=a.title):f.push(_.clone(a)),g(),d.dispatchEvent("added",a)},d.remove=function(a,b){var c,e;for(b=b||!1,c=0;c<f.length;c++)if(f[c].mapId===a)return e=f.splice(c,1)[0],g(),void d.dispatchEvent("deleted",e,b)},d.list=function(){return _.clone(f).reverse()},d.links=function(a){return a=a||30,_.map(d.list(),function(b){return{title:b.title,shortTitle:b.title.length>a?b.title.substr(0,a)+"...":b.title,mapId:b.mapId}})},d.pin=function(){e&&d.store(e)},d.canPin=function(){return e&&(0===f.length||_.every(f,function(a){return a.mapId!==e.mapId}))}},jQuery.fn.bookmarkWidget=function(a,b,c){"use strict";return this.each(function(){var d,e=jQuery(this),f=e.find(".template").detach(),g=e.find("[data-mm-role=bookmark-pin]"),h=e.children().filter("[data-mm-role=bookmark]").clone(),i=function(){var b,d,i,j=a.links();e.children().filter("[data-mm-role=bookmark]").remove(),g.parent().hide(),a.canPin()&&g.parent().show(),j.length?j.slice(0,10).forEach(function(g){i=f.clone().show().attr("data-mm-role","bookmark").appendTo(e),b=i.find("a"),d=b.children().detach(),b.click(function(){c.loadMap(g.mapId)}),b.text(g.shortTitle).addClass("repo-"+g.mapId[0]),d.appendTo(b),i.find("[data-mm-role=bookmark-delete]").click(function(){return a.remove(g.mapId),e.parents(".dropdown").find(".dropdown-toggle").dropdown("toggle"),!1})}):e.append(h.clone())};g.click(function(){a.pin()}),a.addEventListener("added",i),a.addEventListener("pinChanged",i),a.addEventListener("deleted",function(c,e){i(),b&&!e&&(d&&b.hide(d),d=b.show("Bookmark Removed.",c.title+' was removed from the list of your maps. <a href="#"> Undo </a> ',"success"),jQuery(".alert-no-"+d).find("a").click(function(){a.store(c),b.hide(d)}))}),i()})},jQuery(function(a){"use strict";var b=function(b){var c=a.Deferred(),d=new FileReader;return d.onload=function(a){c.resolve(a.target.result)},d.onerror=c.reject,d.onprogress=c.notify,d.readAsDataURL(b),c.promise()};a.fn.cleanHtml=function(){var b=a(this).html();return b&&b.replace(/(<br>|\s|<div><br><\/div>|&nbsp;)*$/,"")},a.fn.wysiwyg=function(c){var d,e,f=this,g=function(){e.activeToolbarClass&&a(e.toolbarSelector).find(".btn[data-"+e.commandRole+"]").each(function(){var b=a(this).data(e.commandRole);document.queryCommandState(b)?a(this).addClass(e.activeToolbarClass):a(this).removeClass(e.activeToolbarClass)})},h=function(a,b){var c=a.split(" "),d=c.shift(),e=c.join(" ")+(b||"");document.execCommand(d,0,e),g()},i=function(b){a.each(b,function(a,b){f.keydown(a,function(a){f.attr("contenteditable")&&f.is(":visible")&&(a.preventDefault(),a.stopPropagation(),h(b))}).keyup(a,function(a){f.attr("contenteditable")&&f.is(":visible")&&(a.preventDefault(),a.stopPropagation())})})},j=function(){var a=window.getSelection();return a.getRangeAt&&a.rangeCount?a.getRangeAt(0):void 0},k=function(){d=j()},l=function(){var a,b=window.getSelection();if(d){try{b.removeAllRanges()}catch(c){a=document.body.createTextRange(),a.select(),document.selection.empty()}b.addRange(d)}},m=function(c){f.focus(),a.each(c,function(c,d){/^image\//.test(d.type)&&a.when(b(d)).done(function(a){h("insertimage",a)})})},n=function(a,b){l(),document.execCommand("hiliteColor",0,b||"transparent"),k(),a.data(e.selectionMarker,b)},o=function(b,c){b.find("a[data-"+c.commandRole+"]").click(function(){l(),f.focus(),h(a(this).data(c.commandRole)),k()}),b.find("[data-toggle=dropdown]").click(l),b.find("input[type=text][data-"+c.commandRole+"]").on("webkitspeechchange change",function(){var b=this.value;this.value="",l(),b&&(f.focus(),h(a(this).data(c.commandRole),b)),k()}).on("focus",function(){var b=a(this);b.data(c.selectionMarker)||(n(b,c.selectionColor),b.focus())}).on("blur",function(){var b=a(this);b.data(c.selectionMarker)&&n(b,!1)}),b.find("input[type=file][data-"+c.commandRole+"]").change(function(){l(),"file"===this.type&&this.files&&this.files.length>0&&m(this.files),k(),this.value=""})},p=function(){f.on("dragenter dragover",!1).on("drop",function(a){var b=a.originalEvent.dataTransfer;a.stopPropagation(),a.preventDefault(),b&&b.files&&b.files.length>0&&m(b.files)})};return e=a.extend({},a.fn.wysiwyg.defaults,c),i(e.hotKeys),p(),o(a(e.toolbarSelector),e),f.attr("contenteditable",!0).on("mouseup keyup mouseout",function(){k(),g()}),a(window).bind("touchend",function(a){var b=f.is(a.target)||f.has(a.target).length>0,c=j(),d=c&&c.startContainer===c.endContainer&&c.startOffset===c.endOffset;(!d||b)&&(k(),g())}),this},a.fn.wysiwyg.defaults={hotKeys:{"ctrl+b meta+b":"bold","ctrl+i meta+i":"italic","ctrl+u meta+u":"underline","ctrl+z meta+z":"undo","ctrl+y meta+y meta+shift+z":"redo","ctrl+l meta+l":"justifyleft","ctrl+r meta+r":"justifyright","ctrl+e meta+e":"justifycenter","ctrl+j meta+j":"justifyfull","shift+tab":"outdent",tab:"indent"},toolbarSelector:"[data-role=editor-toolbar]",commandRole:"edit",activeToolbarClass:"btn-info",selectionMarker:"edit-focus-marker",selectionColor:"darkgrey"}}),jQuery.fn.classCachingWidget=function(a,b){"use strict";var c=jQuery(this),d=a+"-"+c.selector;return jQuery(window).unload(function(){b[d]=c.attr("class")}),c.addClass(b[d]),this},MM.CollaborationModel=function(a){"use strict";var b=observable(this),c=!1,d=function(a,d){c&&d&&b.dispatchEvent("myFocusChanged",a)},e=function(a,d){if(d&&c){var e=function(c){c&&b.dispatchEvent("collaboratorDidEdit",c,a)};b.dispatchEvent("collaboratorRequestedForContentSession",d,e)}};b.collaboratorFocusChanged=function(a){c&&b.dispatchEvent("collaboratorFocusChanged",a)},b.collaboratorPresenceChanged=function(a,d){if(c){var e=d?"collaboratorJoined":"collaboratorLeft";b.dispatchEvent(e,a,d)}},b.start=function(a){c=!0,_.size(a)>0&&_.each(a,b.collaboratorFocusChanged)},b.showCollaborator=function(c){b.dispatchEvent("sessionFocusRequested",c.sessionId,a.centerOnNode)},b.stop=function(){b.dispatchEvent("stopped"),c=!1},a.addEventListener("nodeSelectionChanged",d),a.addEventListener("nodeTitleChanged",e)},jQuery.fn.collaboratorListWidget=function(a,b){"use strict";return jQuery(this).each(function(){var c=jQuery(this),d=c.find("[data-mm-role~=collab-list]"),e=d.find("[data-mm-role~=template]").detach(),f=function(a){return d.find("[mm-session-id="+a+"]")},g=function(g){if(!(f(g.sessionId).size()>0)){var h=e.clone().appendTo(d).attr("mm-session-id",g.sessionId);h.find("[data-mm-role~=collaborator-name]").text(g.name),h.find("[data-mm-role~=collaborator-photo]").attr("src",g.photoUrl).css("border-color",g.color),h.find('[data-mm-role~="collaborator-selector"]').on("click tap",function(){a.showCollaborator(g)}),c.addClass(b)}},h=function(a){f(a.sessionId).remove(),0===d.children().size()&&c.removeClass(b)};c.removeClass(b),a.addEventListener("collaboratorFocusChanged collaboratorJoined",g),a.addEventListener("collaboratorLeft",h),a.addEventListener("stopped",function(){c.removeClass(b),d.empty()})})},MM.deferredImageLoader=function(a){"use strict";var b=jQuery.Deferred(),c=new Image;return c.onload=function(){b.resolve(jQuery(c))},c.src=a,b.promise()},jQuery.fn.collaboratorPhotoWidget=function(a,b,c){"use strict";var d=jQuery(this),e=function(a,b){var c=d.nodeWithId(a);c&&c.length>0&&b.appendTo(c).css({bottom:-1*Math.round(b.height()/2),right:-1*Math.round(b.width()/2)})},f=function(a){return d.find("."+c+"[data-mm-collaborator-id="+a+"]")},g=function(a){var d=f(a.sessionId);d&&d.length>0?e(a.focusNodeId,d):b(a.photoUrl).then(function(b){0===f(a.sessionId).length&&(b.addClass(c).attr("data-mm-collaborator-id",a.sessionId).css("border-color",a.color).tooltip({title:a.name,placement:"bottom",container:"body"}),e(a.focusNodeId,b))})},h=function(a){f(a.sessionId).remove()};return a.addEventListener("stopped",function(){d.find("."+c).remove()}),a.addEventListener("collaboratorFocusChanged collaboratorJoined",g),a.addEventListener("collaboratorLeft",h),d},jQuery.fn.collaboratorSpeechBubbleWidget=function(a,b){"use strict";var c=b||3e3;return this.each(function(){var b,d=jQuery(this),e=function(){a.showCollaborator(b)},f=d.find("[data-mm-role=collaborator-photo]"),g=d.find("[data-mm-role=popover-content-template]").detach(),h=d.find("[data-mm-role=popover-title-template]").detach(),i=function(a,b){var c=g.clone();return c.find("[data-mm-role=popover-content]").text(a),b&&c.find("[data-mm-role=popover-content]").addClass(b),c.html()},j=function(a){return h.find("[data-mm-role=popover-title]").text(a),h.html()},k=_.throttle(function(a,e,g){b=a,f.popover("destroy"),f.attr("src",a.photoUrl),f.css("border-color",a.color),f.popover({title:j(a.name),content:i(e,g),placement:"right",trigger:"manual",animation:!0,html:!0}),d.fadeIn(200,function(){setTimeout(function(){f.popover("destroy"),d.fadeOut()},c)}),f.popover("show")},c+700,{trailing:!1}),l=function(a,b){var c=b&&b.title&&b.title.trim(),d=c?"":"muted",e=c||"removed node content";k(a,e,d)},m=function(a){k(a,"joined the session","muted")},n=function(a){k(a,"left the session","muted")};f.on("click tap",e),a.addEventListener("collaboratorDidEdit",l),a.addEventListener("collaboratorJoined",m),a.addEventListener("collaboratorLeft",n)})},$.fn.commandLineWidget=function(a,b){"use strict";var c=this;return c.keydown(a,function(a){b.getInputEnabled()&&a&&(a.preventDefault(),a.stopPropagation())}),c.keyup(a,function(a){if(b.getInputEnabled()){var d,e=function(a){var b=a&&Color(a.toLowerCase()),c=b&&(b.hexString().toUpperCase()===a.toUpperCase()||b.keyword()&&("BLACK"!==b.keyword().toUpperCase()||"BLACK"===a.toUpperCase()));return c?b:a&&"#"!==a[0]?e("#"+a):!1},f=function(){d&&d.remove(),b.setInputEnabled(!0)},g=function(){var a=d&&d.val(),c=e(a.toLowerCase());f(),c&&b.updateStyle("cmdline","background",c.hexString())},h=["aliceblue","antiquewhite","aqua","aquamarine","azure","beige","bisque","black","blanchedalmond","blue","blueviolet","brown","burlywood","cadetblue","chartreuse","chocolate","coral","cornflowerblue","cornsilk","crimson","cyan","darkblue","darkcyan","darkgoldenrod","darkgrey","darkgreen","darkkhaki","darkmagenta","darkolivegreen","darkorange","darkorchid","darkred","darksalmon","darkseagreen","darkslateblue","darkslategrey","darkturquoise","darkviolet","deeppink","deepskyblue","dimgrey","dodgerblue","firebrick","floralwhite","forestgreen","fuchsia","gainsboro","ghostwhite","gold","goldenrod","grey","green","greenyellow","honeydew","hotpink","indianred","indigo","ivory","khaki","lavender","lavenderblush","lawngreen","lemonchiffon","lightblue","lightcoral","lightcyan","lightgoldenrodyellow","lightgrey","lightgreen","lightpink","lightsalmon","lightseagreen","lightskyblue","lightslategrey","lightsteelblue","lightyellow","lime","limegreen","linen","magenta","maroon","mediumaquamarine","mediumblue","mediumorchid","mediumpurple","mediumseagreen","mediumslateblue","mediumspringgreen","mediumturquoise","mediumvioletred","midnightblue","mintcream","mistyrose","moccasin","navajowhite","navy","oldlace","olive","olivedrab","orange","orangered","orchid","palegoldenrod","palegreen","paleturquoise","palevioletred","papayawhip","peachpuff","peru","pink","plum","powderblue","purple","red","rosybrown","royalblue","saddlebrown","salmon","sandybrown","seagreen","seashell","sienna","silver","skyblue","slateblue","slategrey","snow","springgreen","steelblue","tan","teal","thistle","tomato","turquoise","violet","wheat","white","whitesmoke","yellow","yellowgreen"];a&&(a.preventDefault(),a.stopPropagation()),b.setInputEnabled(!1),d=$('<input type="text" placeholder="Type a color name or hex…">').css("position","absolute").css("z-index","9999").appendTo(c).css("top","30%").css("left","40%").css("width","20%").css("border-width","5px").focus().blur(f).keyup("Esc",f).change(g).typeahead({source:h,highlighter:function(a){return'<span style="background-color:'+a+';" >&nbsp;</span>&nbsp;'+a}})}}),c},jQuery.fn.contextMenuWidget=function(a){"use strict";var b=this.find("[data-mm-context-menu]").clone(),c=jQuery('<ul class="dropdown-menu">').css("position","absolute").css("z-index","999").hide().appendTo("body"),d=function(){c.is(":visible")&&c.hide(),jQuery(document).off("click touch keydown",d)},e={},f=function(a){if(!e[a]){var b=jQuery('<li class="dropdown-submenu"><a tabindex="-1" href="#"></a><ul class="dropdown-menu"></ul></li>').appendTo(c);b.find("a").text(a),e[a]=b.find("ul")}return e[a]};return b.find("a").attr("data-category","Context Menu"),_.each(b,function(a){var b=jQuery(a).attr("data-mm-context-menu");b?f(b).append(a):c.append(a)}),a.addEventListener("mapMoveRequested mapScaleChanged nodeSelectionChanged nodeEditRequested mapViewResetRequested",d),a.addEventListener("contextMenuRequested",function(a,b,e){c.css("left",b).css("top",e-10).css("display","block").show(),c.offset().top+c.outerHeight()>jQuery(window).height()-20&&c.css("top",jQuery(window).height()-20-c.outerHeight()),c.offset().left+2*c.outerWidth()>jQuery(window).width()-20?c.find(".dropdown-submenu").addClass("pull-left"):c.find(".dropdown-submenu").removeClass("pull-left"),c.offset().left+c.outerWidth()>jQuery(window).width()-20&&c.css("left",jQuery(window).width()-20-c.outerWidth()),jQuery(document).off("click",d),c.on("mouseenter",function(){jQuery(document).off("click",d)}),c.on("mouseout",function(){jQuery(document).on("click",d)}),jQuery(document).on("touch keydown",d)}),c.on("contextmenu",function(a){return a.preventDefault(),a.stopPropagation(),!1}),c},MM.CustomStyleController=function(a,b){"use strict";var c,d=this,e=jQuery('<style id="customStyleCSS" type="text/css"></style>').appendTo("body"),f=function(a){var d=a.getAttr("customCSS");d!==c&&(c=d,e.text(c||""),jQuery(".mapjs-node").data("nodeCacheMark",""),b.rebuildRequired())};d.getStyle=function(){return c||""},d.setStyle=function(b){var c=a.getActiveContent();c.updateAttr(c.id,"customCSS",b)},a.addListener(f)},jQuery.fn.customStyleWidget=function(a){"use strict";var b=this,c=b.find("[data-mm-role=style-input]"),d=b.find("[data-mm-role=save]");b.on("show",function(){c.val(a.getStyle())}),d.click(function(){a.setStyle(c.val())})},MM.EmbeddedMapUrlGenerator=function(a){"use strict";var b=this;b.buildMapUrl=function(b){var c=b&&b[0],d=c&&a[c],e=jQuery.Deferred();return d?e.resolve((d.prefix||"")+b.slice(d.remove)+(d.postfix||"")):e.reject(),e.promise()}},MM.Extensions=function(a,b,c,d){"use strict";var e=[],f=function(a,b,c,d,e){c.forEach(function(c){var f,g=a.getElementsByTagName(b)[0];f=a.createElement(b),f.src=("file:"===document.location.protocol?"http:":"")+c,f.onload=d,f.onerror=e,g.parentNode.insertBefore(f,g)})},g=function(a){return _.flatten(_.reject(_.map(a,function(a){return MM.Extensions.config[a]&&MM.Extensions.config[a].script.split(" ")}),function(a){return!a}))};a[b]&&(e=a[b].split(" ")),this.requiredExtension=function(a){var b,c;for(b in MM.Extensions.config)if(c=MM.Extensions.config[b],c.providesMapId&&c.providesMapId(a))return b},this.scriptsToLoad=function(a){var b=this.requiredExtension(a),d=b?_.union(e,b):e,f=g(d);return _.map(f,function(a){return/^http[s]?:/.test(a)?a:c.publicUrl+a})},this.isActive=function(a){return _.contains(e,a)},this.setActive=function(c,f){e=f?_.union(e,[c]):_.without(e,c),a[b]=e.join(" "),d&&d.activityLog&&d.activityLog.log("Extensions",c,"act-"+f)},this.load=function(a){var b,e,g=jQuery.Deferred(),h=this.scriptsToLoad(a);return MM.Extensions.components=d,MM.Extensions.mmConfig=c,f(document,"script",c.scriptsToLoadAsynchronously.split(" ")),MM.Extensions.pendingScripts=_.invert(h),f(document,"script",h,function(){delete MM.Extensions.pendingScripts[jQuery(this).attr("src")]},function(){d.alert.hide(b),window.clearInterval(e),d.alert.show("A required extension failed to load due to a network error.",'You may continue to use the site but some features may not be available. Please reload the page when you reconnect to the Internet to activate all the features. If the error persists, please contact us at <a href="mailto:contact@mindmup.com">contact@mindmup.com</a>',"error"),g.resolve()}),_.isEmpty(MM.Extensions.pendingScripts)?g.resolve():(b=d.alert.show('<i class="icon-spinner icon-spin"></i>&nbsp;Please wait, loading extensions...<span data-mm-role="num-extensions"></span>'),e=window.setInterval(function(){_.isEmpty(MM.Extensions.pendingScripts)?(d.alert.hide(b),window.clearInterval(e),g.resolve()):jQuery("[data-mm-role=num-extensions]").text(_.size(MM.Extensions.pendingScripts)+" remaining")},1e3)),g.promise()}},MM.Extensions.config={"goggle-collaboration":{name:"Realtime collaboration",script:"/e/google-collaboration.js",icon:"icon-group",doc:"http://blog.mindmup.com/p/realtime-collaboration.html",desc:"Realtime collaboration on a map, where several people can concurrently change it and updates are shown to everyone almost instantly. Collaboration is persisted using Google Drive.",providesMapId:function(a){"use strict";return/^cg/.test(a)}},progress:{name:"Progress",script:"/e/progress.js",icon:"icon-dashboard",doc:"http://blog.mindmup.com/p/monitoring-progress.html",desc:"Progress allows you to manage hierarchies of tasks faster by propagating statuses to parent nodes. For example, when all sub-tasks are completed, the parent task is marked as completed automatically.",aggregateAttributeName:"progress-statuses",measurementsConfigName:"measurements-config",isActiveOnMapContent:function(a){"use strict";return a.getAttr(MM.Extensions.config.progress.aggregateAttributeName)}},"straight-lines":{name:"Straight lines",script:"/e/straight-lines.js",icon:"icon-reorder",doc:"http://blog.mindmup.com/p/straight-lines.html",desc:"This extension converts funky curve connectors into straight lines, which makes it clearer to see what connects to what on large maps"},github:{name:"Github",script:"/e/github.js",icon:"icon-github",doc:"http://www.github.com",desc:"Store your maps on Github",providesMapId:function(a){"use strict";return/^h/.test(a)}},dropbox:{name:"Dropbox",script:"https://www.dropbox.com/static/api/1/dropbox-datastores-0.1.0-b3.js /e/dropbox.js",icon:"icon-dropbox",doc:"http://blog.mindmup.com/p/working-with-dropbox.html",desc:"Store your maps on Dropbox",providesMapId:function(a){"use strict";return/^d1/.test(a)}}},jQuery.fn.extensionsWidget=function(a,b,c){"use strict";var d,e,f=this,g=function(a,b,e,f){d=c.show(a,'<a href="#" data-mm-role="alert-callback">'+b+"</a>",e),jQuery("[data-mm-role=alert-callback]").click(function(){c.hide(d),f()})},h=f.find("[data-mm-role=ext-list]"),i=h.find("[data-mm-role=template]").hide().clone(),j=!1;return _.each(MM.Extensions.config,function(b,c){var d=i.clone().appendTo(h).show();d.find("[data-mm-role=title]").html("&nbsp;"+b.name).addClass(b.icon),d.find("[data-mm-role=doc]").attr("href",b.doc),d.find("[data-mm-role=desc]").prepend(b.desc),d.find("input[type=checkbox]").attr("checked",a.isActive(c)).change(function(){a.setActive(c,this.checked),j=!0})}),f.on("hidden",function(){j&&(e?window.location="/map/"+e:location.reload()),e=void 0}),b.addEventListener("mapIdNotRecognised",function(b){var h=a.requiredExtension(b);c.hide(d),b&&"o"===b[0]||(h?g("This map requires an extension to load!","Click here to enable the "+MM.Extensions.config[h].name+" extension","warning",function(){e=b,f.modal("show")}):d=c.show("The URL is unrecognised!","it might depend on a custom extension that is not available to you.","error"))}),b.addEventListener("mapLoaded",function(b,h){var i=_.filter(MM.Extensions.config,function(b,c){return b.isActiveOnMapContent&&b.isActiveOnMapContent(h)&&!a.isActive(c)}),j=i.length>1?"s":"";c.hide(d),i.length&&g("This map uses additional extensions!","Click here to enable the "+_.map(i,function(a){return a.name}).join(", ")+" extension"+j,"warning",function(){e=b,f.modal("show")})}),f},$.fn.file_reader_upload=function(a,b,c,d){"use strict";var e,f,g=this,h=window.FileReader&&new FileReader;return d=d||["mup","mm"],h?(a=a||function(a){console.log("Reading",a)},b=b||function(a){console.log("Read",a)},c=c||function(a){console.log("Read error",a)},h.onload=function(a){b(a.target.result,f)},h.onerror=function(a){c("Error reading file",a)},h.onloadstart=function(){a(e)},g.change(function(){var a=this.files[0];return e=a.name,f=e.split(".").pop(),_.contains(d,f)?(h.readAsText(a,"UTF-8"),void g.val("")):void c("unsupported format "+f)}),g):g},MM.FileSystemMapSource=function(a,b){"use strict";var c=this,d="application/json",e=function(a,c){var e,f;return c===d?e="string"==typeof a?JSON.parse(a):a:"application/octet-stream"===c?e=JSON.parse(a):("application/x-freemind"===c||"application/vnd-freemind"===c)&&(e=MM.freemindImport(a)),f=MAPJS.content(e),b&&b(f),f},f=function(a){return/\.mm$/.test(a)?"application/x-freemind":/\.mup$/.test(a)?"application/json":"application/octet-stream"};c.loadMap=function(b,c){var d=jQuery.Deferred(),g={"application/json":!0,"application/octet-stream":!0,"application/x-freemind":!1,"application/vnd-freemind":!1};return a.loadMap(b,c).then(function(a,b,c,h,i){if(!c&&i&&(c=f(i)),h=jQuery.extend({editable:g[c]},h),"application/vnd.mindmup.collab"===c)return d.reject("map-load-redirect","c"+b).promise();if(void 0===g[c])d.reject("format-error","Unsupported format "+c);else try{d.resolve(e(a,c),b,h)}catch(j){d.reject("format-error","File content not in correct format for this file type")}},d.reject,d.notify),d.promise()},c.saveMap=function(b,c,d){var e=function(a){return a?a.replace(/\/|\t|\n|\r/g," "):void 0},f=jQuery.Deferred(),g=JSON.stringify(b,null,2),h=MM.navigationEscape(e(b.title))+".mup";return a.saveMap(g,c,h,!!d).then(f.resolve,f.reject,f.notify),f.promise()},c.description=a.description,c.recognises=a.recognises},jQuery.fn.floatingToolbarWidget=function(){"use strict";return this.each(function(){var a=jQuery(this);a.draggable({containment:"window"})})},MM.freemindImport=function(a,b,c){"use strict";var d,e=function(a,b){var c,d={},e=function(a){return $("<div>").append(a).html()};return a.attr("BACKGROUND_COLOR")&&(d.style={background:a.attr("BACKGROUND_COLOR")}),(b&&b.collapsed||"true"===a.attr("FOLDED"))&&(d.collapsed="true"),c=a.children("richcontent").find("body"),c.length>0&&(d.attachment={contentType:"text/html",content:e(c.children())}),d},f=function(a,b){var d=$(a),g={title:d.attr("TEXT")||""},h=d.children("node"),i=e(d,b),j=_.map(h,function(a){return f(a,i)}),k={},l=1;return _.size(i)>0&&(g.attr=i),j.length>0?(_.each(j,function(a){var b="left"===$(h[l-1]).attr("POSITION")?-1:1;k[b*l]=a,l+=1}),g.ideas=k):g.attr&&g.attr.collapsed&&delete g.attr.collapsed,c&&c(),g
},g=$($.parseXML(a));return b&&b(g.find("node").length),d=f(g.find("map").children("node").first()),d.formatVersion=2,d},MM.freemindExport=function(a){"use strict";var b=function(a){var c=escape(a.title).replace(/%([0-9A-F][0-9A-F])/g,"&#x$1;").replace(/%u([0-9A-F][0-9A-F][0-9A-F][0-9A-F])/g,"&#x$1;");return'<node ID="'+a.id+'" TEXT="'+c+'">'+(_.size(a.ideas)>0?_.map(_.sortBy(a.ideas,function(a,b){return parseFloat(b)}),b).join(""):"")+"</node>"};return'<map version="0.7.1">'+b(a)+"</map>"},MM.GoldApi=function(a,b,c,d){"use strict";var e,f,g=this,h="GoldApi",i=function(a){var b=["not-authenticated","invalid-args","server-error","user-exists","email-exists"];return _.contains(b,a)?a:"network-error"},j=function(b,c,d,e){var f=jQuery.Deferred(),h=function(a){var c=_.extend({},d,{license:JSON.stringify(a)});e&&e!==a.account?f.reject("not-authenticated"):g.exec(b,c).then(function(b){f.resolve(b,a.account)},f.reject)};return a.retrieveLicense(c).then(h,f.reject),f.promise()};g.exec=function(a,d){var e=jQuery.Deferred(),f=function(b){var d=b.responseText;c.log(h,"error",a+":"+d),e.reject(i(d))},g=c.timer(h,a),j=new FormData,k={"license/register":"json","file/export_config":"json","file/upload_config":"json","file/echo_config":"json","license/subscription":"json","license/request_license_using_code":"json"};return j.append("api_version","3"),d&&_.each(d,function(a,b){j.append(b,a)}),jQuery.ajax({url:b+"/"+a,dataType:k[a],data:j,processData:!1,contentType:!1,type:"POST"}).then(e.resolve,f).always(g.end),e.promise()},g.register=function(b,c){var d=jQuery.Deferred();return g.exec("license/register",{to_email:c,account_name:b}).then(function(b){b.license&&a.storeLicense(b.license),d.resolve(b)},d.reject,d.notify),d.promise()},g.getSubscription=function(){var b=a.getLicense();return g.exec("license/subscription",{license:JSON.stringify(b)})},g.cancelSubscription=function(){var b=a.getLicense();return g.exec("license/cancel_subscription",{license:JSON.stringify(b)})},g.generateExportConfiguration=function(b){var c=a.getLicense();return g.exec("file/export_config",{license:JSON.stringify(c),format:b})},g.generateEchoConfiguration=function(b,c){var d=a.getLicense();return g.exec("file/echo_config",{license:JSON.stringify(d),format:b,contenttype:c})},g.requestCode=function(a){return e=MM.onetimePassword(),f=a,g.exec("license/request_code",{identifier:a,one_time_pw:e})},g.restoreLicenseWithCode=function(b){var c=jQuery.Deferred();return e&&f?g.exec("license/request_license_using_code",{identifier:f,one_time_pw:e,code:b}).then(function(b){a.storeLicense(b),c.resolve()},c.reject):c.reject("no-code-requested"),c.promise()},g.listFiles=function(a){var b=jQuery.Deferred(),c=function(a,c){var d=jQuery(a),e=[];d.find("Contents").each(function(){var a=jQuery(this),b=a.children("Key").text(),c=b.indexOf("/")+1;e.push({modifiedDate:a.children("LastModified").text(),title:b.slice(c)})}),b.resolve(e,c)};return j("file/list",a).then(c,b.reject),b.promise()},g.generateSaveConfig=function(a){return j("file/upload_config",a)},g.fileUrl=function(a,b,c,e){return e?j("file/url",a,{file_key:encodeURIComponent(c)},b):jQuery.Deferred().resolve("https://"+d+".s3.amazonaws.com/"+b+"/"+encodeURIComponent(c)).promise()},g.exists=function(b){var c=jQuery.Deferred(),d=a.getLicense();return d?g.exec("file/exists",{license:JSON.stringify(d),file_key:encodeURIComponent(b)}).then(function(a){var b=jQuery(a);c.resolve(b.find("Contents").length>0)},c.reject):c.reject("not-authenticated"),c.promise()},g.deleteFile=function(b){var c=jQuery.Deferred(),d=a.getLicense();return d?g.exec("file/delete",{license:JSON.stringify(d),file_key:b}).then(c.resolve,c.reject):c.reject("not-authenticated"),c.promise()}},MM.onetimePassword=function(){"use strict";var a=function(){var a=1+Math.random();return(65536*a||0).toString(16).substring(1)};return a()+"-"+a()},jQuery.fn.mmUpdateInputField=function(){"use strict";return this.each(function(){var a=jQuery(this),b="form[data-mm-role="+a.data("mm-form")+'] [data-mm-role="'+a.data("mm-form-field")+'"]',c=jQuery(b),d='[data-mm-role="form-input-updater"][data-mm-form="'+a.data("mm-form")+'"][data-mm-form-field="'+a.data("mm-form-field")+'"]';c.attr("value",a.val()),jQuery(d).not(a).val(a.val())})},jQuery.fn.goldLicenseEntryWidget=function(a,b,c,d){"use strict";d=d||window;var e,f,g=this,h=!1,i=g.find("[data-mm-role~=remove]"),j=function(a,b){b?c.log("Gold",a,b):c.log("Gold",a)},k=function(){var b=a.getLicense(),c=b&&b.account||"";o("payment-complete"),g.find("[data-mm-role~=account-name]").val(c).text(c)},l=function(b){var c=b&&b.expiry,d=new Date(1e3*c),e=d&&d.toDateString()||"",f=a.getLicense(),h=f&&f.account||"",i=b.provider?"-"+b.provider:"";o("license-"+b.status+i),g.find("[data-mm-role~=account-name]").val(h).text(h),g.find("[data-mm-role~=expiry-date]").val(e).text(e),_.each(b,function(a,b){g.find("[data-mm-role~=license-"+b+"]").text(a)}),b.actions&&_.each(b.actions,function(a){g.find("[data-mm-role~=action-"+a+"]").show()})},m=function(){var c=a.getLicense(),d=function(a){"license-purchase-required"===a?o("license-purchase-required"):("view-license"===e||"loading-subscription"===e)&&o("not-authenticated"===a?"invalid-license":"license-server-unavailable")},f=function(a){var b=a&&a.status;b?l(a):d("not-authenticated")},h=c&&c.account||"";g.find("[data-mm-role~=account-name]").val(h).text(h),c?(g.find("[data-mm-role~=license-text]").val(JSON.stringify(c)),g.find("[data-mm-role~=account-name]").val(c.account).text(c.account),"view-license"===e&&(o("loading-subscription"),b.getSubscription().then(f,d))):(g.find("[data-mm-role~=license-text]").val(""),g.find("[data-mm-role~=account-name]").val("").text(""),g.find("[data-mm-role~=expiry-date]").val("").text(""),g.find("[data-mm-role~=subscription-name]").val("").text(""),g.find("[data-mm-role~=renewal-price]").val("").text("")),g.find("[data-mm-role~=form-input-updater]").mmUpdateInputField()},n=!1,o=function(a){var c=g.find("[data-mm-section~="+a+"]");n&&window.clearInterval(n),f=e,e=a,j("license-section",a),g.find("[data-mm-section]").not("[data-mm-section~="+a+"]").hide(),c.show(),c.data("mm-poll-for-subscription")&&(n=window.setInterval(function(){b.getSubscription().then(t)},5e3))},p=function(a,b){return b?a?"unauthorised-license":"license-required":a?"view-license":"no-license"},q=function(b){var c=a.getLicense(),d=c&&c.account||b.email;g.find("[data-mm-role=license-capacity]").text(b.capacity),b.license&&g.find("[data-mm-role~=license-text]").val(b.license),b["grace-period"]?(g.find("[data-mm-role=license-grace-period]").text(b["grace-period"]),g.find("[data-mm-role=license-has-grace-period]").show()):g.find("[data-mm-role=license-has-grace-period]").hide(),g.find("[data-mm-role=license-email]").text(b.email),g.find("[data-mm-role=account-name]").text(d).val(d),o("registration-success")},r=function(a){g.find("[data-mm-section=registration-fail] .alert [data-mm-role]").hide();var b=g.find("[data-mm-section=registration-fail] .alert [data-mm-role~="+a+"]");b.length>0?b.show():g.find("[data-mm-section=registration-fail] .alert [data-mm-role~=network-error]").show(),o("registration-fail")},s=function(){var a=g.find("[data-mm-section=register] form"),c=a.find("input[name=email]"),d=a.find("input[name=account-name]"),e=a.find("input[name=terms]");return/^[^@]+@[^@.]+\.[^@]+[^@.]$/.test(c.val())?c.parents("div.control-group").removeClass("error"):c.parents("div.control-group").addClass("error"),/^[a-z][a-z0-9]{3,20}$/.test(d.val())?d.parents("div.control-group").removeClass("error"):d.parents("div.control-group").addClass("error"),e.prop("checked")?e.parents("div.control-group").removeClass("error"):e.parents("div.control-group").addClass("error"),a.find("div.control-group").hasClass("error")?!1:(b.register(d.val(),c.val()).then(q,r),void o("registration-progress"))},t=function(b){var c=b&&b.status;"active"===c&&(a.completeLicenseEntry(),k())},u=function(a){a&&a.data&&a.data.goldApi&&(j("license-message",a.data.goldApi),b.getSubscription().then(t))};return g.find("form").submit(function(){return this.action}),g.find("[data-mm-role~=form-submit]").click(function(){var a=jQuery(this).data("mm-form"),b=jQuery(a),c=b.find('[data-mm-role="subscription-code"]').val(),d=c&&b.find('[data-mm-subscription-code="'+c+'"]');d&&(b.find('[data-mm-role="subscription-description"]').val("Mindmup Gold "+d.text()),b.find('[data-mm-role="subscription-amount-dollars"]').val(d.data("mm-subscription-amount-dollars")),b.find('[data-mm-role="subscription-period"]').val(d.data("mm-subscription-period"))),b.data("mm-next-section")&&o(b.data("mm-next-section")),jQuery(a).submit()}),g.find("[data-mm-role~=form-input-updater]").change(function(){jQuery(this).mmUpdateInputField()}),g.on("show",function(){j("license-show");var b=a.getLicense();g.find("input[type=text]").val(""),o(p(b,h)),m()}),g.on("shown",function(){g.find("[data-mm-role=gold-account-identifier]").is(":visible")&&g.find("[data-mm-role=gold-account-identifier]").focus()}),g.find("button[data-mm-role=view-subscription]").click(function(){o("view-license"),m()}),g.on("hidden",function(){a.cancelLicenseEntry(),n&&window.clearInterval(n),i.show(),h=!1}),i.click(function(){a.removeLicense(),m(),o("no-license")}),g.find("button[data-mm-role~=show-section]").click(function(){o(jQuery(this).data("mm-target-section"))}),g.find("button[data-mm-role~=register]").click(s),g.find("button[data-mm-role~=action-CancelSubscription]").click(function(){o("cancelling-subscription"),b.cancelSubscription().then(function(){o("cancelled-subscription")},function(){o("cancellation-failed")})}),g.find("button[data-mm-role~=go-back]").click(function(){f&&o(f)}),g.find("button[data-mm-role=kickoff-sign-up]").click(function(){var a=g.find("[data-mm-role=gold-account-identifier]").val(),b=_.include(a,"@");b?(g.find("#gold-register-account-name").val(""),g.find("#gold-register-email").val(a)):(g.find("#gold-register-account-name").val(a),g.find("#gold-register-email").val("")),o("register"),b?g.find("#gold-register-account-name").focus():g.find("#gold-register-email").focus()}),g.find("[data-mm-role=kickoff-restore-license]").click(function(){var a=g.find("[data-mm-role=gold-account-identifier]"),c=a.val();c&&c.trim()?(a.parents("div.control-group").removeClass("error"),o("sending-code"),b.requestCode(c.trim()).then(function(){o("code-sent")},function(){o("sending-code-failed")})):a.parents("div.control-group").addClass("error")}),g.find("[data-mm-role=restore-license-with-code]").click(function(){var c=g.find("[data-mm-role=gold-access-code]"),d=c.val();d&&d.trim()?(o("sending-restore-license-code"),b.restoreLicenseWithCode(d.trim()).then(function(){b.getSubscription().then(function(b){var c=b&&b.expiry;c>Date.now()/1e3&&a.completeLicenseEntry()}),o("view-license"),m()},function(){o("restore-code-failed")})):c.parents("div.control-group").addClass("error")}),a.addEventListener("license-entry-required",function(){h=!0,g.modal("show")}),g.modal({keyboard:!0,show:!1}),d.addEventListener("message",u,!1),g},MM.GoldLicenseManager=function(a,b){"use strict";var c,d=this,e=function(a){return a&&"mindmup-gold"===a.accountType};observable(this),this.getLicense=function(){return a.getItem(b)},this.retrieveLicense=function(a){return c=void 0,!a&&this.getLicense()?jQuery.Deferred().resolve(this.getLicense()).promise():(c=jQuery.Deferred(),d.dispatchEvent("license-entry-required"),c.promise())},this.storeLicense=function(c){var d=c;if(_.isString(c))try{d=JSON.parse(c)}catch(f){return!1}return e(d)?(a.setItem(b,d),!0):!1},this.removeLicense=function(){a.setItem(b,void 0)},this.cancelLicenseEntry=function(){var a=c;c&&(c=void 0,a.reject("user-cancel"))},this.completeLicenseEntry=function(){var a=c;c&&(c=void 0,a.resolve(d.getLicense()))}},jQuery.fn.goldStorageOpenWidget=function(a,b){"use strict";var c=this,d=this.find("[data-mm-role=template]"),e=d.parent(),f=this.find("[data-mm-role=status]"),g=function(a,b,c,d){b=b||"block";var e='<div class="alert fade-in alert-'+b+'"><button type="button" class="close" data-dismiss="alert">&#215;</button><strong>'+a+"</strong>";d&&c&&(e=e+'&nbsp;<a href="#" data-mm-role="auth">'+c+"</a>"),e+="</div>",f.html(e),jQuery("[data-mm-role=auth]").click(function(){f.empty(),d()})},h=function(a){c.find("[data-mm-section]").hide(),c.find('[data-mm-section~="'+a+'"]').show()},i=function(a){f.empty();var g=[];g=_.sortBy(a,function(a){return a&&a.modifiedDate}).reverse(),g&&g.length>0?_.each(g,function(a){var f;a&&(f=d.clone().appendTo(e),f.find("[rel=tooltip]").tooltip(),f.find("a[data-mm-role=file-link]").text(a.title).click(function(){c.modal("hide"),b.loadMap(a.id)}),f.find("[data-mm-role~=map-delete]").click(function(){c.find('[data-mm-section~="delete-map"] [data-mm-role~="map-name"]').text(a.title),h("delete-map")}),f.find("[data-mm-role=modification-status]").text(new Date(a.modifiedDate).toLocaleString()))}):jQuery('<tr><td colspan="3">No maps found</td></tr>').appendTo(e)},j=function(){var b=function(){g('Unable to retrieve files from Mindmup Gold due to a network error. Please try again later. If the problem persists, please <a href="mailto:contact@mindmup.com">contact us</a>.',"error")};e.empty(),f.html('<i class="icon-spinner icon-spin"/> Retrieving files...'),a.list(!1).then(i,function(d){"not-authenticated"===d?a.list(!0).then(i,function(a){"user-cancel"===a?c.modal("hide"):"not-authenticated"===a?g('The license key is invalid. To obtain or renew a MindMup Gold License, please send us an e-mail at <a href="mailto:contact@mindmup.com">contact@mindmup.com</a>',"error"):b()}):"user-cancel"===d?c.modal("hide"):b()})};return d.detach(),c.find("[data-mm-target-section]").click(function(){var a=jQuery(this),b=a.data("mm-target-section");h(b)}),c.find('[data-mm-role~="delete-map-confirmed"]').click(function(){var b=c.find('[data-mm-section~="delete-map"] [data-mm-role~="map-name"]').text();h("delete-map-in-progress"),a.deleteMap(b).then(function(){h("delete-map-successful")},function(a){c.find('[data-mm-section="delete-map-failed"] [data-mm-role="reason"]').text(a),h("delete-map-failed")})}),c.on("show",function(a){this===a.target&&(h("file-list"),j())}),c.modal({keyboard:!0,show:!1,backdrop:"static"}),c},MM.GoldStorage=function(a,b,c,d){"use strict";var e,f=this,g={editable:!0},h=function(a){return a&&d&&d[a]},i=function(a){var b=a&&a.split("/");return!b||b.length<3?!1:h(b[0])?{prefix:b[0],account:b[1],fileNameKey:decodeURIComponent(b[2])}:!1},j=function(a,b,c){return a+"/"+b+"/"+encodeURIComponent(c)};d=_.extend({p:{isPrivate:!0},b:{isPrivate:!1},listPrefix:"b"},d),_.each(d,function(a,b){a.isPrivate&&(e=b)}),f.fileSystemFor=function(a,b){return{recognises:function(b){return b&&b[0]===a},description:b||"MindMup Gold",saveMap:function(b,c,d,e){return f.saveMap(a,b,c,d,e)},loadMap:f.loadMap}},f.deleteMap=a.deleteFile,f.list=function(b){var c=jQuery.Deferred(),e=function(a,b){var e=d.listPrefix+"/"+b+"/",f=function(a){return _.extend({id:e+encodeURIComponent(a.title)},a)};c.resolve(_.map(a,f))};return a.listFiles(b).then(e,c.reject),c.promise()},f.saveMap=function(e,f,h,k,l){var m=jQuery.Deferred(),n=function(a,b){return a&&a.fileNameKey&&a.account===b?a.fileNameKey:k},o=function(k,l){var o=i(h),p=n(o,l),q=_.extend({},k,{key:l+"/"+p}),r=function(){return o&&l===o.account?!1:!0},s=function(){m.resolve(j(e,l,p),g)},t=function(){b.save(f,q,d[e]).then(s,m.reject)},u=function(){c.showModalToConfirm("Confirm saving","There is already a file with that name in your gold storage. Please confirm that you want to overwrite it, or cancel and rename the map before saving","Overwrite").then(t,m.reject.bind(m,"user-cancel"))},v=function(){a.exists(p).then(function(a){a?u():t()},m.reject)};r()?v():t()};return a.generateSaveConfig(l).then(o,m.reject),m.promise()},f.loadMap=function(c,f){var h=jQuery.Deferred(),k=i(c),l=function(c,i,k){var m=d[c].isPrivate;a.fileUrl(f,i,k,m).then(function(a){b.loadUrl(a).then(function(a){h.resolve(a,j(c,i,k),"application/json",g)},function(a){"map-not-found"===a&&!m&&e?l(e,i,k):h.reject(a)})},h.reject)};return k?l(k.prefix,k.account,k.fileNameKey):h.reject("invalid-args"),h.promise()}},MM.GoogleDriveAdapter=function(a,b,c,d,e){"use strict";var f,g={},h=function(){return window.gapi&&gapi.auth&&gapi.auth.getToken()&&gapi.auth.getToken().access_token},i=function(){return!!h()},j=function(a){return a&&"g"===a[0]},k=function(a){return j(a)?a.substr(2):void 0},l=function(a){return"g1"+(a||"")},m=function(a){var c=jQuery.Deferred();return c.notify("Authenticating with Google"),gapi.auth.authorize({client_id:b,scope:"https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive.install https://www.googleapis.com/auth/userinfo.profile",immediate:!a},function(a){a&&!a.error?c.resolve():c.reject("not-authenticated")}),c.promise()},n=function(a,b,c,d){var f=k(b),h=jQuery.Deferred(),i="-------314159265358979323846",j="\r\n--"+i+"\r\n",o="\r\n--"+i+"--",p=d||e,q={title:c,mimeType:p},r=j+"Content-Type: application/json\r\n\r\n"+JSON.stringify(q)+j+"Content-Type: "+p+"\r\n\r\n"+a+o,s=gapi.client.request({path:"/upload/drive/v2/files"+(f?"/"+f:""),method:f?"PUT":"POST",params:{uploadType:"multipart",useContentAsIndexableText:a.length<131072},headers:{"Content-Type":"multipart/mixed; boundary='"+i+"'"},body:r});try{h.notify("sending to Google Drive"),s.execute(function(d){var e=[404,500,502,503,504,-1];d.error?403===d.error.code?h.reject(!d.error.reason||"rateLimitExceeded"!==d.error.reason&&"userRateLimitExceeded"!==d.error.reason?"no-access-allowed":"network-error"):401===d.error.code?m(!1).then(function(){n(a,b,c).then(h.resolve,h.reject,h.notify)},h.reject,h.notify):h.reject(_.contains(e,d.error.code)?"network-error":d.error):h.resolve(l(d.id),g)})}catch(t){h.reject("network-error",t.toString()+"\nstack: "+t.stack+"\nauth: "+JSON.stringify(gapi.auth.getToken())+"\nnow: "+Date.now())}return h.promise()},o=function(a){var b=jQuery.Deferred(),c=a&&a.fileSize&&parseFloat(a.fileSize),d=function(a){b.notify({total:c,loaded:a.loaded})};return a.downloadUrl?jQuery.ajax(a.downloadUrl,{progress:d,headers:{Authorization:"Bearer "+gapi.auth.getToken().access_token}}).then(b.resolve,b.reject.bind(b,"network-error")):b.reject("no-file-url"),b.promise()},p=function(a){var b=jQuery.Deferred(),c=gapi.client.drive.files.get({fileId:a});return c.execute(function(a){var c=a.mimeType;a.error?b.reject(403===a.error.code?"network-error":404===a.error.code?"no-access-allowed":a.error):o(a).then(function(a){b.resolve(a,c)},b.reject,b.notify)}),b.promise()},q=function(a){var b=jQuery.Deferred(),c=a?"failed-authentication":"not-authenticated";return m(a).then(b.resolve,function(){b.reject(c)}).progress(b.notify),b.promise()},r=function(a){window.gapi&&window.gapi.client?a():(window.googleClientLoaded=a,jQuery('<script src="https://apis.google.com/js/client.js?onload=googleClientLoaded"></script>').appendTo("body"))},s=function(a){var b=jQuery.Deferred();return f?q(a).then(b.resolve,b.reject,b.notify):(b.notify("Loading Google APIs"),r(function(){b.notify("Loading Google Drive APIs"),gapi.client.setApiKey(c),gapi.client.load("drive","v2",function(){f=!0,q(a).then(b.resolve,b.reject,b.notify)})})),b.promise()};this.description="Google",this.saveFile=n,this.toGoogleFileId=k,this.ready=function(a){var b=jQuery.Deferred();return f&&i()?b.resolve():s(a).then(b.resolve,b.reject,b.notify),b.promise()},this.recognises=j,this.loadMap=function(a,b){var c=jQuery.Deferred(),d=k(a),e=function(){p(d).then(function(b,d){c.resolve(b,a,d,g)},c.reject).progress(c.notify)};return this.ready(b).then(e,c.reject,c.notify),c.promise()},this.saveMap=function(a,b,c,d){var e=jQuery.Deferred();return this.ready(d).then(function(){n(a,b,c).then(e.resolve,e.reject,e.notify)},e.reject).progress(e.notify),e.promise()},this.showSharingSettings=function(b){var c=function(){var c=new gapi.drive.share.ShareClient(a);c.setItemIds(k(b)),c.showSettingsDialog()};gapi&&gapi.drive&&gapi.drive.share?c():this.ready(!1).done(function(){gapi.load("drive-share",c)})},this.showPicker=function(b,c,d){var e=jQuery.Deferred(),f="application/octet-stream,application/vnd.mindmup.collab,application/vnd-freemind,application/json,application/vnd.google.drive.ext-type.mup,application/x-freemind,application/vnd.google.drive.ext-type.mm",g=function(){var d,f;f=new google.picker.DocsView(google.picker.ViewId.DOCS),f.setMimeTypes(b),f.setMode(google.picker.DocsViewMode.LIST),d=(new google.picker.PickerBuilder).enableFeature(google.picker.Feature.NAV_HIDDEN).setAppId(a).addView(f).setCallback(function(a){return"picked"===a.action?void e.resolve(l(a.docs[0].id)):void("cancel"===a.action&&e.reject())}).setTitle(c).setSelectableMimeTypes(b).setOAuthToken(h()).build().setVisible(!0)};return b=b||f,window.google&&window.google.picker?g():this.ready(d).then(function(){gapi.load("picker",g)},e.reject,e.notify),e.promise()}},$.fn.googleDriveOpenWidget=function(a,b,c,d){"use strict";var e=this,f="Open a MindMup or Freemind file from Google Drive";e.click(function(){var e=$(this),g=e.data("mm-content-types"),h=e.data("mm-title")||f,i=function(a){d.error(a)},j=function(a){d.log(a)},k=function(a){b.loadMap(a)},l=function(b){"not-authenticated"===b&&c.showModalToConfirm("Please confirm external access",'This operation requires authentication through Google Drive, an external storage provider. Please click on Authenticate below to go to the external provider and allow MindMup to access your account. You can learn more about authentication requirements on our <a href="http://blog.mindmup.com/p/storage-options.html" target="_blank">Storage Options</a> page.',"Authenticate").then(function(){a.showPicker(g,h,!0).then(k,i,j)})};a.showPicker(g,h,!1).then(k,l,j)})},jQuery.fn.googleShareWidget=function(a,b){"use strict";return this.click(function(){b.showSharingSettings(a.currentMapId())})},jQuery.fn.gridDown=function(){"use strict";var a=this,b=a.position(),c=_.filter(a.siblings(),function(a){var c=jQuery(a).position();return b.top<c.top&&Math.abs(b.left-c.left)<3}),d=_.min(c,function(a){return jQuery(a).position().top});return d&&jQuery(d)||a},jQuery.fn.gridUp=function(){"use strict";var a=this,b=a.position(),c=_.filter(a.siblings(),function(a){var c=jQuery(a).position();return b.top>c.top&&Math.abs(b.left-c.left)<3}),d=_.max(c,function(a){return jQuery(a).position().top});return d&&jQuery(d)||a},MM.iconEditor=function(a,b){"use strict";observable(this);var c,d=this;this.editIcon=function(a){return a&&(a.url=b.getResource(a.url)),c=jQuery.Deferred(),this.dispatchEvent("iconEditRequested",a),c.promise()},this.save=function(a){c.resolve(a)},this.cancel=function(){c.reject()},a.addEventListener("nodeIconEditRequested",function(){var c=a.getIcon();d.editIcon(c).then(function(c){c?a.setIcon("icon-editor",b.storeResource(c.url),c.width,c.height,c.position):a.setIcon(!1)})})},jQuery.fn.iconEditorWidget=function(a,b){"use strict";var c=this,d=c.find("[data-mm-role~=confirm]"),e=c.find("form select[name=size]"),f=c.find("[data-mm-role=custom-size-enter]"),g=c.find("[data-mm-role=img-preview]"),h=c.find("[data-mm-role~=clear]"),i=c.find("select[name=position]"),j=c.find("input[name=width]"),k=c.find("input[name=height]"),l=c.find("input[name=keepratio]"),m=c.find("input[name=selectfile]"),n=c.find("[data-mm-role=drop-zone]"),o=c.find("[data-mm-role=select-file]"),p=function(){a.save({url:g.attr("src"),width:Math.round(j.val()),height:Math.round(k.val()),position:i.val()})},q=function(){a.save(!1)},r=function(a){a?(g.show(),g.attr("src",a.url),c.find("[data-mm-role=attribs]").show(),i.val(a.position),j.val(a.width),k.val(a.height),m.val(""),h.show(),d.show()):(g.hide(),c.find("[data-mm-role=attribs]").hide(),h.hide(),d.hide())},s=function(){m.click()},t=new MAPJS.ImageInsertController(b);return o.click(s).keydown("space enter",s),t.addEventListener("imageInserted",function(a,b,e){g.attr("src",a),j.val(b),k.val(e),c.find("[data-mm-role=attribs]").show(),g.show(),d.show(),d.focus()}),n.imageDropWidget(t),j.on("change",function(){l[0].checked&&k.val(Math.round(g.height()*parseInt(j.val(),10)/g.width()))}),k.on("change",function(){l[0].checked&&j.val(Math.round(g.width()*parseInt(k.val(),10)/g.height()))}),m.on("change",function(a){t.insertFiles(this.files,a)}),c.modal({keyboard:!0,show:!1}),d.click(function(){p()}).keydown("space",function(){p(),c.modal("hide")}),h.click(function(){q()}).keydown("space",function(){q(),c.modal("hide")}),e.on("change",function(){"custom"===e.val()?f.show():f.hide()}),this.on("show",function(){m.css("opacity",0).val("")}),this.on("shown",function(){m.css("opacity",0).css("position","absolute").offset(n.offset()).width(n.outerWidth()).height(n.outerHeight()),o.focus()}),a.addEventListener("iconEditRequested",function(a){r(a),c.modal("show")}),this},MM.setImageAlertWidget=function(a,b){"use strict";var c;a.addEventListener("imageInserted",function(){b.hide(c)}),a.addEventListener("imageInsertError",function(){b.hide(c),c=b.show("Cannot insert image from this website:","Please save the image locally and drag the saved file to add it to the map","error")}),a.addEventListener("imageLoadStarted",function(){b.hide(c),c=b.show('<i class="icon-spinner icon-spin"/> Loading image')})},$.fn.importWidget=function(a,b){"use strict";var c,d=this,e=d.find("[data-mm-role=status]"),f=d.find("input[type=file]"),g=d.find("[data-mm-role=select-file]"),h=function(a){e.html('<i class="icon-spinner icon-spin"/> '+a)},i=function(b){a.log("Map","import:start "+c,b),h("Uploading "+b)},j=function(a,b){var c,d=0;return"mm"===b?MM.freemindImport(a,function(a){c=a},function(){var a=(100*d/c).toFixed(2)+"%";d%1e3===0&&h("Converted "+a),d++}):"mup"===b?JSON.parse(a):void 0},k=function(b){a.log("Map","import:fail",b),e.html('<div class="alert fade in alert-error"><strong>'+b+"</strong></div>")},l=function(c,f){var g,i;h("Processing file"),"mup"!==f&&"mm"!==f&&k("unsupported format "+f);try{i=j(c,f),h("Initialising map"),g=MAPJS.content(i)}catch(l){return void k("invalid file content",l)}h("Done"),a.log("Map","import:complete"),e.empty(),d.modal("hide"),b.setMap(g)},m=function(){return window.File&&window.FileReader&&window.FileList&&window.Blob&&!$("body").hasClass("disable-filereader")};return m()?(f.file_reader_upload(i,l,k),c="FileReader"):(k("This browser does not support importing from local disk"),g.hide()),d.on("shown",function(){f.css("opacity",0).css("position","absolute").offset(g.offset()).width(g.outerWidth()).height(g.outerHeight()),g.focus()}),g.keydown("space return",function(){f.click()}),d},MM.JsonStorage=function(a){"use strict";var b=this;b.setItem=function(b,c){return a.setItem(b,JSON.stringify(c))},b.getItem=function(b){var c=a.getItem(b);try{return JSON.parse(c)}catch(d){}},b.remove=function(b){a.removeItem(b)},b.removeKeysWithPrefix=function(b){if(_.isEmpty(b))return 0;var c=Object.keys(a),d=_.filter(c,function(a){return 0===a.indexOf(b)});return _.each(d,function(b){a.removeItem(b)}),d.length}},jQuery.fn.keyActionsWidget=function(){"use strict";var a=this;this.find("[data-mm-role~=dismiss-modal]").click(function(){a.modal("hide")}),a.on("show",function(){a.find(".active").removeClass("active"),a.find(".carousel-inner").children(".item").first().addClass("active")})},MM.LayoutExportController=function(a,b,c,d){"use strict";var e=this,f="Map",g=function(a){return a?a.toUpperCase()+" Export":"Export"},h=function(b){return a[b].exporter||a[b]},i=function(b,c,d){var e={"output-url":c};return a[b].processor?a[b].processor(_.extend(e,d)):jQuery.Deferred().resolve(e).promise()};e.startExport=function(a,e){var j=jQuery.Deferred(),k=g(a),l=function(){return"pending"!==j.state()},m=function(a,b){d.log(f,k+" failed",a),j.reject(a,b)},n=h(a)(),o=_.extend({},n,e);return _.isEmpty(n)?j.reject("empty").promise():(d.log(f,k+" started"),b.generateExportConfiguration(a).then(function(b){var g=b.s3UploadIdentifier;c.save(JSON.stringify(o),b,{isPrivate:!0}).then(function(){var h=d.timer(f,k+":polling-completed"),n=d.timer(f,k+":polling-timeout"),o=d.timer(f,k+":polling-error"),p=function(){h.end(),d.log(f,k+" completed"),i(a,b.signedOutputUrl,e).then(function(a){j.resolve(a,g)},function(a){m(a,g)})};c.poll(b.signedErrorListUrl,{stoppedSemaphore:l,sleepPeriod:15e3}).then(function(){o.end(),m("generation-error",g)}),c.poll(b.signedOutputListUrl,{stoppedSemaphore:l,sleepPeriod:2500}).then(p,function(a){n.end(),m(a,g)})},m)},m),j.promise())}},jQuery.fn.layoutExportWidget=function(a){"use strict";return this.each(function(){var b=jQuery(this),c=function(){var a=b.find("[data-mm-role=format-selector]");return a&&a.val()?a.val():b.data("mm-format")},d=b.find("[data-mm-role~=start-export]"),e=function(a){b.find(".visible").hide(),b.find(".visible."+a).show()},f=function(a){_.each(a,function(a,c){b.find("[data-mm-role~="+c+"]").each(function(){var b=jQuery(this);"A"===b.prop("tagName")?b.attr("href",a):"INPUT"===b.prop("tagName")||"TEXTAREA"===b.prop("tagName")?b.val(a).attr("data-mm-val",a):"DIV"===b.prop("tagName")&&(_.contains(b.attr("data-mm-role").split(" "),a)?b.show():b.hide())})}),e("done")},g=function(){var a=b.find("form[data-mm-role~=export-parameters]"),c={};return a&&a.find("button.active").add(a.find("select")).add(a.find("input")).each(function(){c[jQuery(this).attr("name")]=jQuery(this).val()||jQuery(this).attr("placeholder")}),c},h=function(a,d){b.find("[data-mm-role=contact-email]").attr("href",function(){return"mailto:"+jQuery(this).text()+"?subject=MindMup%20"+c().toUpperCase()+"%20Export%20Error%20"+d}),b.find("[data-mm-role=file-id]").html(d),b.find(".error span").hide(),e("error");var f=b.find("[data-mm-role="+a+"]");f.length>0?f.show():b.find("[data-mm-role=error-message]").html(a).show()},i=function(){e("inprogress"),a.startExport(c(),{"export":g()}).then(f,h)};b.find("form").submit(function(){return!1}),d.click(i).keydown("space",i),b.modal({keyboard:!0,show:!1,backdrop:"static"}),b.find("[data-mm-role=set-state]").click(function(){e(jQuery(this).attr("data-mm-state"))}),b.on("show",function(a){this===a.target&&e("initial")})})},MM.buildMapLayoutExporter=function(a,b){"use strict";return function(){var c=a.getCurrentLayout();return c&&c.nodes&&_.each(c.nodes,function(a){a.attr&&a.attr.icon&&a.attr.icon.url&&(a.attr.icon.url=b(a.attr.icon.url))}),c}},MM.ajaxResultProcessor=function(a){"use strict";var b=jQuery.Deferred();return jQuery.ajax({url:a["output-url"],dataType:"json"}).then(function(c){b.resolve(_.extend({},a,c))},function(){b.reject("generation-error")}),b.promise()},MM.layoutExportDecorators={},MM.layoutExportDecorators.twitterIntentResultDecorator=function(a){"use strict";a["twitter-url"]="https://twitter.com/intent/tweet?text="+encodeURIComponent(a.export.title)+"&url="+encodeURIComponent(a["index-html"])+"&source=mindmup.com&related=mindmup&via=mindmup"},MM.layoutExportDecorators.facebookResultDecorator=function(a){"use strict";a["facebook-url"]="https://www.facebook.com/dialog/share_open_graph?app_id=621299297886954&display=popup&action_type=og.likes&action_properties=%7B%22object%22%3A%22"+encodeURIComponent(a["index-html"])+"%22%7D&redirect_uri="+encodeURIComponent("http://www.mindmup.com/fb")},MM.layoutExportDecorators.googlePlusResultDecorator=function(a){"use strict";a["google-plus-url"]="https://plus.google.com/share?url="+encodeURIComponent(a["index-html"])},MM.layoutExportDecorators.linkedinResultDecorator=function(a){"use strict";a["linkedin-url"]="http://www.linkedin.com/shareArticle?mini=true&url="+encodeURIComponent(a["index-html"])+"&title="+encodeURIComponent(a.export.title)+"&summary="+encodeURIComponent(a.export.description)+"&source=MindMup"},MM.layoutExportDecorators.tumblrResultDecorator=function(a){"use strict";a["tumblr-url"]="http://www.tumblr.com/share/link?url="+encodeURIComponent(a["index-html"])+"&name="+encodeURIComponent(a.export.title)+"&description="+encodeURIComponent(a.export.description)},MM.layoutExportDecorators.pinterestResultDecorator=function(a){"use strict";a["pinterest-url"]="https://pinterest.com/pin/create/button/?media="+encodeURIComponent(a["thumb-png"])+"&url="+encodeURIComponent(a["index-html"])+"&is_video=false&description="+encodeURIComponent(a.export.description)
},MM.layoutExportDecorators.embedResultDecorator=function(a){"use strict";a["embed-markup"]='<iframe src="'+a["index-html"]+'"></iframe>'},MM.layoutExportDecorators.gmailResultDecorator=function(a){"use strict";a["gmail-index-html"]="https://mail.google.com/mail/u/0/?view=cm&ui=2&cmid=0&fs=1&tf=1&body="+encodeURIComponent(a.export.title+"\n\n")+encodeURIComponent(a["index-html"])},MM.layoutExportDecorators.emailResultDecorator=function(a){"use strict";a["email-index-html"]="mailto:?subject="+encodeURIComponent(a.export.title)+"&body="+encodeURIComponent(a.export.description+":\r\n\r\n")+encodeURIComponent(a["index-html"])},MM.layoutExportDecorators.gmailZipResultDecorator=function(a){"use strict";a["gmail-archive-zip"]="https://mail.google.com/mail/u/0/?view=cm&ui=2&cmid=0&fs=1&tf=1&body="+encodeURIComponent(a.export.title+"\n\n")+encodeURIComponent(a["archive-zip"])},MM.layoutExportDecorators.emailZipResultDecorator=function(a){"use strict";a["email-archive-zip"]="mailto:?subject="+encodeURIComponent(a.export.title)+"&body="+encodeURIComponent(a.export.description+":\r\n\r\n")+encodeURIComponent(a["archive-zip"])},MM.buildDecoratedResultProcessor=function(a,b){"use strict";return function(c){var d=jQuery.Deferred();return a(c).then(function(a){_.each(b,function(b){b(a)}),d.resolve(a)},d.reject),d.promise()}},MM.LocalStorageClipboard=function(a,b,c){"use strict";var d=this;d.get=function(){return a.getItem(b)},d.put=function(d){try{a.setItem(b,d)}catch(e){c.show("Clipboard error","Insufficient space to copy object - saving the map might help up free up space","error")}}},jQuery.fn.newFromClipboardWidget=function(a,b){"use strict";var c=jQuery(this);return c.click(function(){var c,d=a.get();d&&(_.isArray(d)&&d.length>1?(c=MAPJS.content(JSON.parse(JSON.stringify(MM.Maps.default))),c.pasteMultiple(1,d)):(_.isArray(d)&&(d=d[0]),d.attr&&d.attr.style&&(d.attr.style=void 0),c=MAPJS.content(d)),b.setMap(c))}),c},$.fn.localStorageOpenWidget=function(a,b){"use strict";var c=this,d=this.find("[data-mm-role=template]"),e=d.parent(),f=this.find("[data-mm-role=status]"),g=function(a,b,c,d){b=b||"block";var e='<div class="alert fade-in alert-'+b+'"><button type="button" class="close" data-dismiss="alert">&#215;</button><strong>'+a+"</strong>";d&&c&&(e=e+'&nbsp;<a href="#" data-mm-role="auth">'+c+"</a>"),e+="</div>",f.html(e),$("[data-mm-role=auth]").click(function(){f.empty(),d()})},h=function(b,c,d){a.restore(b,c,d),k()},i=function(b,c,d){var e=a.load(b);a.remove(b),k(),g('Map "'+d+'" removed.',"info","Undo",h.bind(void 0,b,e,c))},j=function(a){f.empty();var g=[];_.each(a,function(a,b){g.push({id:b,title:a.d||"map",modifiedDate:1e3*a.t,info:a})}),g=_.sortBy(g,function(a){return a&&a.modifiedDate}).reverse(),g&&g.length>0?_.each(g,function(a){var f;a&&(f=d.clone().appendTo(e),f.find("a[data-mm-role=file-link]").text(a.title).click(function(){c.modal("hide"),b.loadMap(a.id)}),f.find("[data-mm-role=modification-status]").text(new Date(a.modifiedDate).toLocaleString()),f.find("[data-mm-role=map-delete]").click(i.bind(void 0,a.id,a.info,a.title)))}):$('<tr><td colspan="3">No maps found in Browser storage</td></tr>').appendTo(e)},k=function(){e.empty(),f.html('<i class="icon-spinner icon-spin"/> Retrieving files...');try{j(a.list())}catch(b){g("Unable to retrieve files from browser storage","error")}};return d.detach(),c.on("show",function(){k()}),c},MM.MapController=function(a){"use strict";observable(this);var b,c,d,e=this,f=this.dispatchEvent,g={},h=[].concat(a),i=function(a){var b;for(b=0;b<h.length;b++)if(h[b].recognises(a))return h[b]},j=function(a,c,e){d=e,b=!1,e=e||{},e.autoSave||a.addEventListener("changed",function(){b=!0}),g={idea:a,mapId:e.editable&&c},f("mapLoaded",c,a,e)};e.addMapSource=function(a){h.push(a)},e.validMapSourcePrefixesForSaving="abgp",e.setMap=j,e.isMapLoadingConfirmationRequired=function(){return b},e.currentMapId=function(){return g&&g.mapId},e.loadMap=function(a,d){var g=function(b){var c=b&&b.loaded||0,d=b&&b.total||1,e=b&&b.loaded?Math.round(100*c/d)+"%":b;f("mapLoading",a,e)},h=function(b,i){var k=function(){f("mapLoading",a),c.loadMap(a,!0).then(j,h,g)},l=c.description?" ["+c.description+"]":"";"no-access-allowed"===b?f("mapLoadingUnAuthorized",a,b):"failed-authentication"===b?f("authorisationFailed",c.description,k):"not-authenticated"===b?f("authRequired",c.description,k):"map-load-redirect"===b?e.loadMap(i,d):"user-cancel"===b?f("mapLoadingCancelled"):(i=i?i+l:l,f("mapLoadingFailed",a,b,i))};return a!==this.currentMapId()||d?!d&&b?void f("mapLoadingConfirmationRequired",a):(c=i(a))?(f("mapLoading",a),void c.loadMap(a).then(j,h,g)):void f("mapIdNotRecognised",a):void f("mapLoadingCancelled",a)},this.publishMap=function(a,h){var j=function(a,c){var h=d&&d.reloadOnSave;c=c||{},d=c,b=!1,g.mapId=a,f("mapSaved",a,g.idea,c),(h||c.reloadOnSave)&&e.loadMap(a,!0)},k=function(a){var b=a&&a.loaded||0,d=a&&a.total||1,e=a&&a.loaded?Math.round(100*b/d)+"%":a;f("mapSaving",c.description,e)},l=function(a,b){var d=function(){f("mapSaving",c.description),c.saveMap(g.idea,g.mapId,!0).then(j,l,k)},e=c.description||"";b=b?b+e:e,"no-access-allowed"===a?f("mapSavingUnAuthorized",function(){f("mapSaving",c.description,"Creating a new file"),c.saveMap(g.idea,"new",!0).then(j,l,k)}):"failed-authentication"===a?f("authorisationFailed",b,d):"not-authenticated"===a?f("authRequired",b,d):"file-too-large"===a?f("mapSavingTooLarge",c.description):"user-cancel"===a?f("mapSavingCancelled"):f("mapSavingFailed",a,b)},m=h?"":g.mapId;c=i(a||g.mapId),f("mapSaving",c.description),c.saveMap(g.idea,m).then(j,l,k)}},MM.MapController.activityTracking=function(a,b){"use strict";var c,d,e=function(a){return 1===a.id},f=function(a){return a.title&&-1===a.title.search(/MindMup|Lancelot|cunning|brilliant|Press Space|famous|Luke|daddy/)},g=function(a){return!f(a)},h=function(a){return e(a)&&a.find(f).length>5&&a.find(g).length<3},i=!1;a.addEventListener("mapLoaded",function(a,e){b.log("Map","View",a),c=h(e),d!==e&&(d=e,e.addEventListener("changed",function(a,c){i||(i=!0,b.log("Map","Edit")),b.log(["Map",a].concat(c))}))}),a.addEventListener("mapLoadingFailed",function(a,c,d){var e="Error loading map document ["+a+"] "+JSON.stringify(c);d&&(e=e+" label ["+d+"]"),b.error(e)}),a.addEventListener("mapSaving",b.log.bind(b,"Map","Save Attempted")),a.addEventListener("mapSaved",function(a,d){i=!1,h(d)&&!c?b.log("Map","Created Relevant",a):c?b.log("Map","Saved Relevant",a):b.log("Map","Saved Irrelevant",a)}),a.addEventListener("mapSavingFailed",function(a,c){b.error("Map save failed ("+c+")"+JSON.stringify(a))}),a.addEventListener("networkError",function(a){b.log("Map","networkError",JSON.stringify(a))})},MM.MapController.alerts=function(a,b,c){"use strict";var d,e=function(a,e,f,g){b.hide(d),c.showModalToConfirm("Please confirm",a,e).then(f,g)},f=function(a,c){b.hide(d),d=b.show(a,c,"error")};a.addEventListener("mapLoadingConfirmationRequired",function(b){var c=/^new/.test(b);e("There are unsaved changes in the current map. Please confirm that you would like to "+(c?"create a new map":"load a different map."),c?"Create New":"Load anyway",function(){a.loadMap(b,!0)})}),a.addEventListener("mapLoading",function(a,c){b.hide(d),d=b.show('<i class="icon-spinner icon-spin"></i>&nbsp;Please wait, loading the map...',c||"")}),a.addEventListener("mapSaving",function(a,c){b.hide(d),d=b.show('<i class="icon-spinner icon-spin"></i>&nbsp;Please wait, saving the map...',c||"")}),a.addEventListener("authRequired",function(a,b){e("This operation requires authentication through "+a+', an external storage provider. Please click on Authenticate below to go to the external provider and allow MindMup to access your account. You can learn more about authentication requirements on our <a href="http://blog.mindmup.com/p/storage-options.html" target="_blank">Storage Options</a> page.',"Authenticate",b)}),a.addEventListener("mapSaved mapLoaded",function(){b.hide(d)}),a.addEventListener("authorisationFailed",function(a,b){e("The operation was rejected by "+a+" storage. Click on Reauthenticate to try using different credentials or license.","Reauthenticate",b)}),a.addEventListener("mapLoadingUnAuthorized",function(){f("The map could not be loaded.",'You do not have the right to view this map. <a target="_blank" href="http://blog.mindmup.com/p/how-to-resolve-common-networking.html">Click here for some common solutions</a>')}),a.addEventListener("mapSavingUnAuthorized",function(a){e("You do not have the right to edit this map","Save a copy",a)}),a.addEventListener("mapLoadingFailed",function(a,b,c){f("Unfortunately, there was a problem loading the map."+c,'If you are not experiencing network problems, <a href="http://blog.mindmup.com/p/how-to-resolve-common-networking.html" target="blank">click here for some common ways to fix this</a>')}),a.addEventListener("mapSavingCancelled mapLoadingCancelled",function(){b.hide(d)}),a.addEventListener("mapSavingTooLarge",function(b){"S3_CORS"===b?e('The map is too large for anonymous MindMup storage. Maps larger than 100 KB can only be stored to MindMup Gold, or a third-party cloud storage. (<a href="http://blog.mindmup.com/p/storage-options.html" target="_blank">more info on storage options</a>)',"Save to MindMup Gold",function(){a.publishMap("b")},function(){a.dispatchEvent("mapSavingCancelled")}):f("Unfortunately, the file is too large for the selected storage.","Please select a different storage provider from File -&gt; Save As menu")}),a.addEventListener("mapSavingFailed",function(a,b,c){var d={"network-error":["There was a network problem communicating with the server.",'If you are not experiencing network problems, <a href="http://blog.mindmup.com/p/how-to-resolve-common-networking.html" target="blank">click here for some common ways to fix this</a>. Don\'t worry, you have an auto-saved version in this browser profile that will be loaded the next time you open the map']},g=d[a]||["Unfortunately, there was a problem saving the map.","Please try again later. We have sent an error report and we will look into this as soon as possible"];c?e(g[0],g[1],c):f(g[0],g[1])})},function(){"use strict";var a=jQuery.ajaxSettings.xhr.bind(jQuery.ajaxSettings);jQuery.ajaxSettings.xhr=function(){var b=a();return b instanceof XMLHttpRequest&&b.addEventListener("progress",this.progress,!1),b.upload&&b.upload.addEventListener("progress",this.progress,!1),b}}(),jQuery.fn.mapStatusWidget=function(a,b){"use strict";var c,d=this;a.addEventListener("mapSaved mapLoaded",function(a,b,e){e.editable?d.removeClass("map-changed").addClass("map-unchanged"):jQuery("body").removeClass("map-unchanged").addClass("map-changed"),c=e.autoSave,d.removeClass(_.filter(d.attr("class").split(" "),function(a){return/^map-source-/.test(a)}).join(" ")),a&&d.addClass("map-source-"+a[0])}),jQuery(window).bind("beforeunload",function(){return a.isMapLoadingConfirmationRequired()?"There are unsaved changes.":void 0}),b.addListener(function(a,b){c||b||d.hasClass("map-unchanged")&&d.removeClass("map-unchanged").addClass("map-changed")})},MM.Maps={},MM.Maps["default"]=MM.Maps["new"]={title:"Press Space or double-click to edit",id:1},MM.EmbeddedMapSource=function(a){"use strict";var b=a||{editable:!0};this.recognises=function(a){return/^new-/.test(a)&&(a="new"),MM.Maps[a]},this.loadMap=function(a){return jQuery.Deferred().resolve(MAPJS.content(_.clone(this.recognises(a))),a,b).promise()}},MM.MeasuresModel=function(a,b,c,d){"use strict";var e,f=observable(this),g=[],h=[],i=function(a,b){b&&f.dispatchEvent("startFromScratch");var c=g;g=k(),f.listeners("measureRemoved").length>0&&_.each(_.difference(c,g),function(a){f.dispatchEvent("measureRemoved",a)}),f.listeners("measureAdded").length>0&&_.each(_.difference(g,c),function(a){f.dispatchEvent("measureAdded",a,g.indexOf(a))}),o()},j=function(){f.dispatchEvent("measureRowsChanged")},k=function(){var b=c.getActiveContent(),d=b&&b.getAttr(a);return _.isArray(d)?d:[]},l=function(a){var b={};return _.each(a,function(a){b[a.id]=a}),b},m=function(a,b){var c=[];return _.each(a.values,function(d,e){var f=b&&b.values&&b.values[e]||0;d!==f&&c.push(["measureValueChanged",a.id,e,d||0])}),b&&_.each(b.values,function(d,e){var f=!a||!a.values||!a.values[e];f&&c.push(["measureValueChanged",b.id,e,0])}),c},n=function(a,b){var c=l(b),d=[];return _.each(a,function(a){var b=c[a.id];d=d.concat(m(a,b))}),d},o=function(){if(0!==f.listeners("measureValueChanged").length){var a=h,b=n(f.getMeasurementValues(),a);_.each(b,function(a){f.dispatchEvent.apply(f,a)})}};f.editingMeasure=function(a,b){f.dispatchEvent("measureEditing",a,b)},f.getMeasures=function(){return g.slice(0)},f.editWithFilter=function(a){e&&f.removeFilter(),e=a,e&&e.addEventListener&&e.addEventListener("filteredRowsChanged",j)},f.addUpMeasurementForAllNodes=function(a){var d=c.getActiveContent(),e={},f=function(c){var d=c.getAttr(b),f=0,g=!1;d&&d[a]&&(f=parseFloat(d[a]),g=!0),c.ideas&&_.each(c.ideas,function(a){void 0!==e[a.id]&&(g=!0,f+=e[a.id])}),g&&(e[c.id]=f)};return d&&a?(d.traverse(f,!0),e):{}},f.getMeasurementValues=function(){var a=c.getActiveContent(),d=[];return a?(a.traverse(function(a){if(!e||e.predicate(a)){var c={};_.each(_.extend({},a.getAttr(b)),function(a,b){void 0!==a&&(isNaN(parseFloat(a))||(c[b]=a))}),d.push({id:a.id,title:a.title,values:c})}}),h=d.slice(0),d):d},f.addMeasure=function(b){if(!b||""===b.trim())return!1;if(b=b.trim(),_.find(g,function(a){return a.toUpperCase()===b.toUpperCase()}))return!1;var d=c.getActiveContent();d.updateAttr(d.id,a,g.concat([b]))},f.removeMeasure=function(d){if(!d||""===d.trim())return!1;var e,f=_.without(g,d);_.isEqual(f,g)||(e=c.getActiveContent(),e.startBatch(),e.updateAttr(e.id,a,f),e.traverse(function(a){e.mergeAttrProperty(a.id,b,d,!1)}),e.endBatch())},f.validate=function(a){return!isNaN(parseFloat(a))&&isFinite(a)},f.setValue=function(a,d,e){return f.validate(e)?c.getActiveContent().mergeAttrProperty(a,b,d,e):!1},f.getRawData=function(a){var d=c.getActiveContent(),f=[];return d?(f.push(["Name"].concat(g)),d.traverse(function(c){(a||!e||e.predicate(c))&&f.push([c.title].concat(_.map(g,function(a){var d=c.getAttr(b)||{},e=d[a]&&parseFloat(d[a]);return void 0===e||isNaN(e)?void 0:e})))}),f):f},f.removeFilter=function(){e&&e.cleanup&&e.cleanup(),e&&e.removeEventListener&&e.removeEventListener("filteredRowsChanged",j),e=void 0},c.addListener(i),f.editWithFilter(d)},MM.MeasuresModel.filterByIds=function(a){"use strict";return{predicate:function(b){return _.include(a,b.id)}}},MM.MeasuresModel.ActivatedNodesFilter=function(a){"use strict";var b=observable(this),c=a.getActivatedNodeIds(),d=function(d){var e=a.getActivatedNodeIds();(d||c!==e)&&(c=e,b.dispatchEvent("filteredRowsChanged"))},e=d.bind(b,!0);a.addEventListener("activatedNodesChanged",d),a.addEventListener("nodeTitleChanged",e),b.predicate=function(a){return _.include(c,a.id)},b.cleanup=function(){a.removeEventListener("activatedNodesChanged",d),a.removeEventListener("nodeTitleChanged",e)}},MM.measuresModelMediator=function(a,b){"use strict";b.addEventListener("measureEditing",function(b,c){b&&c&&a.selectNode(c,!0,!0),a.setInputEnabled(!b,!0)})},jQuery.fn.addToRowAtIndex=function(a,b){"use strict";var c=jQuery(this),d=a.children("[data-mm-role="+c.data("mm-role")+"]").eq(b);return d.length?c.insertBefore(d):c.appendTo(a),c},jQuery.fn.numericTotaliser=function(){"use strict";var a=jQuery(this),b=a.find("tfoot tr"),c=function(c){var d=0;0!==c&&(a.find("tbody tr").each(function(){var a=jQuery(this),b=parseFloat(a.children().eq(c).text());isNaN(b)||(d+=b)}),b.children().eq(c).text(d))},d=function(){var a;for(a=1;a<b.children().size();a++)c(a)};return a.on("change",function(a){var b=jQuery(a.target);void 0!==a.column?c(a.column):b.is("td")?c(b.index()):d()}),this},jQuery.fn.measuresDisplayControlWidget=function(a,b){"use strict";return jQuery.each(this,function(){var c=jQuery(this),d=c.find("[data-mm-role=measurement-activation-template]"),e=d.parent(),f=c.find("[data-mm-role=hide-measure]"),g=function(f){var g=d.clone().appendTo(e);g.attr("data-mm-measure",f).find("[data-mm-role=show-measure]").click(function(){a.dispatchEvent("measureLabelShown",f),b.setLabelGenerator(function(){return a.addUpMeasurementForAllNodes(f)})}).find("[data-mm-role=measure-name]").text(f),c.show()},h=function(b){e.children('[data-mm-measure="'+b.replace('"','\\"')+'"]').remove(),_.isEmpty(a.getMeasures())&&c.hide()},i=function(){e.children("[data-mm-role=measurement-activation-template]").remove();var b=a.getMeasures();b&&b.length>0?_.each(b,g):c.hide()},j=function(a){e.children().removeClass("mm-active").filter('[data-mm-measure="'+a.replace('"','\\"')+'"]').addClass("mm-active"),a?f.show():f.hide()};i(),a.addEventListener("startFromScratch",i),a.addEventListener("measureAdded",g),a.addEventListener("measureRemoved",h),a.addEventListener("measureLabelShown",j),f.hide().click(function(){b.setLabelGenerator(!1),a.dispatchEvent("measureLabelShown","")})})},jQuery.fn.measuresSheetWidget=function(a){"use strict";return jQuery.each(this,function(){var b=jQuery(this),c=b.find("[data-mm-role=measurements-table]"),d=b.find("[data-mm-role=no-measures]"),e=b.find("[data-mm-role=measurement-template]"),f=e.parent(),g=b.find("[data-mm-role=idea-template]"),h=g.find("[data-mm-role=value-template]").detach(),i=g.parent(),j=b.find("[data-mm-role=measure-to-add]"),k=b.find("[data-mm-role=summary-template]"),l=k.parent(),m=function(a){return b.find('[data-mm-nodeid="'+a+'"]')},n=function(a){return _.map(f.children(),function(a){return jQuery(a).find("[data-mm-role=measurement-name]").text()}).indexOf(a)},o=function(b,g){var h=e.clone().addToRowAtIndex(f,g);h.find("[data-mm-role=measurement-name]").text(b),h.find("[data-mm-role=remove-measure]").click(function(){a.removeMeasure(b)}),k.clone().addToRowAtIndex(l,g).text("0"),c.show(),d.hide()},p=function(b,c){b!==w&&(w=b,a.editingMeasure(b,c))},q=function(b,c,d,e,f){var g=b.children("[data-mm-role=value-template]").eq(f),i=h.clone();return i.text(c||"0").on("change",function(b,c){return a.setValue(d,e,c)}).on("focus",function(){p(!0,d)}).on("blur",function(){p(!1,d)}).keydown("Esc",function(a){i.blur(),a.preventDefault(),a.stopPropagation()}),g.length?i.insertBefore(g):i.appendTo(b),i},r=function(a,b,d){var e=m(a),f=n(b);f>=0&&(e.children().eq(f).text(d),c.trigger(jQuery.Event("change",{column:f})))},s=function(a,b){o(a,b),_.each(i.children(),function(c){q(jQuery(c),"0",jQuery(c).data("mm-nodeid"),a,b)})},t=function(a){f.children().removeClass("mm-active");var b=n(a);b>=0&&f.children().eq(b).addClass("mm-active")},u=function(a){var b=n(a);0>b||(f.children().eq(b).remove(),l.children().eq(b).remove(),_.each(i.children(),function(a){jQuery(a).children().eq(b).remove()}))},v=function(){f.children("[data-mm-role=measurement-template]").remove(),l.children("[data-mm-role=summary-template]").remove();var b=a.getMeasures();b&&b.length>0?(c.show(),d.hide()):(c.hide(),d.show()),_.each(b,function(a){o(a)}),x(b)},w=!1,x=function(c){i.children("[data-mm-role=idea-template]").remove(),_.each(a.getMeasurementValues(),function(a){var b=g.clone().appendTo(i).attr("data-mm-nodeid",a.id);b.find("[data-mm-role=idea-title]").text(function(){var b=jQuery(this).data("mm-truncate");return b&&a.title.length>b?a.title.substring(0,b)+"...":a.title}),_.each(c,function(c){q(b,a.values[c],a.id,c)})}),b.find("[data-mm-role=measurements-table]").trigger("change")},y=function(){x(a.getMeasures())};e.detach(),k.detach(),g.detach(),c.editableTableWidget({editor:b.find("[data-mm-role=measures-editor]"),cloneProperties:jQuery.fn.editableTableWidget.defaultOptions.cloneProperties.concat(["outline","box-shadow","-webkit-box-shadow","-moz-box-shadow"])}).on("validate",function(b,c){return a.editingMeasure(!0),a.validate(c)}).numericTotaliser(),b.find("[data-mm-role=measures-editor]").on("focus",p.bind(b,!0,!1)).on("blur",p.bind(b,!1,!1)),b.on("show",function(){v(),a.addEventListener("startFromScratch",v),a.addEventListener("measureRowsChanged",y),a.addEventListener("measureValueChanged",r),a.addEventListener("measureAdded",s),a.addEventListener("measureRemoved",u)}),b.on("hide",function(){a.removeEventListener("startFromScratch",v),a.removeEventListener("measureRowsChanged",y),a.removeEventListener("measureValueChanged",r),a.removeEventListener("measureAdded",s),a.removeEventListener("measureRemoved",u),b.parent().siblings("[tabindex]").focus()}),b.find("[data-mm-role=measure-to-add]").parent("form").on("submit",function(){return a.addMeasure(j.val()),j.val(""),!1}),a.addEventListener("measureLabelShown",t)})},$.fn.editableTableWidget=function(a){"use strict";return $(this).each(function(){var b,c=$.extend($.fn.editableTableWidget.defaultOptions,a),d=37,e=38,f=39,g=40,h=13,i=27,j=9,k=$(this),l=c.editor.css("position","absolute").hide().appendTo(k.parent()),m=function(a){b=k.find("td:focus"),b.length&&(l.val(b.text()).removeClass("error").show().offset(b.offset()).css(b.css(c.cloneProperties)).width(b.width()).height(b.height()).focus(),a&&l.select())},n=function(){var a,c=l.val(),d=$.Event("change");return b.text()===c||l.hasClass("error")?!0:(a=b.html(),b.text(c).trigger(d,c),void(d.result===!1&&b.html(a)))},o=function(a,b){return b===f?a.next("td"):b===d?a.prev("td"):b===e?a.parent().prev().children().eq(a.index()):b===g?a.parent().next().children().eq(a.index()):[]};l.blur(function(){n(),l.hide()}).keydown(function(a){if(a.which===h)n(),l.hide(),b.focus(),a.preventDefault(),a.stopPropagation();else if(a.which===i)l.val(b.text()),a.preventDefault(),a.stopPropagation(),l.hide(),b.focus();else if(a.which===j)b.focus();else if(this.selectionEnd-this.selectionStart===this.value.length){var c=o(b,a.which);c.length>0&&(c.focus(),a.preventDefault(),a.stopPropagation())}}).on("input paste",function(){var a=$.Event("validate");b.trigger(a,l.val()),a.result===!1?l.addClass("error"):l.removeClass("error")}),k.on("click keypress dblclick",m).css("cursor","pointer").keydown(function(a){var b=!0,c=o($(a.target),a.which);c.length>0?c.focus():a.which===h?m(!1):17===a.which||91===a.which||93===a.which?(m(!0),b=!1):b=!1,b&&(a.stopPropagation(),a.preventDefault())}),k.find("td").prop("tabindex",1),$(window).on("resize",function(){l.is(":visible")&&l.offset(b.offset()).width(b.width()).height(b.height())})})},$.fn.editableTableWidget.defaultOptions={cloneProperties:["padding","padding-top","padding-bottom","padding-left","padding-right","text-align","font","font-size","font-family","font-weight","border","border-top","border-bottom","border-left","border-right"],editor:$("<input>")},jQuery.fn.modalConfirmWidget=function(){"use strict";var a,b=this,c=b.find("[data-mm-role=title]"),d=b.find("[data-mm-role=explanation]"),e=b.find("[data-mm-role=confirm]"),f=function(){a&&(a.resolve(),a=void 0)};return b.modal({keyboard:!0,show:!1}),e.click(function(){f()}),e.keydown("space",function(){f(),b.hide()}),this.showModalToConfirm=function(f,g,h){return a=jQuery.Deferred(),c.text(f),d.html(g),e.text(h),b.modal("show"),a.promise()},this.on("shown",function(){e.focus()}),this.on("hidden",function(){a&&(a.reject(),a=void 0)}),this},jQuery.fn.modalLauncherWidget=function(a){"use strict";return this.each(function(){var b,c=jQuery(this),d=c.data("mm-launch-key-code");c.on("show",function(c){this===c.target&&(b=jQuery(":focus"),0===b.length&&(b=jQuery(document.activeElement)),b.blur(),a.setInputEnabled(!1,!1))}).on("hide",function(c){this===c.target&&(a.setInputEnabled(!0,!1),b&&b.length>0?b.focus():jQuery(document).focus(),b=void 0)}).on("shown",function(a){this===a.target&&c.find("[data-mm-modal-shown-focus]").focus()}),d&&jQuery(document).keydown(function(a){0!==c.parent().length&&(String(a.which)!==String(d)||!a.metaKey&&!a.ctrlKey||a.altKey||(a.preventDefault(),a.stopImmediatePropagation(),jQuery(".modal:visible").length>0||c.modal("show")))})})},MM.navigationDelimiters=",;#",MM.navigationEscape=function(a,b){"use strict";if(!a)return a;var c="["+MM.navigationDelimiters+"]+",d=new RegExp(c,"g");return b=b||"_",a.replace(d,b)},MM.navigation=function(a,b){"use strict";var c=this,d="nil",e="[Mm]:([^"+MM.navigationDelimiters+"]*)",f=new RegExp(e),g=function(){var a=window&&window.location&&window.location.hash,b=a&&f.exec(a);return b&&b[1]},h=function(a){window.location.hash=f.test(window.location.hash)?window.location.hash.replace(f,"m:"+a):window.location.hash&&"#"!==window.location.hash?window.location.hash+",m:"+a:"m:"+a},i=function(b){return b&&a.setItem("mostRecentMapLoaded",b),b=b||d,h(b),!0};return c.initialMapId=function(){var b=g();return b&&b!==d||(b=a&&a.getItem&&a.getItem("mostRecentMapLoaded")),b},c.loadInitial=function(){var a=c.initialMapId();return b.loadMap(a||"new"),a},b.addEventListener("mapSaved mapLoaded mapLoadingCancelled",function(a){i(a)}),c.hashChange=function(){var a=g();if(a!==d)return a?(b.loadMap(a),!0):(i(b.currentMapId()),!1)},c.off=function(){window.removeEventListener("hashchange",c.hashChange)},c.on=function(){window.addEventListener("hashchange",c.hashChange)},c.on(),c},jQuery.fn.newMapWidget=function(a){"use strict";return this.click(function(){var b=jQuery(this).attr("data-mm-map-source")||"";a.loadMap("new-"+b+"-"+Date.now())}),this},jQuery.fn.optionalContentWidget=function(a,b){"use strict";var c=function(c,d){(c||a.getInputEnabled())&&b.toggle(d)};return jQuery.each(this,function(){var a=jQuery(this),b=a.attr("id");jQuery(document).keydown(a.attr("data-mm-activation-key"),c.bind(a,!1,b)),jQuery("[data-mm-role="+a.attr("data-mm-activation-role")+"]").click(c.bind(a,!0,b)),a.is(":visible")&&a.trigger("show")})},jQuery.fn.remoteExportWidget=function(a,b,c,d,e,f){"use strict";var g,h,i="download"in document.createElement("a")?$("<a>").addClass("hide").appendTo("body"):void 0,j=function(a){var b,c=atob(a.split(",")[1]),d=a.split(",")[0].split(":")[1].split(";")[0],e=new ArrayBuffer(c.length),f=new Uint8Array(e);for(b=0;b<c.length;b++)f[b]=c.charCodeAt(b);return new window.Blob([e],{type:d})},k=function(a,b){var c=window.URL||window.webkitURL;return c.createObjectURL(/^data:[a-z]*\/[a-z]*/.test(a)?j(a):new window.Blob([a],{type:b}))};return a.addEventListener("mapLoaded",function(a,b){h=b}),this.click(function(){var a,l,m=function(a,b){return function(){return jQuery.Deferred().resolve(a.apply(void 0,arguments),b).promise()}},n={mup:m(function(a){return JSON.stringify(a,null,2)},"application/json"),mm:m(MM.freemindExport,"text/xml"),html:MM.exportToHtmlDocument,png:MAPJS.pngExport,txt:m(MM.exportIdeas.bind({},h,new MM.TabSeparatedTextExporter),"text/plain"),"measures-all":m(function(){return MM.exportTableToText(c.getRawData(!0))},"text/tab-separated-values"),measures:m(function(){return MM.exportTableToText(c.getRawData())},"text/tab-separated-values")},o=$(this).data("mm-format"),p=$(this).data("mm-extension")||o,q=function(){b&&g&&(b.hide(g),g=void 0)},r=function(a,c){q(),g=b.show(a,c,"error")};a=h.title+"."+p,b&&(q(),g=b.show('<i class="icon-spinner icon-spin"></i>&nbsp;Exporting map',"This may take a few seconds for larger maps","info")),l=$(this),n[o]&&n[o](h).then(function(c,h){var l=c;return l?void(i&&!$("body").hasClass("force-remote")?(q(),i.attr("download",a).attr("href",k(l,h)),i[0].click()):(/^data:[a-z]*\/[a-z]*/.test(l)?(l=j(l),h=l.type):h="application/octet-stream",d.generateEchoConfiguration(p,h).then(function(a){e.save(l,a,{isPrivate:!0}).then(function(){q(),g=b.show("Your map was exported.",' <a href="'+a.signedOutputUrl+'" target="_blank">Click here to open the file, or right-click and choose "save link as"</a>',"success")},function(a){"file-too-large"===a?(q(),f.showModalToConfirm("Remote export",'Your browser requires a remote export and this map exceeds your upload limit. To export the map, please use a browser which supports in-browser downloads (such as Chrome or Firefox) or enter a MindMup Gold license to increase your limit.<br/><br/>If you are a Gold user and you see this message, please contact us at <a href="mailto:contact@mindmup.com">contact@mindmup.com</a> to arrange an offline export.',"Subscribe to Mindmup Gold").then(function(){jQuery("#modalGoldLicense").modal("show")})):r("Unfortunately, there was a problem exporting the map.","Please try again later. We have sent an error report and we will look into this as soon as possible")})},function(){r("Unfortunately, there was a problem exporting the map.","Please try again later. We have sent an error report and we will look into this as soon as possible")}))):!1})})},MM.ResourceCompressor=function(a){"use strict";var b=this,c=a+":",d=new RegExp("^"+c),e=function(a){if(a.resources){var b={};_.map(a.resources,function(a,c){b[c]=!0}),a.traverse(function(a){var d=a&&a.attr&&a.attr.icon&&a.attr.icon.url;d&&delete b[d.substring(c.length)]}),_.each(b,function(b,c){delete a.resources[c]})}},f=function(a){a.traverse(function(b){var e=b&&b.attr&&b.attr.icon&&b.attr.icon.url;e&&!d.test(e)&&(b.attr.icon.url=c+a.storeResource(e))})};b.compress=function(a){f(a),e(a)}},MM.retry=function(a,b,c){"use strict";var d=jQuery.Deferred(),e=function(){a().then(d.resolve,function(){!b||b.apply(void 0,arguments)?(d.notify("Network problem... Will retry shortly"),c?setTimeout(e,c()):e()):d.reject.apply(void 0,arguments)},d.notify)};return e(),d.promise()},MM.retryTimes=function(a){"use strict";return function(){return a--}},MM.linearBackoff=function(){"use strict";var a=0;return function(){return a++,1e3*a}},MM.RetriableMapSourceDecorator=function(a){"use strict";var b=function(a){var b=MM.retryTimes(a);return function(a){return b()&&"network-error"===a}};this.loadMap=function(c,d){return MM.retry(a.loadMap.bind(a,c,d),b(5),MM.linearBackoff())},this.saveMap=function(c,d,e){return MM.retry(a.saveMap.bind(a,c,d,e),b(5),MM.linearBackoff())},this.description=a.description,this.recognises=a.recognises,this.autoSave=a.autoSave},MM.S3Api=function(){"use strict";var a=this;this.save=function(a,b,c){var d=new FormData,e=c&&c.isPrivate?"bucket-owner-read":"public-read",f=jQuery.Deferred(),g=function(a){var b,c,d,e={EntityTooLarge:"file-too-large"};if(403===a.status)return void f.reject("failed-authentication");try{b=a&&(a.responseXML||jQuery.parseXML(a.responseText)),c=jQuery(b).find("Error Code").text()}catch(g){}return c?(d=jQuery(b).find("Error Message").text(),void f.reject(e[c],d)):void f.reject("network-error")};return["key","AWSAccessKeyId","policy","signature"].forEach(function(a){d.append(a,b[a])}),d.append("acl",e),d.append("Content-Type",b["Content-Type"]||"text/plain"),d.append("file",a),jQuery.ajax({url:"https://"+b.s3BucketName+".s3.amazonaws.com/",type:"POST",processData:!1,contentType:!1,data:d}).then(f.resolve,g),f.promise()},a.pollerDefaults={sleepPeriod:1e3,timeoutPeriod:12e4},a.poll=function(b,c){var d,e,f=jQuery.Deferred(),g=function(){return f&&!(c.stoppedSemaphore&&c.stoppedSemaphore())},h=function(){var a=function(){g()&&(c.sleepTimeoutId=window.setTimeout(h,c.sleepPeriod))};g()?jQuery.ajax({url:b,timeout:c.sleepPeriod,method:"GET"}).then(function(b){var c=jQuery(b).find("Contents Key").first().text();f&&c?(window.clearTimeout(e),f.resolve(c)):a()},a):window.clearTimeout(e)},i=function(){g()&&f.reject("polling-timeout"),window.clearTimeout(d),f=void 0};return c=_.extend({},a.pollerDefaults,c),g()&&(e=window.setTimeout(i,c.timeoutPeriod),h()),f.promise()},a.loadUrl=function(a){var b=jQuery.Deferred();return jQuery.ajax(a,{cache:!1}).then(b.resolve,function(a){b.reject(404===a.status||403===a.status?"map-not-found":"network-error")}),b.promise()}},MM.S3ConfigGenerator=function(a,b,c){"use strict";this.generate=function(){var c=jQuery.Deferred(),d={url:b,dataType:"json",type:"POST",processData:!1,contentType:!1};return jQuery.ajax(d).then(function(b){b.s3Url=a,b.mapId=b.s3UploadIdentifier,c.resolve(b)},c.reject.bind(c,"network-error")),c.promise()},this.buildMapUrl=function(b){return jQuery.Deferred().resolve(a+c+b+".json").promise()}},MM.S3FileSystem=function(a,b,c){"use strict";var d,e={editable:!0},f=new MM.S3Api;this.description=c,this.prefix=b,this.recognises=function(a){return a&&a[0]===b
},this.loadMap=function(c,d){var g=jQuery.Deferred(),h=function(a){g.resolve(a,c,"application/json",e)};return a.buildMapUrl(c,b,d).then(function(a){f.loadUrl(a).then(h,g.reject)},g.reject),g.promise()},this.saveMap=function(c,g,h,i){var j=jQuery.Deferred(),k=function(a){d=a,f.save(c,a,{isPrivate:!1}).then(function(){j.resolve(a.mapId,_.extend(a,e))},j.reject)};return a.generate(g,h,b,i).then(k,j.reject),j.promise()},this.destroyLastSave=function(){return f.save('{"title": "This map was removed by its author"}',d,{isPrivate:!1})}},jQuery.fn.saveWidget=function(a){"use strict";var b,c,d=!1,e=jQuery(this),f=e.find("button[data-mm-role=publish]"),g=function(){f.attr("disabled")&&(f.text("Save").addClass("btn-primary").removeAttr("disabled"),e.find(".dropdown-toggle").removeAttr("disabled"))},h=function(){d=!0,g()},i=function(c){var d=a.validMapSourcePrefixesForSaving,f=_.map(d,function(a){return"repo-"+a+" "}).join("");b=c&&c[0],/^new-/.test(c)&&c.length>4&&(b=c[4]),_.contains(d,b)||(b=d[0]),e.find("[data-mm-role=currentrepo]").removeClass(f).addClass("repo repo-"+b)};return $(window).keydown(function(e){83!==e.which||!e.metaKey&&!e.ctrlKey||e.altKey||(!c&&d&&a.publishMap(b),e.preventDefault())}),e.find("[data-mm-role=publish]").add("a[data-mm-repository]",e).click(function(){a.publishMap($(this).attr("data-mm-repository")||b)}),e.find("a[data-mm-repository]").addClass(function(){return"repo repo-"+$(this).data("mm-repository")}),a.addEventListener("mapSaving",function(){f.html('<i class="icon-spinner icon-spin"></i>&nbsp;Saving').attr("disabled",!0).removeClass("btn-primary"),e.find(".dropdown-toggle").attr("disabled",!0)}),a.addEventListener("mapSavingFailed mapSavingUnAuthorized authorisationFailed authRequired mapSavingCancelled mapSavingTooLarge",g),a.addEventListener("mapLoaded mapSaved",function(a,b,g){i(a),d=!1,f.text("Save").attr("disabled",!0).removeClass("btn-primary"),e.find(".dropdown-toggle").removeAttr("disabled"),c=g.autoSave,c?f.text(" Auto-saved"):b.addEventListener("changed",h)}),e},jQuery.fn.scalableModalWidget=function(){"use strict";return jQuery.each(this,function(){var a=jQuery(this),b=function(){a.find(".modal-body").css("max-height","none").height(a.height()-a.find(".modal-header").outerHeight(!0)-a.find(".modal-footer").outerHeight(!0))};a.on("shown",b),jQuery(window).on("resize",function(){a.is(":visible")&&b()})})},$.fn.searchWidget=function(a,b){"use strict";var c=this,d=function(){if(b.getInputEnabled()){var a,d=function(){a&&a.remove(),b.setInputEnabled(!0)},e=function(a){var c=a.substring(0,a.indexOf(":"));d(),b.centerOnNode(c)};b.setInputEnabled(!1),a=$('<input type="text" autocomplete="off" placeholder="Type a part of the node title">').css("position","absolute").css("z-index","9999").appendTo(c).css("top","30%").css("left","40%").css("width","20%").css("border-width","5px").focus().blur(d).keyup("Esc",d).typeahead({source:function(a){return _.map(b.search(a),function(a){return a.id+":"+a.title})},updater:e,highlighter:function(a){return a.replace(/[^:]+:/,"")}})}};return c.keydown(a,function(a){d(),a.preventDefault(),a.stopPropagation()}).find("[data-mm-role=show-map-search]").click(d),c},jQuery.fn.selectableReadOnlyInputWidget=function(){"use strict";return this.css("cursor","pointer").on("input change",function(){var a=jQuery(this);a.val(a.attr("data-mm-val"))}).click(function(){this.setSelectionRange?this.setSelectionRange(0,this.value.length):this.select&&this.select()})},jQuery.fn.splitFlipWidget=function(a,b,c,d){"use strict";var e=jQuery(this),f=function(b){(b||c.isEditingEnabled())&&a.flip()};return _.each(e.find(b),function(a){var b=jQuery(a);b.click(function(){f(!0)})}),e.keydown(d,f.bind(e,!1)),e},MM.SplittableController=function(a,b,c,d,e){"use strict";var f=observable(this),g=[MM.SplittableController.NO_SPLIT,MM.SplittableController.ROW_SPLIT,MM.SplittableController.COLUMN_SPLIT],h=function(){return a.innerHeight()>a.innerWidth()?MM.SplittableController.ROW_SPLIT:MM.SplittableController.COLUMN_SPLIT};f.split=function(c){return _.contains(g,c)?(a.removeClass(g.join(" ")).addClass(c),this.dispatchEvent("split",c),b.centerOnNode(b.getCurrentlySelectedIdeaId()),!0):!1},f.currentSplit=function(){var b=_.find(g,function(b){return a.hasClass(b)});return b||MM.SplittableController.NO_SPLIT},f.toggle=function(b){b===c[d]?f.currentSplit()===MM.SplittableController.NO_SPLIT?(f.split(h()),a.find("#"+b).trigger("show")):(f.split(MM.SplittableController.NO_SPLIT),a.find("#"+b).trigger("hide")):(a.find("[data-mm-role=optional-content]").hide(),a.find("#"+b).show(),f.currentSplit()===MM.SplittableController.NO_SPLIT?f.split(h()):a.find("#"+c[d]).trigger("hide"),a.find("#"+b).trigger("show")),c[d]=b},f.flip=function(){var a=f.currentSplit();return a===MM.SplittableController.NO_SPLIT?!1:f.split(a===MM.SplittableController.ROW_SPLIT?MM.SplittableController.COLUMN_SPLIT:MM.SplittableController.ROW_SPLIT)},a.find("[data-mm-role=optional-content]").hide(),c[d]||(c[d]=e),a.find("#"+c[d]).show()},MM.SplittableController.NO_SPLIT="no-split",MM.SplittableController.COLUMN_SPLIT="column-split",MM.SplittableController.ROW_SPLIT="row-split",MM.StoryboardController=function(a){"use strict";var b=observable(this),c=function(a,b,c){var d,e={};return e[a]=b,d={storyboards:e},c&&(d.type=c),d},d=function(b,d,e,f){var g=a.getScenesForNodeId(d),h=c(b,e,f);g.push(h),a.setScenesForNodeId(d,g)};b.addScene=function(b,c,e){var f=a.getActiveStoryboardName(),g=1;f||(f=a.createStoryboard()),g=c?a.insertionIndexBefore(c):a.nextSceneIndex(),g?d(f,b,g,e):a.rebalanceAndApply([c],function(c){d(f,b,a.insertionIndexBefore(c[0]),e)})},b.moveSceneAfter=function(b,c){if(!b)return!1;var d,e,f,g,h=a.getActiveStoryboardName();if(c&&c.ideaId===b.ideaId&&c.index===b.index)return!1;if(d=a.getScenes(),!d||!d.length)return!1;if(f=_.indexOf(d,_.find(d,function(a){return a.ideaId===b.ideaId&&a.index===b.index})),-1===f)return!1;if(c){if(f>0&&(g=_.indexOf(d,_.find(d,function(a){return a.ideaId===c.ideaId&&a.index===c.index})),f===g+1))return!1;e=a.insertionIndexAfter(c)}else{if(0===f)return!1;e=a.insertionIndexAfter()}return e?a.updateSceneIndex(b,e,h):a.rebalanceAndApply([b,c],function(b){a.updateSceneIndex(b[0],a.insertionIndexAfter(b[1]),h)}),!0},b.removeScenesForIdeaId=function(b){var c,d=a.getActiveStoryboardName(),e=d&&a.getScenesForNodeId(b);return d?(_.each(e,function(a){a.storyboards&&a.storyboards[d]&&(delete a.storyboards[d],c=!0)}),c?(e=_.reject(e,function(a){return 0===_.size(a.storyboards)}),a.setScenesForNodeId(b,e),!0):!1):!1},b.removeScene=function(b){if(!b||!b.ideaId||!b.index)return!1;var c=a.getActiveStoryboardName(),d=c&&a.getScenesForNodeId(b.ideaId);return c?(_.each(d,function(a){a.storyboards&&a.storyboards[c]&&a.storyboards[c]===b.index&&delete a.storyboards[c]}),d=_.reject(d,function(a){return 0===_.size(a.storyboards)}),void a.setScenesForNodeId(b.ideaId,d)):!1}},MM.StoryboardDimensionProvider=function(a){"use strict";var b=this,c=jQuery("<div>").attr("data-mm-role","storyboard-sizer").addClass("storyboard-scene-title").css({"z-index":"-99",visibility:"hidden"}),d=function(a,b,d){c.css({"max-width":b}).appendTo("body").text(a);var e={fontSize:.5*d},f=.9;do e.fontSize=Math.floor(e.fontSize*f),e.lineHeight=Math.floor(1.3*e.fontSize),c.css("font-size",e.fontSize+"px"),c.css("line-height",e.lineHeight+"px");while((c.height()>d||c[0].scrollWidth>b)&&e.fontSize>d/30);return e.textWidth=c.width(),c.detach(),e},e=function(a){var b=/\n-/.test(a);return b};b.getDimensionsForScene=function(b,c,f){var g,h,i=c/16,j={text:{height:f-2*i,width:c-2*i,"padding-top":i,"padding-bottom":i,"padding-left":i,"padding-right":i,toCss:function(){return _.extend({"font-size":j.text.fontSize+"px","line-height":j.text.lineHeight+"px"},_.omit(j.text,"fontSize","lineHeight"))}},image:{toCss:function(){return{"background-image":"","background-repeat":"","background-size":"","background-position":""}}}},k=1,l=f,m=c;return b.image&&("top"===b.image.position||"bottom"===b.image.position?(l=f/2-i,j.text["padding-"+b.image.position]=f/2,j.text.height=f/2-i):("left"===b.image.position||"right"===b.image.position)&&(m=c/2-i,j.text["padding-"+b.image.position]=c/2,j.text.width=c/2-i),k=m/b.image.width,k>l/b.image.height&&(k=l/b.image.height),j.image={url:b.image.url,height:k*b.image.height,width:k*b.image.width},"top"===b.image.position?(j.image.top=.25*f-.5*j.image.height,j.image.left=(c-j.image.width)/2):"bottom"===b.image.position?(j.image.top=.75*f-.5*j.image.height,j.image.left=(c-j.image.width)/2):"left"===b.image.position?(j.image.top=(f-j.image.height)/2,j.image.left=(c/2-j.image.width)/2):"right"===b.image.position?(j.image.top=(f-j.image.height)/2,j.image.left=.75*c-.5*j.image.width):(j.image.top=(f-j.image.height)/2,j.image.left=(c-j.image.width)/2),j.image.toCss=function(){return{"background-image":'url("'+a.getResource(b.image.url)+'")',"background-repeat":"no-repeat","background-size":k*b.image.width+"px "+k*b.image.height+"px","background-position":j.image.left+"px "+j.image.top+"px"}}),e(b.title)&&(j.text["text-align"]="left"),g=d(b.title,j.text.width,j.text.height),j.text.fontSize=g.fontSize,j.text.lineHeight=g.lineHeight,h=(j.text.width-g.textWidth)/2,h>0&&(j.text.width=g.textWidth,j.text["padding-left"]+=h,j.text["padding-right"]+=h),j}},MM.buildStoryboardExporter=function(a,b,c){"use strict";return function(){var d=a.getScenes();return _.isEmpty(d)?{}:{storyboard:_.map(d,function(a){var d=_.extend({title:a.title},b.getDimensionsForScene(a,800,600));return d.image&&d.image.url&&(d.image.url=c(d.image.url)),d})}}},MM.Storyboard={},MM.Storyboard.scene=function(a){"use strict";return a?(a.matchesScene=function(b){return a&&b?a.ideaId!=b.ideaId?!1:a.index!==b.index?!1:!0:!1},a.clone=function(){return MM.Storyboard.scene(_.extend({},a))},a):void 0},MM.Storyboard.sceneList=function(a){"use strict";return a?(a.findScene=function(b){return b?(MM.Storyboard.scene(b),_.find(a,function(a){return b.matchesScene(a)})):void 0},a.indexOfScene=function(b){if(!b)return-1;var c=a.findScene(b);return c?_.indexOf(a,c):-1},a.nextSceneIndex=function(){var b=_.max(a,function(a){return a&&a.index});return b&&b.index?b.index+1:1},a):void 0},MM.StoryboardModel=function(a,b,c){"use strict";var d,e,f=observable(this),g=function(){var b=f.getActiveStoryboardName(),d=[],g=function(a,b){var c=a.title;return"with-children"===b&&_.each(a.sortedSubIdeas(),function(a){c=c+"\n- "+a.title}),c};return b?(a.getActiveContent().traverse(function(a){var e=a.getAttr(c);e&&_.each(e,function(c){var e,f,h=parseFloat(c.storyboards[b]);h&&(e={ideaId:a.id,title:g(a,c.type),index:h},f=a.getAttr("icon"),f&&(e.image=f),d.push(e))})}),void(e=MM.Storyboard.sceneList(_.sortBy(d,"index")))):void(e=MM.Storyboard.sceneList(d))},h=function(a,b){return Math.abs(a-b)<1e-4},i=function(a){if(!a)return 0;var b=a.length;return _.each(a,function(a){var c=a.match(/^Storyboard ([1-9]+)/),d=c&&c.length>1&&parseFloat(c[1])||0;d>b&&(b=d)}),b},j=function(){var a,b=e,c=function(a,b){var c={removed:[],added:[],contentUpdated:[]};return MM.Storyboard.sceneList(a),MM.Storyboard.sceneList(b),_.each(a,function(a){var d=b&&b.findScene(a);d?d.title===a.title&&_.isEqual(d.image,a.image)||c.contentUpdated.push(d):c.removed.push(a)}),_.each(b,function(b){var d=a&&a.findScene(b);d||c.added.push(b)}),1===c.added.length&&1===c.removed.length&&0===c.contentUpdated.length&&c.added[0].ideaId===c.removed[0].ideaId?{moved:{from:c.removed[0],to:c.added[0]}}:c};g(),a=c(b,e),_.each(a.removed,function(a){f.dispatchEvent("storyboardSceneRemoved",a)}),_.each(a.added,function(a){f.dispatchEvent("storyboardSceneAdded",a)}),_.each(a.contentUpdated,function(a){f.dispatchEvent("storyboardSceneContentUpdated",a)}),a.moved&&f.dispatchEvent("storyboardSceneMoved",a.moved)};f.setInputEnabled=function(a){d=a,f.dispatchEvent("inputEnabled",a)},f.getInputEnabled=function(){return d},f.getActiveStoryboardName=function(){var c=a&&a.getActiveContent(),d=c&&c.getAttr(b);return d&&d.length>0?d[0]:void 0},f.createStoryboard=function(){var c=a&&a.getActiveContent(),d=c&&c.getAttr(b)||[],e=i(d),f="Storyboard "+(e+1);if(c)return d.push(f),c.updateAttr(c.id,b,d),f},f.nextSceneIndex=function(){return e&&e.nextSceneIndex()},f.updateSceneIndex=function(a,b,c){var d=f.getScenesForNodeId(a.ideaId);return _.each(d,function(d){d.storyboards&&d.storyboards[c]&&d.storyboards[c]===a.index&&(d.storyboards[c]=b)}),f.setScenesForNodeId(a.ideaId,d),_.extend({},a,{index:b})},f.getScenesForNodeId=function(b){var d=a.getActiveContent().getAttrById(b,c)||[];return JSON.parse(JSON.stringify(d))},f.setScenesForNodeId=function(b,d){a.getActiveContent().updateAttr(b,c,d)},f.scenesMatch=function(a,b){return a&&b?a.ideaId!==b.ideaId?!1:a.index!==b.index?!1:!0:!1},f.rebalance=function(a){var b=[],c=1,d=f.getActiveStoryboardName();return _.each(e,function(e){var g=_.find(a,function(a){return f.scenesMatch(e,a)}),h=void 0!==g?_.indexOf(a,g):-1,i=f.updateSceneIndex(e,c,d);c++,h>=0&&(b[h]=i)}),b},f.rebalanceAndApply=function(b,c){var d,e=a.getActiveContent();e.startBatch(),d=f.rebalance(b),j(),c(d),e.endBatch()},f.insertionIndexAfter=function(a){var b,c,d,f=function(){var a;return 0===e.length?!1:(a=e[0].index/2,h(a,e[0].index)?!1:a)};return a?(b=_.indexOf(e,_.find(e,function(b){return b.ideaId===a.ideaId&&b.index===a.index})),0>b?!1:b===e.length-1?a.index+1:(c=e[b+1].index,d=(a.index+c)/2,h(d,c)||h(d,a.index)?!1:d)):f()},f.insertionIndexBefore=function(a){var b,c,d=0;return a?(b=e.indexOfScene(a),0>b?!1:(0!==b&&(d=e[b-1].index),c=(a.index+d)/2,h(c,d)||h(c,a.index)?!1:c)):!1},f.getScenes=function(){return e},a.addListener(j)},jQuery.fn.updateScene=function(a,b){"use strict";var c=b.getDimensionsForScene(a,this.innerWidth(),this.innerHeight());return this.find("[data-mm-role=scene-title]").text(a.title).css(c.text.toCss()),this.css(c.image.toCss()),this},jQuery.fn.scrollSceneIntoFocus=function(){"use strict";return this.siblings(".activated-scene").removeClass("activated-scene"),this[0].scrollIntoView(),this.addClass("activated-scene"),this},jQuery.fn.storyboardWidget=function(a,b,c,d){"use strict";return jQuery.each(this,function(){var e=jQuery(this),f=e.find("[data-mm-role=scene-template]"),g=e.find("[data-mm-role=no-scenes]").detach(),h=f.parent(),i=function(){_.each(h.find(".activated-scene"),function(b){var c=jQuery(b).data("scene");c&&a.removeScene(c)})},j=function(b){var c=b&&b.data("scene"),d=c&&b.prev()&&b.prev().prev(),e=d&&d.data("scene");c&&a.moveSceneAfter(c,e)},k=function(b){var c=b&&b.data("scene"),d=c&&b.next(),e=d&&d.data("scene");c&&e&&a.moveSceneAfter(c,e)},l=function(){j(h.find(".activated-scene"))},m=function(){k(h.find(".activated-scene"))},n=function(a){if(!a.gesture||!a.gesture.center)return!1;var b=e.offset(),c=a.gesture.center.pageX-b.left,d=a.gesture.center.pageY-b.top;return c>0&&c<e.width()&&d>0&&d<e.height()},o=function(a,b){var c=b?h.find("[data-mm-role=scene]").not(".drag-shadow"):h.find("[data-mm-role=scene]").not(".activated-scene").not(".drag-shadow"),d=_.filter(c,function(b){var c=jQuery(b),d=a.top-c.offset().top,e=c.outerHeight(!0),f=d>0&&e>d;return f}),e=_.filter(d,function(b){var c=jQuery(b),d=a.left-c.offset().left,e=c.outerWidth(!0),f=d>-40&&e/3>d;return f}),f=_.filter(d,function(b){var c=jQuery(b),d=a.left-c.offset().left,e=c.outerWidth(!0),f=d>2*e/3&&e+40>d;return f}),g=jQuery(_.last(d)),i=c.last();return 0===f.length&&0===e.length&&(g.length>0&&a.left>g.offset().left+g.width()?f=g:i.length>0&&a.top>i.offset().top&&(f=i)),{left:_.first(f),right:_.first(e)}},p=function(){var a=b.getScenes();h.empty(),a&&a.length?_.each(a,function(a){r(a,!0)}):g.appendTo(h).show()},q=function(a){var b=_.reject(h.children(),function(b){return!jQuery(b).data("scene")||a<jQuery(b).data("scene").index});return _.last(b)},r=function(b,e,i){var l=f.clone().data("scene",b).attr({"data-mm-role":"scene","data-mm-idea-id":b.ideaId,"data-mm-index":b.index,tabindex:1}).on("focus",function(){h.find("[data-mm-role=scene]").removeClass("activated-scene"),l.addClass("activated-scene")}).on("tap",function(){d.focusAndSelect(b.ideaId)}).keydown("del backspace",function(c){a.removeScene(b),c.preventDefault(),c.stopPropagation()}).keydown("meta+right ctrl+right",function(){k(jQuery(this))}).keydown("meta+left ctrl+left",function(){j(jQuery(this))}).keydown("right",function(){jQuery(this).next().focus()}).keydown("left",function(){jQuery(this).prev().focus()}).keydown("up",function(){jQuery(this).gridUp().focus()}).on("doubletap",function(){d.focusAndSelect(b.ideaId),d.editNode(b.ideaId)}).keydown("down",function(){jQuery(this).gridDown().focus()}).shadowDraggable().on("mm:cancel-dragging",function(){jQuery(this).siblings().removeClass("potential-drop-left potential-drop-right")}).on("mm:stop-dragging",function(){var b=jQuery(this),c=b.parent().find(".potential-drop-left"),d=b.parent().find(".potential-drop-right");c&&c[0]?a.moveSceneAfter(b.data("scene"),c.data("scene")):d&&d[0]&&(c=d.prev(),c&&c[0]?a.moveSceneAfter(b.data("scene"),c.data("scene")):a.moveSceneAfter(b.data("scene"))),jQuery(this).siblings().removeClass("potential-drop-left potential-drop-right")}).on("mm:drag",function(a){if(a&&a.gesture&&a.gesture.center){var b,c,d=o({left:a.gesture.center.pageX,top:a.gesture.center.pageY}),e=jQuery(this);d.left?(b=jQuery(d.left).not(e).not(e.prev()),c=b.next()):d.right&&(c=jQuery(d.right).not(e).not(e.next()),b=c.prev()),e.siblings().not(b).removeClass("potential-drop-left"),e.siblings().not(c).removeClass("potential-drop-right"),c&&c.addClass("potential-drop-right"),b&&b.addClass("potential-drop-left")}}),m=!e&&q(b.index);g.detach(),l.hide(),m?l.insertAfter(m):e?l.appendTo(h):l.prependTo(h),l.updateScene(b,c),e?l.show():(l.finish(),l.fadeIn({duration:100,complete:function(){i?l.focus():l.scrollSceneIntoFocus()}}))},s=function(a){return h.find('[data-mm-role=scene][data-mm-index="'+a.index+'"][data-mm-idea-id="'+a.ideaId+'"]')},t=function(a){var b,c=s(a),d=c.is(":focus"),e=c.hasClass("activated-scene");(d||e)&&(b=c.prev(),0===b.length&&(b=c.next()),d?b.focus():e&&0===jQuery(":focus").length&&b.focus()),c.finish(),c.fadeOut({duration:100,complete:function(){c.remove()}})},u=function(a){s(a).updateScene(a,c)},v=function(a){var b=s(a.from),c=b.is(":focus");b.finish(),b.fadeOut({duration:100,complete:function(){b.remove(),r(a.to,!1,c)}})},w=function(){b.setInputEnabled(!0),p(),b.addEventListener("storyboardSceneAdded",r),b.addEventListener("storyboardSceneMoved",v),b.addEventListener("storyboardSceneRemoved",t),b.addEventListener("storyboardSceneContentUpdated",u)},x=function(){b.setInputEnabled(!1),b.removeEventListener("storyboardSceneAdded",r),b.removeEventListener("storyboardSceneMoved",v),b.removeEventListener("storyboardSceneRemoved",t),b.removeEventListener("storyboardSceneContentUpdated",u)};f.detach(),e.find("[data-mm-role=storyboard-remove-scene]").click(i),e.find("[data-mm-role=storyboard-move-scene-left]").click(l),e.find("[data-mm-role=storyboard-move-scene-right]").click(m),e.on("show",w).on("hide",x),e.parents("[data-drag-role=container]").on("mm:drag",function(a){if(!n(a))return void h.find("[data-mm-role=scene]").removeClass("potential-drop-left potential-drop-right");if("node"===jQuery(a.target).attr("data-mapjs-role")){var b,c,d=o({left:a.gesture.center.pageX,top:a.gesture.center.pageY},!0),e=h.find("[data-mm-role=scene]");d.left?(b=jQuery(d.left),c=b.next()):d.right&&(c=jQuery(d.right),b=c.prev()),e.not(b).removeClass("potential-drop-left"),e.not(c).removeClass("potential-drop-right"),c&&c.addClass("potential-drop-right"),b&&b.addClass("potential-drop-left")}}).on("mm:stop-dragging",function(b){var c,d=jQuery(b.target);"node"===d.attr("data-mapjs-role")&&n(b)&&(c=h.find(".potential-drop-right"),a.addScene(d.data("nodeId"),c&&c.data("scene"))),h.children().removeClass("potential-drop-left potential-drop-right")}).on("mm:cancel-dragging",function(){h.children().removeClass("potential-drop-left potential-drop-right")})})},jQuery.fn.storyboardKeyHandlerWidget=function(a,b,c,d){"use strict";var e=this,f=function(b){var e=b.charCode||b.keyCode,f=String.fromCharCode(e);f===d&&c.getInputEnabled()&&c.applyToActivated(function(b){a.addScene(b)})};return b.addEventListener("inputEnabled",function(a){a?e.on("keypress",f):e.off("keypress",f)}),e},jQuery.fn.storyboardMenuWidget=function(a,b,c){"use strict";var d=this,e=function(a){a?d.show():d.hide()};return d.find("[data-mm-role=storyboard-add-scene]").click(function(){c.applyToActivated(function(b){a.addScene(b)})}),d.find("[data-mm-role=storyboard-add-scene-children]").click(function(){c.applyToActivated(function(b){a.addScene(b,!1,"with-children")})}),d.find("[data-mm-role=storyboard-remove-scenes-for-idea-id]").click(function(){a.removeScenesForIdeaId(c.getSelectedNodeId())}),b.addEventListener("inputEnabled",e),e(b.getInputEnabled()),d},MM.exportIdeas=function(a,b){"use strict";var c=function(a,b,d){d=d||0,a(b,d),_.each(b.sortedSubIdeas(),function(b){c(a,b,d+1)})};return b.begin&&b.begin(),c(b.each,a),b.end&&b.end(),b.contents()},MM.TabSeparatedTextExporter=function(){"use strict";var a=[];this.contents=function(){return a.join("\n")},this.each=function(b,c){a.push(_.map(_.range(c),function(){return"	"}).join("")+b.title.replace(/\t|\n|\r/g," "))}},MM.HtmlTableExporter=function(){"use strict";var a;this.begin=function(){a=$("<table>").wrap("<div></div>")},this.contents=function(){return'<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"> </head><body>'+$(a).parent().html()+"</body></html>"},this.each=function(b,c){var d=$("<tr>").appendTo(a),e=$("<td>").appendTo(d).text(b.title);b.attr&&b.attr.style&&b.attr.style.background&&(e.css("background-color",b.attr.style.background),e.css("color",MAPJS.contrastForeground(b.attr.style.background))),c>0&&$("<td>").prependTo(d).html("&nbsp;").attr("colspan",c)}},MM.exportToHtmlDocument=function(a){"use strict";var b=jQuery.Deferred(),c=function(){var c=$("<div>"),d=function(a,b){MAPJS.URLHelper.containsLink(b)?$("<a>").attr("href",MAPJS.URLHelper.getLink(b)).text(MAPJS.URLHelper.stripLink(b)||b).appendTo(a):a.text(b)},e=function(a,b){var c=b&&b.attr&&b.attr.attachment;c&&"text/html"===c.contentType&&$("<div>").addClass("attachment").appendTo(a).html(c.content)},f=function(a){var b=$("<ul>");return _.each(a,function(a){var c=$("<li>").appendTo(b);d(c,a.title),e(c,a),a.attr&&a.attr.style&&a.attr.style.background&&(c.css("background-color",a.attr.style.background),c.css("color",MAPJS.contrastForeground(a.attr.style.background))),_.isEmpty(a.ideas)||f(a.sortedSubIdeas()).appendTo(c)}),b},g=$("<h1>").appendTo(c);d(g,a.title),e(c,a),_.isEmpty(a.ideas)||f(a.sortedSubIdeas()).appendTo(c),b.resolve('<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><style type="text/css">body{font-family:"HelveticaNeue",Helvetica,Arial,sans-serif;font-size:14px;line-height:20px;color:#333333;margin-left:10%;margin-right:10%;}h1{display:block;font-size:38.5px;line-height:40px;font-family:inherit;}li{line-height:20px;padding-left:10px;}ul{list-style-type:none;}div.attachment{border:1px solid black;margin:5px;padding:5px;}img.mapimage{border:1px solid black;max-height:600px;max-width:600px;}</style></head><body>'+$(c).html()+"</body></html>","text/html")};return c(),b.promise()},MM.exportTableToText=function(a){"use strict";return _.map(a,function(a){return _.map(a,function(a){return a?a.toString().replace(/\t|\n|\r/g," "):""}).join("	")}).join("\n")},jQuery.fn.titleUpdateWidget=function(a){"use strict";var b=this;a.addEventListener("mapLoaded mapSaved",function(a,c){b.prop("title")&&b.prop("title",c.title)})},$.fn.toggleClassWidget=function(){"use strict";var a=this;return a.filter("[data-mm-key]").each(function(){var a=$(this);$(window).keydown(a.data("mm-key"),function(b){a.click(),b.preventDefault()})}),a.click(function(){var a=$($(this).data("mm-target")),b=$(this).data("mm-class");a.toggleClass(b)}),a},jQuery.fn.welcomeMessageWidget=function(a){"use strict";return this.each(function(){a.log("Welcome Message","show",jQuery(this).data("message"))})},MM.main=function(a){"use strict";var b=function(){try{if(window.localStorage.setItem("testkey","testval"),"testval"===window.localStorage.getItem("testkey"))return window.localStorage}catch(a){}return{fake:!0,getItem:function(a){return this[a]},setItem:function(a,b){this[a]=b},removeItem:function(a){delete this[a]}}},c=a.storage||b(),d=!1,e=function(a,b){a.addEventListener("log",function(){_gaq.push(["_trackEvent"].concat(Array.prototype.slice.call(arguments,0,3)))}),a.addEventListener("timer",function(a,b,c){_gaq.push(["_trackEvent",a,b,"",c])}),d&&b.addEventListener("analytic",a.log)};window._gaq=window._gaq||[],window._gaq=[["_setAccount",a.googleAnalyticsAccount],["_setCustomVar",1,"User Cohort",a.userCohort,1],["_setCustomVar",2,"Active Extensions",c["active-extensions"],1],["_trackPageview"]].concat(window._gaq),jQuery(function(){var b,d=new MM.ActivityLog(1e4),f=new MM.S3Api,g=new MM.Alert,h=jQuery("#modalConfirm").modalConfirmWidget(),i=new MM.JsonStorage(c),j=new MM.LocalStorageClipboard(i,"clipboard",g),k=new MM.S3ConfigGenerator(a.s3Url,a.publishingConfigUrl,a.s3Folder),l=new MM.GoldLicenseManager(i,"licenseKey"),m=new MM.GoldApi(l,a.goldApiUrl,d,a.goldBucketName),n=new MM.GoldStorage(m,f,h),o=new MM.S3FileSystem(k,"a","S3_CORS"),p=new MM.GoogleDriveAdapter(a.googleAppId,a.googleClientId,a.googleApiKey,a.networkTimeoutMillis,"application/json"),q="internal",r=new MM.ResourceCompressor(q),s=new MM.MapController([new MM.RetriableMapSourceDecorator(new MM.FileSystemMapSource(o,r.compress)),new MM.RetriableMapSourceDecorator(new MM.FileSystemMapSource(n.fileSystemFor("b"),r.compress)),new MM.RetriableMapSourceDecorator(new MM.FileSystemMapSource(n.fileSystemFor("p"),r.compress)),new MM.RetriableMapSourceDecorator(new MM.FileSystemMapSource(p,r.compress)),new MM.EmbeddedMapSource(a.newMapProperties)]),t=new MM.ActiveContentListener(s),u=new MM.ActiveContentResourceManager(t,q),v=MM.navigation(c,s),w=new MAPJS.MapModel(MAPJS.DOMRender.layoutCalculator,["Press Space or double-click to edit"],j),x=new MM.StoryboardModel(t,"storyboards","storyboard-scenes"),y=new MM.StoryboardDimensionProvider(u),z=MM.buildDecoratedResultProcessor(MM.ajaxResultProcessor,MM.layoutExportDecorators),A=new MM.LayoutExportController({png:MM.buildMapLayoutExporter(w,u.getResource),pdf:MM.buildMapLayoutExporter(w,u.getResource),"presentation.pdf":MM.buildStoryboardExporter(x,y,u.getResource),"presentation.pptx":MM.buildStoryboardExporter(x,y,u.getResource),"publish.json":{exporter:t.getActiveContent,processor:z}},m,f,d),B=new MM.iconEditor(w,u),C=new MM.Bookmark(s,i,"created-maps"),D=new MM.AutoSave(s,i,g,w),E=new MAPJS.ImageInsertController(a.corsProxyUrl,u.storeResource),F=new MM.MeasuresModel("measurements-config","measurements",t,new MM.MeasuresModel.ActivatedNodesFilter(w)),G=new MM.SplittableController(jQuery("body"),w,c,"splittableController","measuresSheet"),H=new MM.CustomStyleController(t,w),I=new MM.StoryboardController(x),J=new MM.CollaborationModel(w),K=new MM.Extensions(c,"active-extensions",a,{googleDriveAdapter:p,alert:g,mapController:s,activityLog:d,mapModel:w,container:jQuery("#container"),iconEditor:B,measuresModel:F,activeContentListener:t,navigation:v,collaborationModel:J,modalConfirm:h}),L=function(){var e=jQuery("body").hasClass("ios")||jQuery("body").hasClass("android");e?jQuery("[data-mm-role-touch]").attr("data-mm-role",function(){return jQuery(this).attr("data-mm-role-touch")}):jQuery("[rel=tooltip]").tooltip(),MAPJS.DOMRender.stageVisibilityMargin={top:50,left:10,bottom:20,right:20},MAPJS.DOMRender.stageMargin={top:50,left:50,bottom:50,right:50},jQuery("[data-mm-layout][data-mm-layout!="+a.layout+"]").remove(),jQuery("body").mapStatusWidget(s,t),jQuery("#container").domMapWidget(d,w,e,E,jQuery("#splittable"),u.getResource).storyboardKeyHandlerWidget(I,x,w,"+"),jQuery("#welcome_message[data-message]").welcomeMessageWidget(d),jQuery("#topbar").mapToolbarWidget(w),b=jQuery.fn.colorPicker.showPalette,jQuery.fn.colorPicker.showPalette=function(a){b(a),a.hasClass("topbar-color-picker")&&a.css("top",jQuery("#topbar").outerHeight())},jQuery("#toolbarEdit").mapToolbarWidget(w),jQuery("#floating-toolbar").floatingToolbarWidget(),jQuery("#floating-collaborators").floatingToolbarWidget(),jQuery("#listBookmarks").bookmarkWidget(C,g,s),jQuery(document).titleUpdateWidget(s),jQuery("[data-mm-role=share-google]").googleShareWidget(s,p),jQuery("#modalImport").importWidget(d,s),jQuery("[data-mm-role=save]").saveWidget(s),jQuery('[data-mm-role="toggle-class"]').toggleClassWidget(),jQuery('[data-mm-role="remote-export"]').remoteExportWidget(s,g,F,m,f,h),jQuery("[data-mm-role~=layout-export]").layoutExportWidget(A),jQuery("[data-mm-role~=atlas-publish]").atlasPrepopulationWidget(t,40,150),jQuery("[data-mm-role~=google-drive-open]").googleDriveOpenWidget(p,s,h,d),jQuery("#modalGoldStorageOpen").goldStorageOpenWidget(n,s),jQuery("body").commandLineWidget("Shift+Space Ctrl+Space",w).searchWidget("Meta+F Ctrl+F",w),jQuery("#modalAttachmentEditor").attachmentEditorWidget(w,e),jQuery("#modalAutoSave").autoSaveWidget(D),jQuery("#linkEditWidget").linkEditWidget(w),jQuery("#modalExtensions").extensionsWidget(K,s,g),jQuery("#nodeContextMenu").contextMenuWidget(w).mapToolbarWidget(w),jQuery(".dropdown-submenu>a").click(function(){return!1}),jQuery("[data-category]").trackingWidget(d),jQuery("#modalKeyActions").keyActionsWidget(),jQuery("#topbar .updateStyle").attr("data-mm-align","top").colorPicker(),jQuery(".colorPicker-palette").addClass("topbar-color-picker"),jQuery(".updateStyle[data-mm-align!=top]").colorPicker(),jQuery(".colorPicker-picker").parent("a,button").click(function(a){a.target===this&&jQuery(this).find(".colorPicker-picker").click()}),jQuery("#modalGoldLicense").goldLicenseEntryWidget(l,m,d),jQuery("#modalIconEdit").iconEditorWidget(B,a.corsProxyUrl),jQuery("#measuresSheet").measuresSheetWidget(F),jQuery("[data-mm-role=measures-display-control]").measuresDisplayControlWidget(F,w),jQuery(".modal.huge").scalableModalWidget(),jQuery("[data-mm-role=new-from-clipboard]").newFromClipboardWidget(j,s),MM.setImageAlertWidget(E,g),jQuery("#anon-alert-template").anonSaveAlertWidget(g,s,o,c,"anon-alert-disabled"),jQuery("body").splitFlipWidget(G,"[data-mm-role=split-flip]",w,"Alt+o"),jQuery("#storyboard").storyboardWidget(I,x,y,w),jQuery("[data-mm-role=storyboard-menu]").storyboardMenuWidget(I,x,w),jQuery("[data-mm-role=optional-content]").optionalContentWidget(w,G),jQuery("#customStyleModal").customStyleWidget(H),jQuery("[data-mm-role~=new-map]").newMapWidget(s),jQuery("#container").collaboratorPhotoWidget(J,MM.deferredImageLoader,"mm-collaborator"),jQuery("#floating-collaborators").collaboratorListWidget(J,"mm-has-collaborators"),jQuery(".modal").modalLauncherWidget(w),jQuery("input[data-mm-role~=selectable-read-only]").selectableReadOnlyInputWidget(),jQuery("textarea[data-mm-role~=selectable-read-only]").selectableReadOnlyInputWidget(),jQuery("#collaboratorSpeechBubble").collaboratorSpeechBubbleWidget(J)};a.activeContentConfiguration={nonClonedAttributes:["storyboards","storyboard-scenes","measurements-config"]},jQuery.fn.colorPicker.defaults.colors=["000000","993300","333300","000080","333399","333333","800000","FF6600","808000","008000","008080","0000FF","666699","808080","FF0000","FF9900","99CC00","339966","33CCCC","3366FF","800080","999999","FF00FF","FFCC00","FFFF00","00FF00","00FFFF","00CCFF","993366","C0C0C0","FF99CC","FFCC99","FFFF99","CCFFFF","FFFFFF","transparent"],jQuery.fn.colorPicker.defaults.pickerDefault="transparent",jQuery.support.cors=!0,e(d,w),jQuery("body").classCachingWidget("cached-classes",c),MM.MapController.activityTracking(s,d),MM.MapController.alerts(s,g,h),MM.measuresModelMediator(w,F),s.addEventListener("mapLoaded",function(b,c){c.setConfiguration(a.activeContentConfiguration),w.setIdea(c)}),c.fake&&(g.show("Browser storage unavailable!","You might be running the app in private mode or have no browser storage - some features of this application will not work fully.","warning"),d.log("Warning","Local storage not available")),jQuery("#topbar").alertWidget(g),window.mmtimestamp&&window.mmtimestamp.log("mm initialized"),_.each(jQuery("a"),function(a){/^mailto:/.test(a.href)&&(a.target="mailtoIframe")
}),K.load(v.initialMapId()).then(function(){window.mmtimestamp&&window.mmtimestamp.log("extensions loaded"),jQuery("[data-mm-clone]").each(function(){var a=jQuery(this),b=jQuery(a.data("mm-clone"));b.children().clone(!0).appendTo(a),a.attr("data-mm-role",b.attr("data-mm-role"))}),L(),window.mmtimestamp&&window.mmtimestamp.log("ui loaded"),v.loadInitial()||jQuery("#logo-img").click()})})};
//# sourceMappingURL=mm-compiled.min.map